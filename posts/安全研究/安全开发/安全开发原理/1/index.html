<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>代理开发学习 - 东隅 Blog</title><meta name="author" content="东隅">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='安全开发, 安全开发原理' />
  <meta itemprop="name" content="代理开发学习">
  <meta itemprop="datePublished" content="2024-08-15T12:31:01+08:00">
  <meta itemprop="dateModified" content="2024-08-15T12:31:01+08:00">
  <meta itemprop="wordCount" content="1605">
  <meta itemprop="keywords" content="安全开发,安全开发原理"><meta property="og:url" content="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86/1/">
  <meta property="og:site_name" content="东隅 Blog">
  <meta property="og:title" content="代理开发学习">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-15T12:31:01+08:00">
    <meta property="article:modified_time" content="2024-08-15T12:31:01+08:00">
    <meta property="article:tag" content="安全开发">
    <meta property="article:tag" content="安全开发原理">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="代理开发学习">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86/1/" /><link rel="prev" href="https://dongyu29.github.io/posts/%E6%94%BB%E9%98%B2/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/65/" /><link rel="next" href="https://dongyu29.github.io/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/69/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "代理开发学习",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86\/1\/"
    },"image": ["https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"],"genre": "posts","keywords": "安全开发, 安全开发原理","wordcount":  1605 ,
    "url": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86\/1\/","datePublished": "2024-08-15T12:31:01+08:00","dateModified": "2024-08-15T12:31:01+08:00","publisher": {
      "@type": "Organization",
      "name": "","logo": "https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"},"author": {
        "@type": "Person",
        "name": "东隅"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="东隅 Blog">Home</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">Posts</a></li><li class="breadcrumb-item active" aria-current="page">代理开发学习</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid x" aria-hidden="true"></i></span><span>代理开发学习</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅" data-title="东隅" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;东隅</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" class="post-category" title="Category - 安全开发"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 安全开发</a></span></div><div class="post-meta-line"><span title="published on 2024-08-15 12:31:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-08-15">2024-08-15</time></span>&nbsp;<span title="1605 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 1700 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>8 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#握手阶段">握手阶段</a>
      <ul>
        <li><a href="#协商阶段">协商阶段</a></li>
        <li><a href="#认证阶段也叫子协商">认证阶段(也叫子协商)</a></li>
      </ul>
    </li>
    <li><a href="#请求阶段">请求阶段</a>
      <ul>
        <li><a href="#浏览器-代理-2">浏览器-&gt;代理</a></li>
        <li><a href="#代理-浏览器-2">代理-&gt;浏览器</a></li>
      </ul>
    </li>
    <li><a href="#relay阶段">Relay阶段</a></li>
  </ul>

  <ul>
    <li><a href="#基础">基础</a></li>
    <li><a href="#协程通信">协程通信</a>
      <ul>
        <li><a href="#通信操作符--">通信操作符 &lt;-</a></li>
        <li><a href="#通道阻塞">通道阻塞</a></li>
        <li><a href="#带缓冲的通道">带缓冲的通道</a></li>
        <li><a href="#信号量模式">信号量模式</a></li>
      </ul>
    </li>
    <li><a href="#协程同步">协程同步</a></li>
    <li><a href="#使用-select-切换协程">使用 select 切换协程</a></li>
  </ul>

  <ul>
    <li><a href="#轮廓">轮廓</a></li>
    <li><a href="#auth-握手阶段-协商阶段">AUth 握手阶段-协商阶段</a></li>
    <li><a href="#connect-请求阶段">Connect 请求阶段</a></li>
    <li><a href="#forward">Forward</a></li>
  </ul>

  <ul>
    <li><a href="#agent">agent</a></li>
    <li><a href="#server">server</a></li>
  </ul>

  <ul>
    <li><a href="#攻防">攻防</a></li>
    <li><a href="#实现">实现</a></li>
  </ul>

  <ul>
    <li><a href="#poolgo">pool.go</a></li>
    <li><a href="#dialergo">dialer.go</a></li>
    <li><a href="#get_proxygp">get_proxy.gp</a></li>
    <li><a href="#qgnet_testgo">qgnet_test.go</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="-----（完）-----"><h1 id="socks5" class="heading-element"><span>socks5</span>
  <a href="#socks5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>socks5位于应用层和传输层之间的会话层，是一种代理协议，Socks5代理协议广泛应用于各种基于TCP/IP的应用层协议。由于几乎所有基于TCP/IP的应用软件都使用socket进行数据通信</p>
<p>socks协议历史悠久，它面世时中国的互联网尚未成型，它是明文传输的，因此它并不是为翻墙而设计的协议。互联网早期，企业内部网络为了保证安全性，都是置于防火墙之后，这样带来的副作用就是访问内部资源会变得很麻烦，socks协议就是为了解决这个问题而诞生的。</p>
<p>scoks5是scoks4的升级版，它并不兼容socks4协议。在socks4的基础上新增<strong>UDP转发</strong>和<strong>认证功能</strong>。</p>
<p>特点：</p>
<p><strong>(1)支持IPv4和IPv6</strong>：SOCKS5协议可以同时支持IPv4和IPv6地址，适应不同网络环境的需求。</p>
<p>**(2)用户验证：**SOCKS5支持多种用户验证方式，如用户名/密码认证、GSS-API认证等，增加了连接的安全性。</p>
<p><strong>(3)数据加密</strong>：SOCKS5协议可以通过TLS/SSL等加密协议对数据进行加密，保护数据的安全性。</p>
<p><strong>(4)UDP转发</strong>：相比于SOCKS4协议，SOCKS5协议支持UDP转发，可以在代理连接中传输UDP数据。</p>
<h1 id="工作过程" class="heading-element"><span>工作过程</span>
  <a href="#%e5%b7%a5%e4%bd%9c%e8%bf%87%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>浏览器采用socks代理：</p>
<ol>
<li>
<p>浏览器和socks5代理建立TCP连接</p>
<p>和上面不同的时，浏览器和服务器之间多了一个中间人，即socks5，因此浏览器需要跟socks5服务器建立一条连接。</p>
</li>
<li>
<p>socks5==协商阶段==</p>
<p>在浏览器正式向socks5服务器发起请求之前，双方需要协商，包括协议版本，支持的认证方式等，双方需要协商成功才能进行下一步。协商的细节将会在下一小节详细描述。</p>
</li>
<li>
<p>socks5请求阶段</p>
<p>协商成功后，浏览器向socks5代理发起一个请求。请求的内容包括，它要访问的服务器域名或ip，端口等信息。</p>
</li>
<li>
<p>socks5 relay阶段</p>
<p>scoks5收到浏览器请求后，解析请求内容，然后向目标服务器建立TCP连接。</p>
</li>
<li>
<p>数据传输阶段</p>
<p>经过上面步骤，我们成功建立了浏览器 –&gt; socks5，socks5–&gt;目标服务器之间的连接。这个阶段浏览器开始把数据传输给scoks5代理，socks5代理把数据转发到目标服务器。</p>
</li>
</ol>
<p>同样的，进行代理开发的时候也要写出协商过程</p>
<p>细节：</p>
<p>我们可以把它的的过程总结为3个阶段，分别为:==握手阶段、请求阶段，Relay阶段==。</p>
<h2 id="握手阶段" class="heading-element"><span>握手阶段</span>
  <a href="#%e6%8f%a1%e6%89%8b%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>握手阶段包含协商和子协商阶段，我们把它拆分为两个分别讨论</p>
<h3 id="协商阶段" class="heading-element"><span>协商阶段</span>
  <a href="#%e5%8d%8f%e5%95%86%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="浏览器-代理" class="heading-element"><span>浏览器-&gt;代理</span>
  <a href="#%e6%b5%8f%e8%a7%88%e5%99%a8-%e4%bb%a3%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>在这个阶段，客户端向socks5发起请求，内容如下:</p>
<pre tabindex="0"><code>+----+----------+----------+
|VER | NMETHODS | METHODS  |
+----+----------+----------+
| 1  |    1     | 1 to 255 |
+----+----------+----------+

#上方的数字表示字节数，下面的表格同理，不再赘述</code></pre><ol>
<li>VER: 协议版本，socks5为<code>0x05</code></li>
<li>NMETHODS: 支持认证的方法数量</li>
<li>METHODS: 对应NMETHODS，==NMETHODS的值为多少，METHODS就有多少个字节==。RFC预定义了一些值的含义，这里就是说通过什么方法进行认证，内容如下:</li>
</ol>
<ul>
<li>X’00’ NO AUTHENTICATION REQUIRED</li>
<li>X’01’ GSSAPI</li>
<li>X’02’ USERNAME/PASSWORD</li>
<li>X’03’ to X’7F’ IANA ASSIGNED</li>
<li>X’80’ to X’FE’ RESERVED FOR PRIVATE METHODS</li>
<li>X’FF’ NO ACCEPTABLE METHODS</li>
</ul>
<p>如图，05020001： 05-&gt;socks5   02-&gt;浏览器我支持两种认证方式   0001-&gt;拆开成00和01，即支持不认证和GSSAPI认证</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061119865.webp" alt="image-20240606111910744" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061119865.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061119865.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061119865.webp?size=large 2x" data-title="image-20240606111910744" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="代理-浏览器" class="heading-element"><span>代理-&gt;浏览器</span>
  <a href="#%e4%bb%a3%e7%90%86-%e6%b5%8f%e8%a7%88%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>socks5服务器需要选中一个METHOD返回给浏览器，格式如下:</p>
<p>就是说浏览器告诉socks代理我给出这些认证方式你来选一个你支持的</p>
<pre tabindex="0"><code>+----+--------+
|VER | METHOD |
+----+--------+
| 1  |   1    |
+----+--------+</code></pre><p>当浏览器收到<code>0x00</code>（NO AUTHENTICATION REQUIRED）时，会跳过认证阶段直接进入请求阶段; 当收到<code>0xFF</code>时，直接断开连接。其他的值进入到对应的认证阶段。</p>
<p>如图，0502： 05-&gt;socks5   02-&gt;socks我选择了 USERNAME/PASSWORD认证方式，来开始认证吧</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061121656.webp" alt="image-20240606112108549" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061121656.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061121656.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061121656.webp?size=large 2x" data-title="image-20240606112108549" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="认证阶段也叫子协商" class="heading-element"><span>认证阶段(也叫子协商)</span>
  <a href="#%e8%ae%a4%e8%af%81%e9%98%b6%e6%ae%b5%e4%b9%9f%e5%8f%ab%e5%ad%90%e5%8d%8f%e5%95%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>认证阶段作为协商的一个子流程，它<strong>不是必须</strong>的。socks5服务器可以决定是否需要认证，如果不需要认证，那么认证阶段会被直接略过。</p>
<h4 id="浏览器-代理-1" class="heading-element"><span>浏览器-&gt;代理</span>
  <a href="#%e6%b5%8f%e8%a7%88%e5%99%a8-%e4%bb%a3%e7%90%86-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>如果需要认证，浏览器向socks5服务器发起一个认证请求，这里以<code>0x02</code>（USERNAME/PASSWORD）的认证方式举例:</p>
<pre tabindex="0"><code>+----+------+----------+------+----------+
|VER | ULEN |  UNAME   | PLEN |  PASSWD  |
+----+------+----------+------+----------+
| 1  |  1   | 1 to 255 |  1   | 1 to 255 |
+----+------+----------+------+----------+</code></pre><p>VER: 版本，通常为<code>0x01</code></p>
<p>ULEN: 用户名长度</p>
<p>UNAME: 对应用户名的字节数据</p>
<p>PLEN: 密码长度</p>
<p>PASSWD: 密码对应的数据</p>
<p>如图，这里是16进制数据，不一一解释了</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061125515.webp" alt="image-20240606112511411" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061125515.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061125515.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061125515.webp?size=large 2x" data-title="image-20240606112511411" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="代理-浏览器-1" class="heading-element"><span>代理-&gt;浏览器</span>
  <a href="#%e4%bb%a3%e7%90%86-%e6%b5%8f%e8%a7%88%e5%99%a8-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>socks5服务器收到浏览器的认证请求后，解析内容，验证信息是否合法，然后给客户端响应结果。响应格式如下:</p>
<p>这一步就很简单了，要不就1要不就0</p>
<pre tabindex="0"><code>+----+--------+
|VER | STATUS |
+----+--------+
| 1  |   1    |
+----+--------+</code></pre><p>STATUS字段如果为<code>0x00</code>表示认证成功，其他的值为认证失败。当客户端收到认证失败的响应后，它将会断开连接。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061128246.webp" alt="image-20240606112807146" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061128246.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061128246.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061128246.webp?size=large 2x" data-title="image-20240606112807146" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="请求阶段" class="heading-element"><span>请求阶段</span>
  <a href="#%e8%af%b7%e6%b1%82%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="浏览器-代理-2" class="heading-element"><span>浏览器-&gt;代理</span>
  <a href="#%e6%b5%8f%e8%a7%88%e5%99%a8-%e4%bb%a3%e7%90%86-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>顺利通过协商阶段后，浏览器端向socks5服务器发起请求细节，格式如下:</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+</code></pre><ul>
<li>VER 版本号，socks5的值为<code>0x05</code></li>
<li>CMD
<ul>
<li><code>0x01</code>表示CONNECT请求</li>
<li><code>0x02</code>表示BIND请求</li>
<li><code>0x03</code>表示UDP转发</li>
</ul>
</li>
<li>RSV 保留字段，值为<code>0x00</code></li>
<li>ATYP 目标地址类型，DST.ADDR的数据对应这个字段的类型。
<ul>
<li><code>0x01</code>表示IPv4地址，DST.ADDR为4个字节</li>
<li><code>0x03</code>表示域名，DST.ADDR是一个可变长度的域名</li>
<li><code>0x04</code>表示IPv6地址，DST.ADDR为16个字节长度</li>
</ul>
</li>
<li>DST.ADDR 一个可变长度的值</li>
<li>DST.PORT 目标端口，固定2个字节</li>
</ul>
<p>上面的值中，DST.ADDR是一个变长的数据，它的数据长度根据ATYP的类型决定。~~我们可以通过掐头去尾解析出这部分数据。~~分为下面3种情况:</p>
<ul>
<li>
<p>X’01’</p>
<p>一个4字节的ipv4地址</p>
</li>
<li>
<p>X’03’</p>
<p>一个可变长度的域名，这种情况下<code>DST.ADDR</code>的第一个字节表示域名长度，剩下部分是域名内容。</p>
</li>
<li>
<p>X’04’</p>
<p>一个16字节的ipv6地址</p>
<p>如图</p>
</li>
</ul>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061133013.webp" alt="image-20240606113343906" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061133013.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061133013.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061133013.webp?size=large 2x" data-title="image-20240606113343906" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="代理-浏览器-2" class="heading-element"><span>代理-&gt;浏览器</span>
  <a href="#%e4%bb%a3%e7%90%86-%e6%b5%8f%e8%a7%88%e5%99%a8-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>socks5服务器收到浏览器端的请求后，需要返回一个响应，结构如下</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+</code></pre><ul>
<li>VER socks版本，这里为<code>0x05</code></li>
<li>REP Relay field,内容取值如下
<ul>
<li>X’00’ succeeded</li>
<li>X’01’ general SOCKS server failure</li>
<li>X’02’ connection not allowed by ruleset</li>
<li>X’03’ Network unreachable</li>
<li>X’04’ Host unreachable</li>
<li>X’05’ Connection refused</li>
<li>X’06’ TTL expired</li>
<li>X’07’ Command not supported</li>
<li>X’08’ Address type not supported</li>
<li>X’09’ to X’FF’ unassigned</li>
</ul>
</li>
<li>RSV 保留字段</li>
<li>ATYPE 同请求的ATYPE</li>
<li>BND.ADDR 服务绑定的地址</li>
<li>BND.PORT 服务绑定的端口DST.PORT</li>
</ul>
<p>针对响应的结构中，<code>BND.ADDR</code>和<code>BND.PORT</code>值得特别关注一下，可能有朋友在这里会产生困惑，返回的地址和端口是用来做什么的呢？</p>
<p>代理服务器既充当socks服务器，又充当relay服务器。实际上这两个是可以被拆开的，当我们的socks5 server和relay server不是一体的，就需要告知客户端==relay server的地址==，这个地址就是BND.ADDR和BND.PORT。</p>
<p>当我们的relay server和socks5 server是同一台服务器时，<code>BND.ADDR</code>和<code>BND.PORT</code>的值全部为0即可。</p>
<h2 id="relay阶段" class="heading-element"><span>Relay阶段</span>
  <a href="#relay%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>socks5服务器收到请求后，解析内容。如果是UDP请求，服务器直接转发; 如果是TCP请求，服务器向目标服务器建立TCP连接，后续负责把客户端的所有数据转发到目标服务。</p>
<h1 id="golang并发" class="heading-element"><span>golang并发</span>
  <a href="#golang%e5%b9%b6%e5%8f%91" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h2 id="基础" class="heading-element"><span>基础</span>
  <a href="#%e5%9f%ba%e7%a1%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在 Go 中，应用程序并发处理的部分被称作 goroutines（协程），它可以进行更有效的并发运算。在协程和操作系统线程之间并无一对一的关系：协程是根据一个或多个线程的可用性，映射（多路复用，执行于）在他们之上的；协程调度器在 Go 运行时很好的完成了这个工作。</p>
<p>Go 使用 <code>channels</code> 来同步协程</p>
<p>协程是通过使用关键字 <code>go</code> 调用（或执行）一个函数或者方法来实现的（也可以是匿名或者 lambda 函数）。</p>
<p>用命令行指定使用的核心数量</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">numCores</span> = <span style="color:#58a1dd">flag</span>.<span style="color:#58a1dd">Int</span>(<span style="color:#a6be9d">&#34;n&#34;</span>, <span style="color:#a6be9d">2</span>, <span style="color:#a6be9d">&#34;number of CPU cores to use&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">in</span> <span style="color:#58a1dd">main</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">flag</span>.<span style="color:#58a1dd">Parse</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">runtime</span>.<span style="color:#58a1dd">GOMAXPROCS</span>(<span style="color:#ff636f">*</span><span style="color:#58a1dd">numCores</span>)</span></span></code></pre></div><p>示例</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;In main()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">go</span> <span style="color:#58a1dd">longWait</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">go</span> <span style="color:#58a1dd">shortWait</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;About to sleep in main()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// sleep works with a Duration in nanoseconds (ns) !
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#a6be9d">10</span> <span style="color:#ff636f">*</span> <span style="color:#a6be9d">1e9</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;At the end of main()&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">longWait</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;Beginning longWait()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#a6be9d">5</span> <span style="color:#ff636f">*</span> <span style="color:#a6be9d">1e9</span>) <span style="color:#828b96;font-style:italic">// sleep for 5 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;End of longWait()&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">shortWait</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;Beginning shortWait()&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#a6be9d">2</span> <span style="color:#ff636f">*</span> <span style="color:#a6be9d">1e9</span>) <span style="color:#828b96;font-style:italic">// sleep for 2 seconds
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;End of shortWait()&#34;</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>输出</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">In</span> <span style="color:#58a1dd">main</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">About</span> <span style="color:#58a1dd">to</span> <span style="color:#58a1dd">sleep</span> <span style="color:#58a1dd">in</span> <span style="color:#58a1dd">main</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Beginning</span> <span style="color:#58a1dd">longWait</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Beginning</span> <span style="color:#58a1dd">shortWait</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">End</span> <span style="color:#58a1dd">of</span> <span style="color:#58a1dd">shortWait</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">End</span> <span style="color:#58a1dd">of</span> <span style="color:#58a1dd">longWait</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">At</span> <span style="color:#58a1dd">the</span> <span style="color:#58a1dd">end</span> <span style="color:#58a1dd">of</span> <span style="color:#58a1dd">main</span>() <span style="color:#828b96;font-style:italic">// after 10s
</span></span></span></code></pre></div><p>我们让 main() 函数暂停 10 秒从而确定它会在另外两个协程之后结束。如果不这样（如果我们让 main() 函数停止 4 秒），main() 会提前结束，longWait() 则无法完成。如果我们不在 main() 中等待，协程会随着程序的结束而消亡。</p>
<p>当 main() 函数返回的时候，程序退出：它不会等待任何其他非 main 协程的结束。这就是为什么在服务器程序中，每一个请求都会启动一个协程来处理，server() 函数必须保持运行状态。通常使用一个无限循环来达到这样的目的。</p>
<p>另外，协程是独立的处理单元，一旦陆续启动一些协程，你无法确定他们是什么时候真正开始执行的。你的代码逻辑必须独立于协程调用的顺序。</p>
<h2 id="协程通信" class="heading-element"><span>协程通信</span>
  <a href="#%e5%8d%8f%e7%a8%8b%e9%80%9a%e4%bf%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Go 有一个特殊的类型，<code>通道（channel）</code>，==数据通过通道：同一时间只有一个协程可以访问数据：所以不会出现数据竞争==</p>
<p>所有的类型都可以用于通道，空接口 <code>interface{}</code> 也可以。甚至可以（有时非常有用）创建通道的通道。</p>
<p>它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</p>
<p>通道也是引用类型，所以我们使用 <code>make()</code> 函数来给它分配内存。这里先声明了一个字符串通道 ch1，然后创建了它（实例化）：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">ch1</span> <span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ch1</span> = <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>)</span></span></code></pre></div><p>当然可以更短： ch1 := make(chan string)。</p>
<p>这里我们构建一个 int 通道的通道： chanOfChans := make(chan int)。</p>
<p>或者函数通道：funcChan := chan func()</p>
<h3 id="通信操作符--" class="heading-element"><span>通信操作符 &lt;-</span>
  <a href="#%e9%80%9a%e4%bf%a1%e6%93%8d%e4%bd%9c%e7%ac%a6--" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这个操作符直观的标示了数据的传输：信息按照箭头的方向流动。</p>
<p>流向通道（发送）</p>
<ul>
<li><code>ch &lt;- int1</code> 表示：用通道 ch 发送变量 int1（双目运算符，中缀 = 发送）</li>
</ul>
<p>从通道流出（接收），三种方式：</p>
<ul>
<li>
<p><code>int2 = &lt;- ch</code> 表示：变量 int2 从通道 ch（一元运算的前缀操作符，前缀 = 接收）接收数据（获取新值）；假设 int2 已经声明过了，如果没有的话可以写成：int2 := &lt;- ch。</p>
</li>
<li>
<p><code>&lt;- ch</code> 可以单独调用获取通道的（下一个）值，当前值会被丢弃，但是可以用来验证，所以以下代码是合法的：</p>
</li>
</ul>
<p>操作符 &lt;- 也被用来发送和接收，Go 尽管不必要，为了可读性，通道的命名通常以 <code>ch</code> 开头或者包含 <code>chan</code>。通道的发送和接收操作都是自动的：它们通常一气呵成。</p>
<p>此外，golang程序中如果出现死锁，程序在编译阶段就会报错。</p>
<h3 id="通道阻塞" class="heading-element"><span>通道阻塞</span>
  <a href="#%e9%80%9a%e9%81%93%e9%98%bb%e5%a1%9e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>默认情况下，通信是同步且无缓冲的：在有接收者接收数据之前，发送不会结束。可以想象一个无缓冲的通道在没有空间来保存数据的时候：必须要一个接收者准备好接收通道的数据然后发送者可以直接把数据发送给接收者。所以通道的发送 / 接收操作在对方准备好之前是阻塞的：</p>
<p>1）对于同一个通道，发送操作（协程或者函数中的），在接收者准备好之前是阻塞的：如果 ch 中的数据无人接收，就无法再给通道传入其他数据：新的输入无法在通道非空的情况下传入。所以发送操作会等待 ch 再次变为可用状态：就是通道值被接收时（可以传入变量）。</p>
<p>2）对于同一个通道，接收操作是阻塞的（协程或函数中的），直到发送者可用：如果通道中没有数据，接收者就阻塞了。</p>
<h3 id="带缓冲的通道" class="heading-element"><span>带缓冲的通道</span>
  <a href="#%e5%b8%a6%e7%bc%93%e5%86%b2%e7%9a%84%e9%80%9a%e9%81%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>一个无缓冲通道只能包含 1 个元素，有时显得很局限。我们给通道提供了一个缓存，可以在扩展的 make 命令中设置它的容量，如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">buf</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">100</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ch1</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">buf</span>)</span></span></code></pre></div><p>buf 是通道可以同时容纳的元素（这里是 string）个数</p>
<p>在缓冲满载（缓冲被全部使用）之前，给一个带缓冲的通道发送数据是不会阻塞的，而从通道读取数据也不会阻塞，直到缓冲空了。</p>
<p>缓冲容量和类型无关，所以可以（尽管可能导致危险）给一些通道设置不同的容量，只要他们拥有同样的元素类型。内置的 cap 函数可以返回缓冲区的容量。</p>
<p>==如果容量大于 0，通道就是异步的了==：缓冲满载（发送）或变空（接收）之前通信不会阻塞，元素会按照发送的顺序被接收。如果容量是 0 或者未设置，通信仅在收发双方准备好的情况下才可以成功。</p>
<h3 id="信号量模式" class="heading-element"><span>信号量模式</span>
  <a href="#%e4%bf%a1%e5%8f%b7%e9%87%8f%e6%a8%a1%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>协程通过在通道 <code>ch</code> 中放置一个值来处理结束的信号。<code>main</code> 协程等待 <code>&lt;-ch</code> 直到从中获取到值。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">compute</span>(<span style="color:#58a1dd">ch</span> <span style="color:#ff636f">chan</span> <span style="color:#ff636f">int</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">ch</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">someComputation</span>() <span style="color:#828b96;font-style:italic">// when it completes, signal on the channel.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">ch</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">int</span>)     <span style="color:#828b96;font-style:italic">// allocate a channel.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">go</span> <span style="color:#58a1dd">compute</span>(<span style="color:#58a1dd">ch</span>)        <span style="color:#828b96;font-style:italic">// stat something in a goroutines
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">doSomethingElseForAWhile</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">result</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">ch</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h2 id="协程同步" class="heading-element"><span>协程同步</span>
  <a href="#%e5%8d%8f%e7%a8%8b%e5%90%8c%e6%ad%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>通道可以被显式的关闭；尽管它们和文件不同：不必每次都关闭。</p>
<p>只有在当需要告诉接收者不会再提供新的值的时候，才需要关闭通道。</p>
<p>==只有发送者需要关闭通道，接收者永远不会需要==。</p>
<p>我们如何在通道的 sendData() 完成的时候发送一个信号，getData() 又如何检测到通道是否关闭或阻塞？</p>
<p>第一个可以通过函数 close(ch) 来完成：这个将通道标记为无法通过发送操作 &lt;- 接受更多的值；给已经关闭的通道发送或者再次关闭都会导致运行时的 panic。在创建一个通道后使用 defer 语句是个不错的办法（类似这种情况）：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">ch</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">float64</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff636f">defer</span> <span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">ch</span>)</span></span></code></pre></div><p>第二个问题可以使用逗号，ok 操作符：用来检测通道是否被关闭。</p>
<p>如何来检测通道收到没有被阻塞（或者通道没有被关闭）？</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">v</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">ch</span>   <span style="color:#828b96;font-style:italic">// ok is true if v received value
</span></span></span></code></pre></div><p>通常和 if 语句一起使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">v</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">ch</span>; <span style="color:#58a1dd">ok</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">process</span>(<span style="color:#58a1dd">v</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>或者在 for 循环中接收的时候，当关闭或者阻塞的时候使用 break：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">v</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> !<span style="color:#58a1dd">ok</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">break</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">process</span>(<span style="color:#58a1dd">v</span>)</span></span></code></pre></div><h2 id="使用-select-切换协程" class="heading-element"><span>使用 select 切换协程</span>
  <a href="#%e4%bd%bf%e7%94%a8-select-%e5%88%87%e6%8d%a2%e5%8d%8f%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><code>select</code> 监听进入通道的数据，也可以是用通道发送值的时候。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">select</span> {
</span></span><span style="display:flex;"><span><span style="color:#ff636f">case</span> <span style="color:#58a1dd">u</span><span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">ch1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">case</span> <span style="color:#58a1dd">v</span><span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">ch2</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">default</span>: <span style="color:#828b96;font-style:italic">// no value ready to be received
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>        <span style="color:#ff636f">...</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>select 做的就是：选择处理列出的多个通信情况中的一个。</p>
<ul>
<li>
<p>如果都阻塞了，会等待直到其中一个可以处理</p>
</li>
<li>
<p>如果多个可以处理，随机选择一个</p>
</li>
<li>
<p>如果没有通道操作可以处理并且写了 default 语句，它就会执行：default 永远是可运行的（这就是准备好了，可以执行）。</p>
</li>
</ul>
<h1 id="golang网络编程" class="heading-element"><span>golang网络编程</span>
  <a href="#golang%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h1 id="实现简单正向代理" class="heading-element"><span>实现简单正向代理</span>
  <a href="#%e5%ae%9e%e7%8e%b0%e7%ae%80%e5%8d%95%e6%ad%a3%e5%90%91%e4%bb%a3%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p><a href="https://blog.csdn.net/m0_63230155/article/details/131621640"target="_blank" rel="external nofollow noopener noreferrer">https://blog.csdn.net/m0_63230155/article/details/131621640</a></p>
<p><a href="https://segmentfault.com/a/1190000038247560"target="_blank" rel="external nofollow noopener noreferrer">https://segmentfault.com/a/1190000038247560</a></p>
<h2 id="轮廓" class="heading-element"><span>轮廓</span>
  <a href="#%e8%bd%ae%e5%bb%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>用 Go 实现一个 TCP Server 实在是太简单了，什么 c10k problem、select、poll、epoll、kqueue、iocp、libevent，通通不需要（<del>但为了通过面试你还是得去看呀</del>），只需要这样两步：</p>
<ul>
<li>监听端口 1080（socks5的默认端口）</li>
<li>每收到一个请求，启动一个 goroutine 来处理它</li>
</ul>
<p>搭起这样一个架子，实现一个 Hello world，大约需要 30 行代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">server</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Listen</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#a6be9d">&#34;:1080&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Listen failed: %v\n&#34;</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">for</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">server</span>.<span style="color:#58a1dd">Accept</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Accept failed: %v&#34;</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">go</span> <span style="color:#58a1dd">process</span>(<span style="color:#58a1dd">client</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">process</span>(<span style="color:#58a1dd">client</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">remoteAddr</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">RemoteAddr</span>().<span style="color:#58a1dd">String</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Connection from %s\n&#34;</span>, <span style="color:#58a1dd">remoteAddr</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">Write</span>([]<span style="color:#58a1dd">byte</span>(<span style="color:#a6be9d">&#34;Hello world!\n&#34;</span>))
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611721.webp" alt="image-20240606161128627" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611721.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611721.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611721.webp?size=large 2x" data-title="image-20240606161128627" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611272.webp" alt="image-20240606161118172" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611272.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611272.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406061611272.webp?size=large 2x" data-title="image-20240606161118172" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>我们只需 16 行就能把 socks5 的架子搭起来：</p>
<pre tabindex="0"><code class="language-stata" data-lang="stata">func process(client net.Conn) {
  if err := Socks5Auth(client); err != nil {
    fmt.Println(&#34;auth error:&#34;, err)
    client.Close()
    return
  }

  target, err := Socks5Connect(client)
  if err != nil {
    fmt.Println(&#34;connect error:&#34;, err)
    client.Close()
    return
  }

  Socks5Forward(client, target)
}</code></pre><p>只要把 Socks5Auth、Socks5Connect 和 Socks5Forward 给补上，一个完整的 socks5 代理就完成啦</p>
<h2 id="auth-握手阶段-协商阶段" class="heading-element"><span>AUth 握手阶段-协商阶段</span>
  <a href="#auth-%e6%8f%a1%e6%89%8b%e9%98%b6%e6%ae%b5-%e5%8d%8f%e5%95%86%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><pre tabindex="0"><code>+----+----------+----------+
|VER | NMETHODS | METHODS  |
+----+----------+----------+
| 1  |    1     | 1 to 255 |
+----+----------+----------+</code></pre><p>浏览器端-&gt;代理端</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">Socks5Auth</span>(<span style="color:#58a1dd">client</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>) (<span style="color:#58a1dd">err</span> <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">buf</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>([]<span style="color:#ff636f">byte</span>, <span style="color:#a6be9d">256</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#828b96;font-style:italic">// 读取 VER 和 NMETHODS
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>  <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#a6be9d">2</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">2</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;reading header: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">ver</span>, <span style="color:#58a1dd">nMethods</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">int</span>(<span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">0</span>]), <span style="color:#58a1dd">int</span>(<span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">1</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">ver</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">5</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid version&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#828b96;font-style:italic">// 读取 METHODS 列表
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>  <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#58a1dd">nMethods</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">nMethods</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;reading methods: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#828b96;font-style:italic">//TO BE CONTINUED...
</span></span></span></code></pre></div><p>代理端-&gt;浏览器端</p>
<p>就是告诉浏览器，我选择了哪种认证方式</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#828b96;font-style:italic">//无需认证
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>  <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">Write</span>([]<span style="color:#ff636f">byte</span>{<span style="color:#a6be9d">0x05</span>, <span style="color:#a6be9d">0x00</span>})
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">2</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;write rsp err: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>当浏览器收到<code>0x00</code>（NO AUTHENTICATION REQUIRED）时，会跳过认证阶段直接进入请求阶段;</p>
<p>所以说这里不需要进行握手阶段-认证阶段了</p>
<h2 id="connect-请求阶段" class="heading-element"><span>Connect 请求阶段</span>
  <a href="#connect-%e8%af%b7%e6%b1%82%e9%98%b6%e6%ae%b5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>这边浏览器的socks包已经发过来了，格式如下</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+</code></pre><p>我们直接处理</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">Socks5Connect</span>(<span style="color:#58a1dd">client</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>) (<span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>, <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">buf</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>([]<span style="color:#ff636f">byte</span>, <span style="color:#a6be9d">256</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#a6be9d">4</span>])
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">4</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;read header: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">ver</span>, <span style="color:#58a1dd">cmd</span>, <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">atyp</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">0</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">1</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">2</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">3</span>]
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">ver</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">5</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">cmd</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">1</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid ver/cmd&#34;</span>)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#828b96;font-style:italic">//TO BE CONTINUED...
</span></span></span></code></pre></div><p>可见这就是一个简单的socks代理，限定死了cmd、socks版本等，上面是检查浏览器发来的socks包是否符合我们的通讯要求，然后要给浏览器作出响应</p>
<p>继续解析</p>
<p>ATYP 目标地址类型，这里只实现了ipv4和域名</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#58a1dd">addr</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">switch</span> <span style="color:#58a1dd">atyp</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">case</span> <span style="color:#a6be9d">1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#a6be9d">4</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">4</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid IPv4: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">addr</span> = <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%d.%d.%d.%d&#34;</span>, <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">0</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">1</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">2</span>], <span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">3</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">case</span> <span style="color:#a6be9d">3</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#a6be9d">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">1</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid hostname: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">addrLen</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">int</span>(<span style="color:#58a1dd">buf</span>[<span style="color:#a6be9d">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadFull</span>(<span style="color:#58a1dd">client</span>, <span style="color:#58a1dd">buf</span>[:<span style="color:#58a1dd">addrLen</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">addrLen</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid hostname: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">addr</span> = <span style="color:#58a1dd">string</span>(<span style="color:#58a1dd">buf</span>[:<span style="color:#58a1dd">addrLen</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">case</span> <span style="color:#a6be9d">4</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;IPv6: no supported yet&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">default</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;invalid atyp&#34;</span>)
</span></span><span style="display:flex;"><span>  }</span></span></code></pre></div><p>既然 ADDR 和 PORT 都就位了，我们马上创建一个到 dst 的连接：</p>
<pre tabindex="0"><code class="language-stata" data-lang="stata"> destAddrPort := fmt.Sprintf(&#34;%s:%d&#34;, addr, port)
 dest, err := net.Dial(&#34;tcp&#34;, destAddrPort)
 if err != nil {
   return nil, errors.New(&#34;dial dst: &#34; + err.Error())
 }</code></pre><p>代理还要给浏览器发消息，结构如下</p>
<pre tabindex="0"><code>+----+-----+-------+------+----------+----------+
|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
+----+-----+-------+------+----------+----------+
| 1  |  1  | X&#39;00&#39; |  1   | Variable |    2     |
+----+-----+-------+------+----------+----------+</code></pre><p>这句话再来一次：</p>
<p>代理服务器既充当socks服务器，又充当relay服务器。实际上这两个是可以被拆开的，当我们的socks5 server和relay server不是一体的，就需要告知客户端==relay server的地址==，这个地址就是BND.ADDR和BND.PORT。</p>
<p>当我们的relay server和socks5 server是同一台服务器时，<code>BND.ADDR</code>和<code>BND.PORT</code>的值全部为0即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">Write</span>([]<span style="color:#ff636f">byte</span>{<span style="color:#a6be9d">0x05</span>, <span style="color:#a6be9d">0x00</span>, <span style="color:#a6be9d">0x00</span>, <span style="color:#a6be9d">0x01</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>})
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">dest</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;write rsp: &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">err</span>.<span style="color:#58a1dd">Error</span>())
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff636f">return</span> <span style="color:#58a1dd">dest</span>, <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>这里就直接用0了，这样这个代理只能在本地使用</p>
<h2 id="forward" class="heading-element"><span>Forward</span>
  <a href="#forward" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>万事俱备，剩下的事情就是转发、转发、转发。</p>
<p>所谓“转发”，其实就是从一头读，往另一头写。</p>
<p>需要注意的是，由于 TCP 连接是双工通信，我们需要创建两个 goroutine，用于完成“双工转发”。</p>
<p>由于 golang 有一个 <code>io.Copy</code> 用来做转发的事情，代码只要 9 行，简单到难以形容：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scss" data-lang="scss"><span style="display:flex;"><span><span style="color:#58a1dd">func</span> <span style="color:#58a1dd">Socks5Forward</span><span style="color:#ff636f">(</span><span style="color:#58a1dd">client</span><span style="color:#ff636f">,</span> <span style="color:#58a1dd">target</span> <span style="color:#58a1dd">net</span><span style="color:#58a1dd">.Conn</span><span style="color:#ff636f">)</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">forward</span><span style="color:#ff636f"> :=</span> <span style="color:#58a1dd">func</span>(<span style="color:#58a1dd">src</span><span style="color:#ff636f">,</span> <span style="color:#58a1dd">dest</span> <span style="color:#58a1dd">net</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">Conn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">defer</span> <span style="color:#58a1dd">src</span><span style="color:#58a1dd">.Close</span><span style="color:#ff636f">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">defer</span> <span style="color:#58a1dd">dest</span><span style="color:#58a1dd">.Close</span><span style="color:#ff636f">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">io</span><span style="color:#58a1dd">.Copy</span><span style="color:#ff636f">(</span><span style="color:#58a1dd">src</span><span style="color:#ff636f">,</span> <span style="color:#58a1dd">dest</span><span style="color:#ff636f">)</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">go</span> <span style="color:#58a1dd">forward</span><span style="color:#ff636f">(</span><span style="color:#58a1dd">client</span><span style="color:#ff636f">,</span> <span style="color:#58a1dd">target</span><span style="color:#ff636f">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#58a1dd">go</span> <span style="color:#58a1dd">forward</span><span style="color:#ff636f">(</span><span style="color:#58a1dd">target</span><span style="color:#ff636f">,</span> <span style="color:#58a1dd">client</span><span style="color:#ff636f">)</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>注意：在发送完以后需要关闭连接。</p>
<h1 id="实现反向代理" class="heading-element"><span>实现反向代理</span>
  <a href="#%e5%ae%9e%e7%8e%b0%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p><a href="https://blog.5a6c.me/posts/build-a-reverse-proxy-use-golang/"target="_blank" rel="external nofollow noopener noreferrer">https://blog.5a6c.me/posts/build-a-reverse-proxy-use-golang/</a></p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111016170.webp" alt="image-20240611101608991" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111016170.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111016170.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111016170.webp?size=large 2x" data-title="image-20240611101608991" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>agent端模拟内网主机，主动向外网的server端发起socks5连接，user也向server端发起连接，server 端监听两个端口, 其中一个是面向用户使用的socks5服务端口, 另一个是与 agent 通信的端口，然后server端把这两个连接怼到一起，实现user和agent的通信</p>
<h2 id="agent" class="heading-element"><span>agent</span>
  <a href="#agent" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>这里使用了这个 socks5 的库(<a href="https://github.com/armon/go-socks5%29"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/armon/go-socks5)</a>, 因为它有一个比较方便的<code>ServeConn</code>方法。在TCP连接建立之后，就将连接交给处理 socks5 协议的库去处理</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;github.com/armon/go-socks5&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">server</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">socks5</span>. <span style="color:#58a1dd">Server</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 起一个简单的 socks5 服务
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">error</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#58a1dd">server</span> , <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">socks5</span>.<span style="color:#58a1dd">New</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">socks5</span>.<span style="color:#58a1dd">Config</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">panic</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 不断向 server 发起连接请求, server 的连接池满了之后, 会阻塞在 dial 这一步
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Dial</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#a6be9d">&#34;127.0.0.1:8989&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">// 连接成功之后, 使用 socks5 库处理该连接
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#ff636f">go</span> <span style="color:#58a1dd">handleSocks5</span>(<span style="color:#58a1dd">conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">handleSocks5</span>(<span style="color:#58a1dd">conn</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">SetDeadline</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Time</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 使用该 socks5 库提供的 ServeConn 方法
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span>  <span style="color:#58a1dd">server</span> .<span style="color:#58a1dd">ServeConn</span>(<span style="color:#58a1dd">conn</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h2 id="server" class="heading-element"><span>server</span>
  <a href="#server" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>server 这边的实现也很简单首先监听两个端口，一个供 user 连接使用，另一个供 agent 回连使用。
在 agent 成功回连之后，再取一条 user 的连接，调用 golang 的 <code>io.Copy</code> 方法，将两个连接的输入输出互相复制，即可将流量转发到 agent 进行处理。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 使用两个 channel 来暂存 agent 和 user 的连接请求
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">userConnChan</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>, <span style="color:#a6be9d">10</span>)
</span></span><span style="display:flex;"><span>	 <span style="color:#58a1dd">agent</span> <span style="color:#58a1dd">ConnChan</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>, <span style="color:#a6be9d">10</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 监听 agent 服务端口
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">go</span> <span style="color:#58a1dd">ListenService</span>( <span style="color:#58a1dd">agent</span> <span style="color:#58a1dd">ConnChan</span>, <span style="color:#a6be9d">&#34;127.0.0.1:8989&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 监听 user 服务端口
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">go</span> <span style="color:#58a1dd">ListenService</span>(<span style="color:#58a1dd">userConnChan</span>, <span style="color:#a6be9d">&#34;127.0.0.1:1080&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span>  <span style="color:#58a1dd">agent</span> <span style="color:#58a1dd">Conn</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span>  <span style="color:#58a1dd">agent</span> <span style="color:#58a1dd">ConnChan</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">userConn</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">userConnChan</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#58a1dd">copyConn</span>(<span style="color:#58a1dd">userConn</span>,  <span style="color:#58a1dd">agent</span> <span style="color:#58a1dd">Conn</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">ListenService</span>(<span style="color:#58a1dd">c</span> <span style="color:#ff636f">chan</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>, <span style="color:#58a1dd">ListenAddress</span> <span style="color:#ff636f">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">listener</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Listen</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#58a1dd">ListenAddress</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">panic</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">listener</span>.<span style="color:#58a1dd">Accept</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">c</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">conn</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">copyConn</span>(<span style="color:#58a1dd">srcConn</span>, <span style="color:#58a1dd">dstConn</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">srcConn</span>.<span style="color:#58a1dd">SetDeadline</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Time</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">dstConn</span>.<span style="color:#58a1dd">SetDeadline</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Time</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">2</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">srcConn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">dstConn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">Copy</span>(<span style="color:#58a1dd">srcConn</span>, <span style="color:#58a1dd">dstConn</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">dstConn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">srcConn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">Copy</span>(<span style="color:#58a1dd">dstConn</span>, <span style="color:#58a1dd">srcConn</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h1 id="代理池" class="heading-element"><span>代理池</span>
  <a href="#%e4%bb%a3%e7%90%86%e6%b1%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>代理理解的差不多了，代理池怎么实现呢？</p>
<p>代理池应该说已经是比较成熟的技术，而且在飞速发展，比如现在主流的“秒拨”技术，代理池技术目前被广泛用于爬虫、灰黑产、SEO、网络攻击、刷单、薅羊毛等等领域。</p>
<p>在github上有许多搭建代理池的项目，原理一般是==通过爬取各个免费的代理资源中的代理IP信息，存储到本地，进行可用性验证，维护可用代理IP列表，然后在需要使用的时候取出代理IP==。</p>
<p>免费的资源最大的问题就是代理IP不可用、不稳定，测试下来，虽然能爬取几千个代理IP，但真正用的可能在10个以内，利用率在1%左右。 另外就是付费模式，这里国内也有很多的服务提供商，现在提供的服务模式多种多样，长期的，包月的，甚至可以按次服务。一般来说代理的匿名度越高，时效越长，价格也越贵。</p>
<h2 id="攻防" class="heading-element"><span>攻防</span>
  <a href="#%e6%94%bb%e9%98%b2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>自从企业开始在IP层面根据一些阻断的规则（如设定单位时间内IP的访问次数阈值、限制触发特定行为的IP等）起，攻防的较量就开始了。为了绕过企业的IP阻断规则，早期黑产获取代理IP的方式主要利用高性能的服务器对全网进行扫描，扫描开放代理服务的服务器，或者是直接爬取其他代理网站的数据，收录有效代理IP和端口。全网的代理IP数量相对有限，稳定性也堪忧，而通过VPN的方式成本又太高。同时，不少甲方也慢慢开始积累代理IP威胁情报信息，进一步打压了黑产使用代理IP的效果。</p>
<p>攻防升级，黑产迅速研发出“秒拨”技术。通俗的讲，秒拨的底层思路就是利用国内家用宽带拨号上网（PPPoE）的原理，每一次断线重连就会获取一个新的IP。黑产掌握大量宽带线路资源，部署自动断线重连切换IP以及攻击的工具后，便可发起攻击。</p>
<p>现在很多付费的代理池资源，都是利用的“秒拨”技术，“秒拨”对基于ip的安全防护和风控措施构成了严峻的挑战：一方面秒拨ip数量巨大，因为地区级的宽带ip池往往有十万甚至百万级别的ip数；另一方面，秒拨ip可做到秒级切换，且与正常用户共用ip池，使用者可能在极短时间内从正常用户变为黑灰产，导致识别难度较大，而且一旦大规模封禁，很有可能造成误伤，引起客户投诉。</p>
<p>攻击方如果采用代理池技术，可能会对防守方产生两个极端影响：</p>
<p>1、如果攻击方将攻击流量分散在大量IP中，极端情况下每一个ip一次攻击，SIEM这类的综合分析系统可能根本不会产生告警，因为攻击没有达到告警阈值，只能人工去分析各类安全告警日志，发现可能异常，类似于威胁狩猎。</p>
<p>2、攻击者利用海量代理IP产生海量攻击，则防守方也会产生海量告警和海量阻断IP的请求，造成Alert DOS和Block DOS，一方面消耗防守大量的精力进行分析，另一方面甚至造成封禁IP的个数超过防守方设备上限，使其防御体系失效，而此时再进行针对性的攻击，就可以达到声东击西的效果。</p>
<p>总之，以“秒拨”为代表的代理池技术已然成为当下安全行业的痛点之一，仅仅依靠威胁情报、网络层封IP的方式已经难以应对，需要重点从应用层面去解决。对于这个痛点，行业内也在积极探索解决方案，出现了“动态防御”的理念，通过动态封装、动态混淆，动态令牌和动态验证来有效进行人机识别。</p>
<h2 id="实现" class="heading-element"><span>实现</span>
  <a href="#%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>去网上找了一些资料，知道代理池的实现大概有这些部分：</p>
<ul>
<li>通过免费代理网站API爬取代理IP</li>
<li>检测IP可用性</li>
<li>持久化存储</li>
<li>代理池的外部接口</li>
</ul>
<p>而我要做的应该还要再套一层，就是上面写的golang实现的socks代理，我本地代理到上面说的正向代理，然后工具内部去生成、维护一个代理池</p>
<p>也就是说，上面实现的socks代理的最后一步 ：Forward需要变，原本是直接转出去，现在是转给我们代理池的IP</p>
<p>第三方代理池的使用参考这个：https://www.zdaye.com/doc/api/ShortProxy_getip</p>
<p>实现参考这个https://studygolang.com/articles/12691</p>
<h1 id="优化" class="heading-element"><span>优化</span>
  <a href="#%e4%bc%98%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h1 id="解读代码" class="heading-element"><span>解读代码</span>
  <a href="#%e8%a7%a3%e8%af%bb%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>这个项目是对go-socks5的二开，我要解决的问题有</p>
<ul>
<li>go-socks5的使用</li>
<li>二开实现了那些功能，具体去读二开的代码</li>
</ul>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111059062.webp" alt="image-20240611105918940" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111059062.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111059062.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202406111059062.webp?size=large 2x" data-title="image-20240611105918940" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="poolgo" class="heading-element"><span>pool.go</span>
  <a href="#poolgo" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>实现了一个代理池管理系统，主要用于管理和维护一组代理服务器。</p>
<h2 id="dialergo" class="heading-element"><span>dialer.go</span>
  <a href="#dialergo" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>基于代理池（<code>ProxyPool</code>）实现的自定义拨号器（<code>ProxyDialer</code>），主要目的是通过代理池中的代理服务器连接到目标地址。</p>
<h2 id="get_proxygp" class="heading-element"><span>get_proxy.gp</span>
  <a href="#get_proxygp" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>用于与一个代理服务（<code>proxy.qg.net</code>）进行交互，添加IP到白名单以及获取代理列表。使用了一个名为 <code>request</code> 的库来处理 HTTP 请求和响应。</p>
<h2 id="qgnet_testgo" class="heading-element"><span>qgnet_test.go</span>
  <a href="#qgnet_testgo" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-08-15 12:31:01">Updated on 2024-08-15&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" class="post-tag" title="Tags - 安全开发">安全开发</a><a href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86/" class="post-tag" title="Tags - 安全开发原理">安全开发原理</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E6%94%BB%E9%98%B2/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/65/" class="post-nav-item" rel="prev" title="远控软件利用"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>远控软件利用</a>
      <a href="/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/69/" class="post-nav-item" rel="next" title="权限维持 常规方法">权限维持 常规方法<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.1">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">东隅</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":20},"comment":{"enable":false},"typeit":{"cursorChar":"_","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-YMSM8DYT3D', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-YMSM8DYT3D" async></script></body>
</html>
