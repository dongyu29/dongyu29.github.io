<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>开源工具分析-Fscan - 东隅 Blog</title><meta name="author" content="东隅">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='安全开发, 开源工具分析' />
  <meta itemprop="name" content="开源工具分析-fscan">
  <meta itemprop="datePublished" content="2024-08-18T12:31:01+08:00">
  <meta itemprop="dateModified" content="2024-08-18T12:31:01+08:00">
  <meta itemprop="wordCount" content="3427">
  <meta itemprop="keywords" content="安全开发,开源工具分析"><meta property="og:url" content="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/3/">
  <meta property="og:site_name" content="东隅 Blog">
  <meta property="og:title" content="开源工具分析-fscan">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-18T12:31:01+08:00">
    <meta property="article:modified_time" content="2024-08-18T12:31:01+08:00">
    <meta property="article:tag" content="安全开发">
    <meta property="article:tag" content="开源工具分析">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="开源工具分析-fscan">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/3/" /><link rel="prev" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/250/" /><link rel="next" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "开源工具分析-fscan",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91\/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90\/3\/"
    },"image": ["https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"],"genre": "posts","keywords": "安全开发, 开源工具分析","wordcount":  3427 ,
    "url": "https:\/\/dongyu29.github.io\/posts\/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6\/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91\/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90\/3\/","datePublished": "2024-08-18T12:31:01+08:00","dateModified": "2024-08-18T12:31:01+08:00","publisher": {
      "@type": "Organization",
      "name": "","logo": "https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"},"author": {
        "@type": "Person",
        "name": "东隅"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ></a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ></a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="东隅 Blog">Home</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">Posts</a></li><li class="breadcrumb-item active" aria-current="page">开源工具分析-Fscan</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid x" aria-hidden="true"></i></span><span>开源工具分析-Fscan</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅" data-title="东隅" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;东隅</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" class="post-category" title="Category - 安全开发"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 安全开发</a></span></div><div class="post-meta-line"><span title="published on 2024-08-18 12:31:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-08-18">2024-08-18</time></span>&nbsp;<span title="3427 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 3500 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>17 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#初始化">初始化</a></li>
    <li><a href="#进入扫描">进入扫描</a>
      <ul>
        <li><a href="#探活">探活</a></li>
        <li><a href="#端口扫描">端口扫描</a></li>
        <li><a href="#vulscan">vulscan</a></li>
        <li><a href="#机制实现">机制实现</a></li>
        <li><a href="#web扫描">web扫描</a></li>
        <li><a href="#插件实现">插件实现</a></li>
        <li><a href="#代理实现">代理实现</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="-----（完）-----"><blockquote>
<p>本文首发于先知社区</p>
</blockquote>
<p>今天思考了一下，web狗安身立命的技能主要是三个：渗透、安全开发、审计，开发貌似也是极其重要的，就像演艺圈一样必须得有自己拿得出手的一个作品，所以决定入门一下安全开发，从扫描器开始入手，扫描器的标杆应该就是fscan了，所以试试读一下fscan的源码，尝试写出比fscan更好的扫描器。</p>
<p><a href="https://github.com/shadow1ng/fscan"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/shadow1ng/fscan</a></p>
<p>fscan是面向过程编写的，先看一下目录结构，主要就是</p>
<p>common：放一些公用模块，比如参数解析，代理，配置</p>
<p>plugins：应该是最核心的目录，扫描器的主体，其中scanner.go文件负责了框架的调度流程</p>
<p>webscan：貌似是另开一个目录写的web扫描，实现了基于yml格式的web扫描指纹插件</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408051017391.webp" alt="image-20240805101701254" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408051017391.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408051017391.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408051017391.webp?size=large 2x" data-title="image-20240805101701254" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>入口函数</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">start</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Now</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">var</span> <span style="color:#58a1dd">Info</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Flag</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">Info</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Parse</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">Info</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">Plugins</span>.<span style="color:#58a1dd">Scan</span>(<span style="color:#58a1dd">Info</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">t</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Now</span>().<span style="color:#58a1dd">Sub</span>(<span style="color:#58a1dd">start</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[*] 扫描结束,耗时: %s\n&#34;</span>, <span style="color:#58a1dd">t</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><ul>
<li>common.Flag：从命令行获取输入的参数，并根据参数准备程序运行的方式</li>
<li>common.Parse：解析输入的内容，如从文件中读取主机，将主机范围转化为主机切片</li>
<li>Plugins.Scan：开始进行扫描</li>
</ul>
<h1 id="参数解析" class="heading-element"><span>参数解析</span>
  <a href="#%e5%8f%82%e6%95%b0%e8%a7%a3%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>涉及入口函数里的</p>
<pre><code>common.Flag(&amp;Info)
common.Parse(&amp;Info)
</code></pre>
<p>FLAG用到了flag库，将命令行输入的参数保存到内存中，也设置了一些默认值啥的，保存完了以后parse进行解析</p>
<pre tabindex="0"><code>func Parse(Info *HostInfo) {
	ParseUser()
	ParsePass(Info)
	ParseInput(Info)
	ParseScantype(Info)
}</code></pre><p>解析的流程就是这四个函数，前两个对输入的用户名密码进行解析，后面解析输入的一堆参数，去一下重，把添加的数据和默认数据组合一下啥的，至于ParseScantype，是检查采用的模块，就是很简单的用啥模块就用switch去选择哪个端口</p>
<h1 id="scan" class="heading-element"><span>scan</span>
  <a href="#scan" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h2 id="初始化" class="heading-element"><span>初始化</span>
  <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>到最重要的scan模块了</p>
<p>首先解析一下host，这一步依旧是参数解析，解析一下输入的参数，去一下重啥的</p>
<pre tabindex="0"><code>Hosts, err := common.ParseIP(info.Host, common.HostFile, common.NoHosts)</code></pre><p>接着初始化一个http客户端，不知道有啥用</p>
<pre tabindex="0"><code>lib.Inithttp()</code></pre><p>继续初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">ch</span> = <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Threads</span>)</span></span></code></pre></div><p><code>make</code> 函数用于创建一个新的通道。</p>
<p><code>chan struct{}</code>: 定义了一个通道，通道的元素类型是 <code>struct{}</code>。在这里，<code>struct{}</code> 是一个空的结构体，通常用于作为信号的占位符，不携带任何数据。</p>
<p><code>common.Threads</code>: 通道的缓冲区大小。这意味着通道可以同时容纳 <code>common.Threads</code> 个信号。如果缓冲区满，则发送操作会被阻塞，直到有空间可用。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> = <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>{}</span></span></code></pre></div><p><strong><code>sync.WaitGroup{}</code></strong>:</p>
<ul>
<li><code>sync.WaitGroup</code> 是一个用于等待一组操作完成的同步原语。</li>
<li><code>sync.WaitGroup</code> 提供了三个主要方法：<code>Add</code>（增加计数）、<code>Done</code>（减少计数）和 <code>Wait</code>（等待计数变为零）。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">web</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PORTList</span>[<span style="color:#a6be9d">&#34;web&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ms17010</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PORTList</span>[<span style="color:#a6be9d">&#34;ms17010&#34;</span>])</span></span></code></pre></div><p>从映射中获取并转换端口</p>
<p><strong><code>common.PORTList</code></strong>:</p>
<ul>
<li>
<p><code>PORTList</code> 是一个映射，其键是 <code>string</code> 类型，值是 <code>int</code> 类型。</p>
</li>
<li>
<p><code>strconv.Itoa</code> 是一个用于将整数转换为字符串的函数。</p>
</li>
</ul>
<h2 id="进入扫描" class="heading-element"><span>进入扫描</span>
  <a href="#%e8%bf%9b%e5%85%a5%e6%89%ab%e6%8f%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>到了这么if差不多就正式进入扫描了</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">Hosts</span>) &gt; <span style="color:#a6be9d">0</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostPort</span>) &gt; <span style="color:#a6be9d">0</span></span></span></code></pre></div><p>首先是判断是否进行存活扫描，并打印存活主机的数量。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">NoPing</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">false</span> <span style="color:#ff636f">&amp;&amp;</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">Hosts</span>) &gt; <span style="color:#a6be9d">1</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;icmp&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Hosts</span> = <span style="color:#58a1dd">CheckLive</span>(<span style="color:#58a1dd">Hosts</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ping</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;[*] Icmp alive hosts len is:&#34;</span>, <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">Hosts</span>))
</span></span><span style="display:flex;"><span>		}</span></span></code></pre></div><h3 id="探活" class="heading-element"><span>探活</span>
  <a href="#%e6%8e%a2%e6%b4%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>先来看一下fscan是怎么探活的</p>
<p>第一部分</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">chanHosts</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">hostslist</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">ip</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">chanHosts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">ExistHosts</span>[<span style="color:#58a1dd">ip</span>]; !<span style="color:#58a1dd">ok</span> <span style="color:#ff636f">&amp;&amp;</span> <span style="color:#58a1dd">IsContain</span>(<span style="color:#58a1dd">hostslist</span>, <span style="color:#58a1dd">ip</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">ExistHosts</span>[<span style="color:#58a1dd">ip</span>] = <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Silent</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">false</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#ff636f">if</span> <span style="color:#58a1dd">Ping</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">false</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;(icmp) Target %-15s is alive\n&#34;</span>, <span style="color:#58a1dd">ip</span>)
</span></span><span style="display:flex;"><span>					} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;(ping) Target %-15s is alive\n&#34;</span>, <span style="color:#58a1dd">ip</span>)
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">AliveHosts</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AliveHosts</span>, <span style="color:#58a1dd">ip</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">livewg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()</span></span></code></pre></div><p><code>chanHosts := make(chan string, len(hostslist))</code>这里先创建了一个信道用于传递ip</p>
<p><strong><code>range chanHosts</code></strong>: 这个 <code>range</code> 语句会从 <code>chanHosts</code> 通道中接收数据，直到通道关闭为止。每次从通道中接收到一个数据项，<code>ip</code> 变量会被赋值为通道中的数据。</p>
<p><strong><code>Goroutine</code></strong>: 异步执行主机存活状态的处理。它从通道中读取 IP 地址，并检查是否已存在。如果主机存活且不在 <code>ExistHosts</code> 中，则将其添加到 <code>AliveHosts</code> 列表中，并打印相关信息。</p>
<p><strong>选择检测方法</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">Ping</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">true</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">//使用ping探测
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">RunPing</span>(<span style="color:#58a1dd">hostslist</span>, <span style="color:#58a1dd">chanHosts</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">//优先尝试监听本地icmp,批量探测
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">icmp</span>.<span style="color:#58a1dd">ListenPacket</span>(<span style="color:#a6be9d">&#34;ip4:icmp&#34;</span>, <span style="color:#a6be9d">&#34;0.0.0.0&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">RunIcmp1</span>(<span style="color:#58a1dd">hostslist</span>, <span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">chanHosts</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogError</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">//尝试无监听icmp探测
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;trying RunIcmp2&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">DialTimeout</span>(<span style="color:#a6be9d">&#34;ip4:icmp&#34;</span>, <span style="color:#a6be9d">&#34;127.0.0.1&#34;</span>, <span style="color:#a6be9d">3</span><span style="color:#ff636f">*</span><span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">defer</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> <span style="color:#58a1dd">conn</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}()
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">RunIcmp2</span>(<span style="color:#58a1dd">hostslist</span>, <span style="color:#58a1dd">chanHosts</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogError</span>(<span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#828b96;font-style:italic">//使用ping探测
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;The current user permissions unable to send icmp packets&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;start ping&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">RunPing</span>(<span style="color:#58a1dd">hostslist</span>, <span style="color:#58a1dd">chanHosts</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>ps:<code>ping</code> 实际上就是一种 ICMP 探测。</p>
<p><strong><code>ping</code></strong> 是一个现成的工具，直接使用，简单易用。</p>
<p>ping可以看作是ICMP探活的一个子集或特例。ICMP探活提供了更多的可能性和灵活性</p>
<p>这里的优势：</p>
<ul>
<li>直接使用 ICMP 包通常比调用系统的 ping 命令消耗更少的资源</li>
<li>代码会先尝试需要较高权限的方法（如 ICMP 监听），如果失败则退回到可能需要较低权限的方法。</li>
</ul>
<p>看一下ping的具体实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">RunPing</span>(<span style="color:#58a1dd">hostslist</span> []<span style="color:#ff636f">string</span>, <span style="color:#58a1dd">chanHosts</span> <span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">limiter</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#a6be9d">50</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">host</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">hostslist</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">limiter</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>(<span style="color:#58a1dd">host</span> <span style="color:#ff636f">string</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">ExecCommandPing</span>(<span style="color:#58a1dd">host</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">livewg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">chanHosts</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">host</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">limiter</span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		}(<span style="color:#58a1dd">host</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>使用一个容量为 50 的 channel（limiter）来限制同时进行的 ping 操作数量，其实就是==信号量==。<code>struct{}{}</code> 是一个空结构体，不占用任何内存空间，所以它经常被用作信号的载体。<code>&lt;-</code> 操作符在这里表示向 channel 发送数据。<code>limiter &lt;- struct{}{}</code>向 <code>limiter</code> channel 发送一个空结构体。如果 channel 已满（即当前已有 50 个并发操作在进行），这个操作会阻塞，直到 channel 有空位。<code>&lt;-limiter</code>这个操作的含义是：&ldquo;从 limiter channel 中取出一个值&rdquo;。如果 channel 为空，这个操作会阻塞直到有数据可取。</p>
<p>这是一个demo</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 创建一个容量为3的limiter
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">limiter</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#a6be9d">3</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 模拟10个任务
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">i</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">1</span>; <span style="color:#58a1dd">i</span> <span style="color:#ff636f">&lt;=</span> <span style="color:#a6be9d">10</span>; <span style="color:#58a1dd">i</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>(<span style="color:#58a1dd">taskID</span> <span style="color:#ff636f">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Task %d is waiting to start\n&#34;</span>, <span style="color:#58a1dd">taskID</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">// 占用一个槽位
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#58a1dd">limiter</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Task %d has started\n&#34;</span>, <span style="color:#58a1dd">taskID</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">// 模拟任务执行
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Duration</span>(<span style="color:#58a1dd">rand</span>.<span style="color:#58a1dd">Intn</span>(<span style="color:#a6be9d">5</span>)) <span style="color:#ff636f">*</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">// 释放槽位
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">limiter</span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Task %d has finished\n&#34;</span>, <span style="color:#58a1dd">taskID</span>)
</span></span><span style="display:flex;"><span>		}(<span style="color:#58a1dd">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;All tasks completed&#34;</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>使用 sync.WaitGroup（wg）来确保所有 goroutines 完成后才结束函数。</p>
<p>ExecCommandPing其实就是调用系统命令了，chanHosts &lt;- host把存活的host放到上面定义好的chan里</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">ExecCommandPing</span>(<span style="color:#58a1dd">ip</span> <span style="color:#ff636f">string</span>) <span style="color:#ff636f">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">command</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">exec</span>.<span style="color:#58a1dd">Cmd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">switch</span> <span style="color:#58a1dd">runtime</span>.<span style="color:#58a1dd">GOOS</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">case</span> <span style="color:#a6be9d">&#34;windows&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">command</span> = <span style="color:#58a1dd">exec</span>.<span style="color:#58a1dd">Command</span>(<span style="color:#a6be9d">&#34;cmd&#34;</span>, <span style="color:#a6be9d">&#34;/c&#34;</span>, <span style="color:#a6be9d">&#34;ping -n 1 -w 1 &#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">ip</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34; &amp;&amp; echo true || echo false&#34;</span>) <span style="color:#828b96;font-style:italic">//ping -c 1 -i 0.5 -t 4 -W 2 -w 5 &#34;+ip+&#34; &gt;/dev/null &amp;&amp; echo true || echo false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">case</span> <span style="color:#a6be9d">&#34;darwin&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">command</span> = <span style="color:#58a1dd">exec</span>.<span style="color:#58a1dd">Command</span>(<span style="color:#a6be9d">&#34;/bin/bash&#34;</span>, <span style="color:#a6be9d">&#34;-c&#34;</span>, <span style="color:#a6be9d">&#34;ping -c 1 -W 1 &#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">ip</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34; &amp;&amp; echo true || echo false&#34;</span>) <span style="color:#828b96;font-style:italic">//ping -c 1 -i 0.5 -t 4 -W 2 -w 5 &#34;+ip+&#34; &gt;/dev/null &amp;&amp; echo true || echo false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">default</span>: <span style="color:#828b96;font-style:italic">//linux
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">command</span> = <span style="color:#58a1dd">exec</span>.<span style="color:#58a1dd">Command</span>(<span style="color:#a6be9d">&#34;/bin/bash&#34;</span>, <span style="color:#a6be9d">&#34;-c&#34;</span>, <span style="color:#a6be9d">&#34;ping -c 1 -w 1 &#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">ip</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34; &amp;&amp; echo true || echo false&#34;</span>) <span style="color:#828b96;font-style:italic">//ping -c 1 -i 0.5 -t 4 -W 2 -w 5 &#34;+ip+&#34; &gt;/dev/null &amp;&amp; echo true || echo false&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">outinfo</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">bytes</span>.<span style="color:#58a1dd">Buffer</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">command</span>.<span style="color:#58a1dd">Stdout</span> = <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">outinfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">command</span>.<span style="color:#58a1dd">Start</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">command</span>.<span style="color:#58a1dd">Wait</span>(); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">outinfo</span>.<span style="color:#58a1dd">String</span>(), <span style="color:#a6be9d">&#34;true&#34;</span>) <span style="color:#ff636f">&amp;&amp;</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Count</span>(<span style="color:#58a1dd">outinfo</span>.<span style="color:#58a1dd">String</span>(), <span style="color:#58a1dd">ip</span>) &gt; <span style="color:#a6be9d">2</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">true</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>再来看icmp探活的实现，就不是调用系统执行命令了，感觉这样效率应该会高一些，坏处就是需要自己去写实现网络通信的一些处理代码</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">icmpalive</span>(<span style="color:#58a1dd">host</span> <span style="color:#ff636f">string</span>) <span style="color:#ff636f">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">startTime</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">DialTimeout</span>(<span style="color:#a6be9d">&#34;ip4:icmp&#34;</span>, <span style="color:#58a1dd">host</span>, <span style="color:#a6be9d">6</span><span style="color:#ff636f">*</span><span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">SetDeadline</span>(<span style="color:#58a1dd">startTime</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">6</span> <span style="color:#ff636f">*</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">msg</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">makemsg</span>(<span style="color:#58a1dd">host</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Write</span>(<span style="color:#58a1dd">msg</span>); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">receive</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>([]<span style="color:#ff636f">byte</span>, <span style="color:#a6be9d">60</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Read</span>(<span style="color:#58a1dd">receive</span>); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#ff636f">true</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong>等待所有探测完成并关闭通道</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">livewg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">chanHosts</span>)</span></span></code></pre></div><p><strong><code>livewg.Wait()</code></strong>: 等待所有 Goroutine 完成。</p>
<p><strong><code>close(chanHosts)</code></strong>: 关闭通道，表示探测完成。</p>
<p>最后处理探测结果返回数据</p>
<h3 id="端口扫描" class="heading-element"><span>端口扫描</span>
  <a href="#%e7%ab%af%e5%8f%a3%e6%89%ab%e6%8f%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>我们继续看scanner.go，这里就是各种端口扫描的类型。注意这里各种端口扫描的参数Hosts就是上面的探活的结果</p>
<p>这里调用的函数位于portscan.go文件</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;webonly&#34;</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;webpoc&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AlivePorts</span> = <span style="color:#58a1dd">NoPortScan</span>(<span style="color:#58a1dd">Hosts</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ports</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> <span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;hostname&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ports</span> = <span style="color:#a6be9d">&#34;139&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AlivePorts</span> = <span style="color:#58a1dd">NoPortScan</span>(<span style="color:#58a1dd">Hosts</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ports</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> <span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">Hosts</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AlivePorts</span> = <span style="color:#58a1dd">PortScan</span>(<span style="color:#58a1dd">Hosts</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Timeout</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;[*] alive ports len is:&#34;</span>, <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">AlivePorts</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;portscan&#34;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogWG</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}</span></span></code></pre></div><p>如果扫描类型是 &ldquo;webonly&rdquo; 或 &ldquo;webpoc&rdquo;：</p>
<ul>
<li>使用 NoPortScan 函数，可能是为了快速检查web服务，而不进行完整的端口扫描。</li>
</ul>
<p>如果扫描类型是 &ldquo;hostname&rdquo;：</p>
<ul>
<li>将端口设置为 &ldquo;139&rdquo;（通常用于NetBIOS会话服务）。</li>
<li>同样使用 NoPortScan 函数。</li>
</ul>
<p>对于其他扫描类型（如果主机列表不为空）：</p>
<ul>
<li>使用 PortScan 函数进行完整的端口扫描。</li>
<li>打印出活跃端口的数量。</li>
<li>如果扫描类型是 &ldquo;portscan&rdquo;，则等待日志写入完成后直接返回。</li>
</ul>
<p>先看下noport，也就是webonly和hostname的情况</p>
<p>webonly会有一堆端口，hostname只有139</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">probePorts</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">ParsePort</span>(<span style="color:#58a1dd">ports</span>)
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">noPorts</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">ParsePort</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">NoPorts</span>)</span></span></code></pre></div><p><code>ParsePort</code>函数是用来解析端口字符串并返回一个整数切片，common.NoPorts是要排除的端口</p>
<p>这一段是去除掉不扫描的端口</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">noPorts</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">temp</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">map</span>[<span style="color:#ff636f">int</span>]<span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">probePorts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">temp</span>[<span style="color:#58a1dd">port</span>] = <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">noPorts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">delete</span>(<span style="color:#58a1dd">temp</span>, <span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">var</span> <span style="color:#58a1dd">newDatas</span> []<span style="color:#ff636f">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">port</span>, <span style="color:#58a1dd">_</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">temp</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">newDatas</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">newDatas</span>, <span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">probePorts</span> = <span style="color:#58a1dd">newDatas</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">sort</span>.<span style="color:#58a1dd">Ints</span>(<span style="color:#58a1dd">probePorts</span>)
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p><code>map[int]struct{}{}</code> 是 Go 语言中的一种语法，用于创建和初始化一个空的 <code>map</code>。在这个 <code>map</code> 中，键的类型是 <code>int</code>，值的类型是 <code>struct{}</code>，多出来的<code>{}</code> 用于初始化数据结构。在这它用于初始化一个空的 <code>map</code>。</p>
<p>最后就是得到全部要扫描的ip和端口的组合，好家伙，这里意思就是直接默认给出的端口存在了，不扫了</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">probePorts</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">host</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">hostslist</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">address</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">host</span> <span style="color:#ff636f">+</span> <span style="color:#a6be9d">&#34;:&#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AliveAddress</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AliveAddress</span>, <span style="color:#58a1dd">address</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>再来看PortScan</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">PortScan</span>(<span style="color:#58a1dd">Hosts</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Timeout</span>)</span></span></code></pre></div><p>先来看准备部分，这里又出现了上面的解析端口以及去掉不需要扫描的端口的部分，感觉代码有点冗余</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">AliveAddress</span> []<span style="color:#ff636f">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">probePorts</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">ParsePort</span>(<span style="color:#58a1dd">ports</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">probePorts</span>) <span style="color:#ff636f">==</span> <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] parse port %s error, please check your port format\n&#34;</span>, <span style="color:#58a1dd">ports</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">AliveAddress</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">noPorts</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">ParsePort</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">NoPorts</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">noPorts</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">temp</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">map</span>[<span style="color:#ff636f">int</span>]<span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">probePorts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">temp</span>[<span style="color:#58a1dd">port</span>] = <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">noPorts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">delete</span>(<span style="color:#58a1dd">temp</span>, <span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">var</span> <span style="color:#58a1dd">newDatas</span> []<span style="color:#ff636f">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">temp</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">newDatas</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">newDatas</span>, <span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">probePorts</span> = <span style="color:#58a1dd">newDatas</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">sort</span>.<span style="color:#58a1dd">Ints</span>(<span style="color:#58a1dd">probePorts</span>)
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>然后就是真正的端口扫描部分</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">workers</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Threads</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">Addrs</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#58a1dd">Addr</span>, <span style="color:#a6be9d">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">results</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">string</span>, <span style="color:#a6be9d">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//接收结果
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">found</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">results</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AliveAddress</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AliveAddress</span>, <span style="color:#58a1dd">found</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//多线程扫描
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">i</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">0</span>; <span style="color:#58a1dd">i</span> &lt; <span style="color:#58a1dd">workers</span>; <span style="color:#58a1dd">i</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">for</span> <span style="color:#58a1dd">addr</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">Addrs</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">PortConnect</span>(<span style="color:#58a1dd">addr</span>, <span style="color:#58a1dd">results</span>, <span style="color:#58a1dd">timeout</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//添加扫描目标
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">probePorts</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">host</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">hostslist</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Addrs</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">Addr</span>{<span style="color:#58a1dd">host</span>, <span style="color:#58a1dd">port</span>}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">Addrs</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">results</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">AliveAddress</span></span></span></code></pre></div><p>按逻辑来说首先应该是添加扫描目标</p>
<p>这里也就是组合端口和ip，wg.Add(1)设置等待向创建的Addrs添加一条数据，Addrs容量是100，所以这里只能同时扫100个ip:port的组合</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//添加扫描目标
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">probePorts</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">host</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">hostslist</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Addrs</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">Addr</span>{<span style="color:#58a1dd">host</span>, <span style="color:#58a1dd">port</span>}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>然后是开扫，从Addrs拿一个数据调用PortConnect</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//多线程扫描
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">i</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">0</span>; <span style="color:#58a1dd">i</span> &lt; <span style="color:#58a1dd">workers</span>; <span style="color:#58a1dd">i</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">for</span> <span style="color:#58a1dd">addr</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">Addrs</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">PortConnect</span>(<span style="color:#58a1dd">addr</span>, <span style="color:#58a1dd">results</span>, <span style="color:#58a1dd">timeout</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>看一下PortConnect，这算是fscan端口扫描的核心代码了吧</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">PortConnect</span>(<span style="color:#58a1dd">addr</span> <span style="color:#58a1dd">Addr</span>, <span style="color:#58a1dd">respondingHosts</span> <span style="color:#ff636f">chan</span><span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">adjustedTimeout</span> <span style="color:#ff636f">int64</span>, <span style="color:#58a1dd">wg</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">host</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">addr</span>.<span style="color:#58a1dd">ip</span>, <span style="color:#58a1dd">addr</span>.<span style="color:#58a1dd">port</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">WrapperTcpWithTimeout</span>(<span style="color:#a6be9d">&#34;tcp4&#34;</span>, <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%s:%v&#34;</span>, <span style="color:#58a1dd">host</span>, <span style="color:#58a1dd">port</span>), <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Duration</span>(<span style="color:#58a1dd">adjustedTimeout</span>)<span style="color:#ff636f">*</span><span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">address</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">host</span> <span style="color:#ff636f">+</span> <span style="color:#a6be9d">&#34;:&#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">port</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">result</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%s open&#34;</span>, <span style="color:#58a1dd">address</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogSuccess</span>(<span style="color:#58a1dd">result</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">respondingHosts</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">address</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>用的其实还是go的net包，后面我去研究了一下端口扫描器的实现，貌似用net包就可以了，此外net包还有很多其他的功能可以让我开发其他的安全攻击</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">WrapperTcpWithTimeout</span>(<span style="color:#58a1dd">network</span>, <span style="color:#58a1dd">address</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">timeout</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Duration</span>) (<span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Conn</span>, <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">d</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Dialer</span>{<span style="color:#58a1dd">Timeout</span>: <span style="color:#58a1dd">timeout</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">WrapperTCP</span>(<span style="color:#58a1dd">network</span>, <span style="color:#58a1dd">address</span>, <span style="color:#58a1dd">d</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>不过这里我没看到在哪里把结果传给results这个信道的</p>
<p>最后就是接收结果，遍历results信道添加扫到的结果</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//接收结果
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">found</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">results</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">AliveAddress</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AliveAddress</span>, <span style="color:#58a1dd">found</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()</span></span></code></pre></div><p>然后这里不是很理解sync.WaitGroup咋用的，gpt写了个demo，感觉可以理解为wg.Add相当于给这个线程打个标记，结束了就执行wg.Done，然后sync.WaitGroup会一直监视有没有打了标记但是还没执行Done方法的（还没结束），就会一直等着</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 要启动的 goroutine 数量
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">numGoroutines</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 为每个 goroutine 增加计数
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">i</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">1</span>; <span style="color:#58a1dd">i</span> <span style="color:#ff636f">&lt;=</span> <span style="color:#58a1dd">numGoroutines</span>; <span style="color:#58a1dd">i</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>) <span style="color:#828b96;font-style:italic">// 计数器加 1
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>(<span style="color:#58a1dd">id</span> <span style="color:#ff636f">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>() <span style="color:#828b96;font-style:italic">// 在 goroutine 结束时将计数器减 1
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Goroutine %d is starting\n&#34;</span>, <span style="color:#58a1dd">id</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">// 模拟工作
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span> <span style="color:#ff636f">*</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Duration</span>(<span style="color:#58a1dd">id</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;Goroutine %d is done\n&#34;</span>, <span style="color:#58a1dd">id</span>)
</span></span><span style="display:flex;"><span>		}(<span style="color:#58a1dd">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">// 等待所有 goroutine 完成
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;All goroutines have completed&#34;</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="vulscan" class="heading-element"><span>vulscan</span>
  <a href="#vulscan" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>端口的处理完毕，继续来看scanner.go，注释里说这里开始进入vulscan了</p>
<p>这里是根据不同情况对AddScan的调用</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">severports</span> []<span style="color:#ff636f">string</span> <span style="color:#828b96;font-style:italic">//severports := []string{&#34;21&#34;,&#34;22&#34;,&#34;135&#34;.&#34;445&#34;,&#34;1433&#34;,&#34;3306&#34;,&#34;5432&#34;,&#34;6379&#34;,&#34;9200&#34;,&#34;11211&#34;,&#34;27017&#34;...}
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">port</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PORTList</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">severports</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">severports</span>, <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">port</span>))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;start vulscan&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">targetIP</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">AlivePorts</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Host</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Split</span>(<span style="color:#58a1dd">targetIP</span>, <span style="color:#a6be9d">&#34;:&#34;</span>)[<span style="color:#a6be9d">0</span>], <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Split</span>(<span style="color:#58a1dd">targetIP</span>, <span style="color:#a6be9d">&#34;:&#34;</span>)[<span style="color:#a6be9d">1</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;all&#34;</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;main&#34;</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">switch</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">case</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;135&#34;</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//findnet
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>					<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">IsWmi</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#58a1dd">AddScan</span>(<span style="color:#a6be9d">&#34;1000005&#34;</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//wmiexec
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>					}
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">case</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;445&#34;</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">ms17010</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//ms17010
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>					<span style="color:#828b96;font-style:italic">//AddScan(info.Ports, info, ch, &amp;wg)  //smb
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>					<span style="color:#828b96;font-style:italic">//AddScan(&#34;1000002&#34;, info, ch, &amp;wg) //smbghost
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#ff636f">case</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;9000&#34;</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">web</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>)        <span style="color:#828b96;font-style:italic">//http
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//fcgiscan
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#ff636f">case</span> <span style="color:#58a1dd">IsContain</span>(<span style="color:#58a1dd">severports</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>):
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//plugins scan
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#ff636f">default</span>:
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">web</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>) <span style="color:#828b96;font-style:italic">//webtitle
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">scantype</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">strconv</span>.<span style="color:#58a1dd">Itoa</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PORTList</span>[<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Scantype</span>])
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">scantype</span>, <span style="color:#58a1dd">info</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ch</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">wg</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}</span></span></code></pre></div><p>感觉这一块的代码写的很丑啊</p>
<p>主要来看addscan</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">scantype</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>, <span style="color:#58a1dd">ch</span> <span style="color:#ff636f">*</span><span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#58a1dd">wg</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">*</span><span style="color:#58a1dd">ch</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Num</span> <span style="color:#ff636f">+=</span> <span style="color:#a6be9d">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">ScanFunc</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">scantype</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">info</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">End</span> <span style="color:#ff636f">+=</span> <span style="color:#a6be9d">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">&lt;-*</span><span style="color:#58a1dd">ch</span>
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>这里的锁操作又得补习一下了，然后这个函数调用的就是scanfunc，是动态调用插件的</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">ScanFunc</span>(<span style="color:#58a1dd">name</span> <span style="color:#ff636f">*</span><span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">defer</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">recover</span>(); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] %v:%v scan error: %v\n&#34;</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Host</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">f</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#58a1dd">PluginList</span>[<span style="color:#ff636f">*</span><span style="color:#58a1dd">name</span>])
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">in</span> <span style="color:#ff636f">:=</span> []<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">Value</span>{<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#58a1dd">info</span>)}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">f</span>.<span style="color:#58a1dd">Call</span>(<span style="color:#58a1dd">in</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><strong><code>ScanFunc</code></strong> 函数根据给定的插件名称动态调用相应的插件函数。它使用 <code>reflect</code> 包来实现动态函数调用，并在调用过程中处理可能发生的错误。</p>
<p><strong><code>defer</code> 和 <code>recover</code></strong>:</p>
<ul>
<li>使用 <code>defer</code> 和 <code>recover</code> 处理函数调用中的异常。这样可以确保在函数发生异常时，能够输出错误信息，而不是让程序崩溃。</li>
</ul>
<p><strong><code>reflect.ValueOf(PluginList[\*name])</code></strong>:</p>
<ul>
<li>
<p><code>reflect.ValueOf</code> 用于获取 <code>PluginList</code> 中对应插件名称的函数值。</p>
</li>
<li>
<p><code>f.Call(in)</code> 动态调用 <code>PluginList</code> 中的函数。<code>in</code> 是一个 <code>[]reflect.Value</code> 切片，包含了要传递给函数的参数（在这里是 <code>info</code>）。</p>
</li>
</ul>
<p>来看一下fscan是怎么调用的，来看PluginList，是一个在base.go中定义的map。</p>
<p>这里就是简单的把端口和插件名（go文件的名称）进行对应，然后进行调用，这里我不禁疑问，要是该服务用的不是默认端口咋办？</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">PluginList</span> = <span style="color:#ff636f">map</span>[<span style="color:#ff636f">string</span>]<span style="color:#ff636f">interface</span>{}{
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;21&#34;</span>:      <span style="color:#58a1dd">FtpScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;22&#34;</span>:      <span style="color:#58a1dd">SshScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;135&#34;</span>:     <span style="color:#58a1dd">Findnet</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;139&#34;</span>:     <span style="color:#58a1dd">NetBIOS</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;445&#34;</span>:     <span style="color:#58a1dd">SmbScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1433&#34;</span>:    <span style="color:#58a1dd">MssqlScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1521&#34;</span>:    <span style="color:#58a1dd">OracleScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;3306&#34;</span>:    <span style="color:#58a1dd">MysqlScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;3389&#34;</span>:    <span style="color:#58a1dd">RdpScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;5432&#34;</span>:    <span style="color:#58a1dd">PostgresScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;6379&#34;</span>:    <span style="color:#58a1dd">RedisScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;9000&#34;</span>:    <span style="color:#58a1dd">FcgiScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;11211&#34;</span>:   <span style="color:#58a1dd">MemcachedScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;27017&#34;</span>:   <span style="color:#58a1dd">MongodbScan</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1000001&#34;</span>: <span style="color:#58a1dd">MS17010</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1000002&#34;</span>: <span style="color:#58a1dd">SmbGhost</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1000003&#34;</span>: <span style="color:#58a1dd">WebTitle</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1000004&#34;</span>: <span style="color:#58a1dd">SmbScan2</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;1000005&#34;</span>: <span style="color:#58a1dd">WmiExec</span>,
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>然后就是去实现它的各种插件了，这里也能知道要是自己想拓展它的功能就需要到这个PluginList加自己的规则，然后写一个go文件。</p>
<p>web的扫描应该还涉及对yaml格式的poc的调用</p>
<blockquote>
<p>读fscan剩下的任务应该还有</p>
<ul>
<li>scanner.go最后这里动态调用机制的实现，包括线程锁，信号量啥的，看看怎么实现的</li>
<li>重点看一下对web的扫描，debug一下看看流程，看看怎么去匹配指纹（icohash咋算），怎么解析、调用poc，怎么抓取和分析web</li>
<li>大致看一下各种插件的实现</li>
<li>看一下代理怎么实现的</li>
</ul>
</blockquote>
<p>这里再补习一下go的线程池的实现</p>
<p>这个例子很清晰了，可以看到work是用来处理输入信号和输出信号的地方，可以用for循环的方式启动3个worker，每个 <code>worker</code> 都在一个独立的 goroutine 中运行，这实际上就是启动了 3 个并发线程。</p>
<p>然后就是一个循环结构来发送信号（任务），往信道里发，goroutine中启动的worker会自动处理，然后再启动一个循环结构接收返回值</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> <span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// 这里是 worker，我们将并发执行多个 worker。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// worker 将从 `jobs` 通道接收任务，并且通过 `results` 发送对应的结果。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// 我们将让每个任务间隔 1s 来模仿一个耗时的任务。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">worker</span>(<span style="color:#58a1dd">id</span> <span style="color:#ff636f">int</span>, <span style="color:#58a1dd">jobs</span> <span style="color:#ff636f">&lt;-</span><span style="color:#ff636f">chan</span> <span style="color:#ff636f">int</span>, <span style="color:#58a1dd">results</span> <span style="color:#ff636f">chan</span><span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">for</span> <span style="color:#58a1dd">j</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">jobs</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;worker&#34;</span>, <span style="color:#58a1dd">id</span>, <span style="color:#a6be9d">&#34;processing job&#34;</span>, <span style="color:#58a1dd">j</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Sleep</span>(<span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">results</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">j</span> <span style="color:#ff636f">*</span> <span style="color:#a6be9d">2</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// 为了使用 worker 线程池并且收集他们的结果，我们需要 2 个通道。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">jobs</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">int</span>, <span style="color:#a6be9d">100</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">results</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#ff636f">int</span>, <span style="color:#a6be9d">100</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// 这里启动了 3 个 worker，初始是阻塞的，因为还没有传递任务。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">for</span> <span style="color:#58a1dd">w</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">1</span>; <span style="color:#58a1dd">w</span> <span style="color:#ff636f">&lt;=</span> <span style="color:#a6be9d">3</span>; <span style="color:#58a1dd">w</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">go</span> <span style="color:#58a1dd">worker</span>(<span style="color:#58a1dd">w</span>, <span style="color:#58a1dd">jobs</span>, <span style="color:#58a1dd">results</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// 这里我们发送 9 个 `jobs`，然后 `close` 这些通道
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#828b96;font-style:italic">// 来表示这些就是所有的任务了。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">for</span> <span style="color:#58a1dd">j</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">1</span>; <span style="color:#58a1dd">j</span> <span style="color:#ff636f">&lt;=</span> <span style="color:#a6be9d">9</span>; <span style="color:#58a1dd">j</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">jobs</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">j</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">jobs</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// 最后，我们收集所有这些任务的返回值。
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">for</span> <span style="color:#58a1dd">a</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">1</span>; <span style="color:#58a1dd">a</span> <span style="color:#ff636f">&lt;=</span> <span style="color:#a6be9d">9</span>; <span style="color:#58a1dd">a</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">&lt;-</span><span style="color:#58a1dd">results</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><h3 id="机制实现" class="heading-element"><span>机制实现</span>
  <a href="#%e6%9c%ba%e5%88%b6%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>再来看第一个问题</p>
<p>scanner.go最后这里动态调用机制的实现，包括线程锁，信号量啥的，看看怎么实现的</p>
<p>下面的ch和wg早已定义</p>
<pre tabindex="0"><code>var ch = make(chan struct{}, common.Threads)
var wg = sync.WaitGroup{}</code></pre><p><strong>动态调用机制</strong>：</p>
<ul>
<li>使用 <code>reflect</code> 包动态调用函数。</li>
<li>代码中的 <code>ScanFunc</code> 函数演示了如何通过反射动态调用不同的扫描插件。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">ScanFunc</span>(<span style="color:#58a1dd">name</span> <span style="color:#ff636f">*</span><span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">defer</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">recover</span>(); <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] %v:%v scan error: %v\n&#34;</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Host</span>, <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Ports</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">f</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#58a1dd">PluginList</span>[<span style="color:#ff636f">*</span><span style="color:#58a1dd">name</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">in</span> <span style="color:#ff636f">:=</span> []<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">Value</span>{<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#58a1dd">info</span>)}
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">f</span>.<span style="color:#58a1dd">Call</span>(<span style="color:#58a1dd">in</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>ScanFunc</code> 函数使用 <code>reflect</code> 包的 <code>ValueOf</code> 方法获取 <code>PluginList</code> 中对应名称的函数。</p>
<p><code>reflect.ValueOf</code> 获取到函数的反射值后，通过 <code>f.Call</code> 动态调用该函数。</p>
<p><code>defer</code> 和 <code>recover</code> 用于捕获并处理运行时错误，防止程序崩溃。</p>
<p><strong>线程锁（Mutex）</strong>：</p>
<ul>
<li><code>sync.Mutex</code> 用于保护对共享资源（如 <code>common.Num</code> 和 <code>common.End</code>）的访问，确保线程安全。</li>
<li>在 <code>AddScan</code> 函数中，<code>Mutex.Lock()</code> 和 <code>Mutex.Unlock()</code> 确保在对这些共享资源进行读写操作时不会发生竞争条件。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">var</span> <span style="color:#58a1dd">Mutex</span> = <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">Mutex</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">scantype</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>, <span style="color:#58a1dd">ch</span> <span style="color:#ff636f">*</span><span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#58a1dd">wg</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">*</span><span style="color:#58a1dd">ch</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Lock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Num</span> <span style="color:#ff636f">+=</span> <span style="color:#a6be9d">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">ScanFunc</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">scantype</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">info</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Lock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">End</span> <span style="color:#ff636f">+=</span> <span style="color:#a6be9d">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Mutex</span>.<span style="color:#58a1dd">Unlock</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">&lt;-*</span><span style="color:#58a1dd">ch</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>Mutex</code> 是一个全局的互斥锁，用于保护对共享资源的访问。</p>
<p>在 <code>AddScan</code> 中，<code>Mutex.Lock()</code> 和 <code>Mutex.Unlock()</code> 确保对 <code>common.Num</code> 和 <code>common.End</code> 的增减操作是线程安全的。</p>
<p><strong>信号量（Channel）</strong>：</p>
<ul>
<li><code>ch</code> 通道用于限制并发执行的扫描任务的数量。</li>
<li>每当启动一个新的扫描任务时，<code>AddScan</code> 函数会向 <code>ch</code> 发送一个空结构体，表示有一个新的任务在进行中。</li>
<li>扫描任务完成后，会从 <code>ch</code> 中接收一个值，表示一个任务已经完成。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">AddScan</span>(<span style="color:#58a1dd">scantype</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>, <span style="color:#58a1dd">ch</span> <span style="color:#ff636f">*</span><span style="color:#ff636f">chan</span> <span style="color:#ff636f">struct</span>{}, <span style="color:#58a1dd">wg</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">*</span><span style="color:#58a1dd">ch</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#828b96;font-style:italic">// 执行扫描任务
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>        <span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">&lt;-*</span><span style="color:#58a1dd">ch</span>
</span></span><span style="display:flex;"><span>    }()
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>ch</code> 是一个通道，用于控制并发任务的数量。每个任务启动时，都会向 <code>ch</code> 发送一个信号，表示有一个新的任务在进行中。</p>
<p>当任务完成时，会从 <code>ch</code> 中接收一个信号，表示任务已经完成。</p>
<p>这可以用于限制同时运行的任务数量，避免系统过载。</p>
<h3 id="web扫描" class="heading-element"><span>web扫描</span>
  <a href="#web%e6%89%ab%e6%8f%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>再来看第二个问题</p>
<p>重点看一下对web的扫描，debug一下看看流程，看看怎么去匹配指纹（icohash咋算），怎么解析、调用poc，怎么抓取和分析web</p>
<p>调用的条件有三个：</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061016927.webp" alt="image-20240806101644699" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061016927.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061016927.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061016927.webp?size=large 2x" data-title="image-20240806101644699" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>调用ScanFunc</p>
<p>这里10003对应的：</p>
<pre tabindex="0"><code>&#34;web&#34;:         1000003,
&#34;webonly&#34;:     1000003,
&#34;webpoc&#34;:      1000003,</code></pre><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061026091.webp" alt="image-20240806102606926" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061026091.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061026091.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061026091.webp?size=large 2x" data-title="image-20240806102606926" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>但是这个call一直调试不进去</p>
<pre tabindex="0"><code>f := reflect.ValueOf(PluginList[*name])
	in := []reflect.Value{reflect.ValueOf(info)}
	f.Call(in)</code></pre><p>不太懂go的反射，这是一个简单的demo</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">Hello</span>(<span style="color:#58a1dd">name</span> <span style="color:#ff636f">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;Hello,&#34;</span>, <span style="color:#58a1dd">name</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">f</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#58a1dd">Hello</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">params</span> <span style="color:#ff636f">:=</span> []<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">Value</span>{<span style="color:#58a1dd">reflect</span>.<span style="color:#58a1dd">ValueOf</span>(<span style="color:#a6be9d">&#34;World&#34;</span>)}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">f</span>.<span style="color:#58a1dd">Call</span>(<span style="color:#58a1dd">params</span>) <span style="color:#828b96;font-style:italic">// 调用 Hello(&#34;World&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>}</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061044430.webp" alt="image-20240806104412216" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061044430.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061044430.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061044430.webp?size=large 2x" data-title="image-20240806104412216" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里又补习了go导包的一个知识</p>
<p>我新定义了一个hello包，他放在根目录貌似不行，根目录的go文件都是Main包的，需要新建一个目录</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061059874.webp" alt="image-20240806105928710" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061059874.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061059874.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061059874.webp?size=large 2x" data-title="image-20240806105928710" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>go.mod是这样的</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061100331.webp" alt="image-20240806110044145" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061100331.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061100331.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061100331.webp?size=large 2x" data-title="image-20240806110044145" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>导包是这样的</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061101985.webp" alt="image-20240806110115804" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061101985.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061101985.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061101985.webp?size=large 2x" data-title="image-20240806110115804" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>我这里写的demo也是调不进去，可能是因为我的go版本有点老？但是应该可以根据调用的模块名和函数名去打断点吧</p>
<p>打了一些断点，执行顺序大概是这几个文件</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061106058.webp" alt="image-20240806110652918" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061106058.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061106058.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061106058.webp?size=large 2x" data-title="image-20240806110652918" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>来看下执行的流程</p>
<p>我用vulhub本地搭了一个tp5的漏洞，看看他是怎么执行，怎么调yaml的</p>
<p>先跑一下</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061431966.webp" alt="image-20240806143150797" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061431966.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061431966.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061431966.webp?size=large 2x" data-title="image-20240806143150797" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>然后来debug</p>
<p>配置如下</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061437171.webp" alt="image-20240806143721954" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061437171.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061437171.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061437171.webp?size=large 2x" data-title="image-20240806143721954" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里不知道它动态调用怎么调的，调试不进去，就姑且一切从这个webtitle函数开始看</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061434215.webp" alt="image-20240806143416067" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061434215.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061434215.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061434215.webp?size=large 2x" data-title="image-20240806143416067" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里没有指定m参数，Scantype默认是all，进入WebTitle函数</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061436505.webp" alt="image-20240806143602360" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061436505.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061436505.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061436505.webp?size=large 2x" data-title="image-20240806143602360" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>规范数据</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061438258.webp" alt="image-20240806143833069" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061438258.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061438258.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061438258.webp?size=large 2x" data-title="image-20240806143833069" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>进入geturl函数，这里flag默认为1</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061440225.webp" alt="image-20240806144020098" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061440225.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061440225.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061440225.webp?size=large 2x" data-title="image-20240806144020098" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>进入函数以后看注释有对flag的解释</p>
<pre tabindex="0"><code>//flag 1 first try
//flag 2 /favicon.ico
//flag 3 302
//flag 4 400 -&gt; https</code></pre><p>这里我们是第一次请求，这一块应该就是go进行http请求的方式，设置好req发出去，他这里都是写死的了</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#58a1dd">req</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">NewRequest</span>(<span style="color:#a6be9d">&#34;GET&#34;</span>, <span style="color:#58a1dd">Url</span>, <span style="color:#ff636f">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">err</span>, <span style="color:#a6be9d">&#34;&#34;</span>, <span style="color:#58a1dd">CheckData</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;User-agent&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">UserAgent</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Accept&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Accept</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Accept-Language&#34;</span>, <span style="color:#a6be9d">&#34;zh-CN,zh;q=0.9&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Cookie</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Cookie&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Cookie</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//if common.Pocinfo.Cookie != &#34;&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#828b96;font-style:italic">//	req.Header.Set(&#34;Cookie&#34;, &#34;rememberMe=1;&#34;+common.Pocinfo.Cookie)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#828b96;font-style:italic">//} else {
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#828b96;font-style:italic">//	req.Header.Set(&#34;Cookie&#34;, &#34;rememberMe=1&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#828b96;font-style:italic">//}
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Connection&#34;</span>, <span style="color:#a6be9d">&#34;close&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">client</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">flag</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">1</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">client</span> = <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">ClientNoRedirect</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">client</span> = <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">Client</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">resp</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">client</span>.<span style="color:#58a1dd">Do</span>(<span style="color:#58a1dd">req</span>)</span></span></code></pre></div><p>后面对接收到的响应包进行处理，进入getRespBody函数</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061445166.webp" alt="image-20240806144543026" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061445166.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061445166.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061445166.webp?size=large 2x" data-title="image-20240806144543026" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">getRespBody</span>(<span style="color:#58a1dd">oResp</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">Response</span>) ([]<span style="color:#ff636f">byte</span>, <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">body</span> []<span style="color:#ff636f">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">oResp</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Get</span>(<span style="color:#a6be9d">&#34;Content-Encoding&#34;</span>) <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;gzip&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">gr</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">gzip</span>.<span style="color:#58a1dd">NewReader</span>(<span style="color:#58a1dd">oResp</span>.<span style="color:#58a1dd">Body</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">gr</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">buf</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>([]<span style="color:#ff636f">byte</span>, <span style="color:#a6be9d">1024</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">n</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">gr</span>.<span style="color:#58a1dd">Read</span>(<span style="color:#58a1dd">buf</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> <span style="color:#ff636f">&amp;&amp;</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">EOF</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">n</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">body</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">body</span>, <span style="color:#58a1dd">buf</span><span style="color:#ff636f">...</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">raw</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">io</span>.<span style="color:#58a1dd">ReadAll</span>(<span style="color:#58a1dd">oResp</span>.<span style="color:#58a1dd">Body</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">body</span> = <span style="color:#58a1dd">raw</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">body</span>, <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>读取 HTTP 响应体，并处理可能的 <code>gzip</code> 压缩，没有压缩就直接返回</p>
<p>body如下</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061449645.webp" alt="image-20240806144917432" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061449645.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061449645.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061449645.webp?size=large 2x" data-title="image-20240806144917432" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>把body塞进checkdata</p>
<p>flag!=2，第一次请求，先检查编码保证解析，gettitle提取标题，读取 <code>Content-Length</code> 字段拿到长度</p>
<p><code>resp.Location()</code> 获取响应中的重定向 URL（如果存在）。如果获取成功（<code>err1</code> 为 <code>nil</code>），将重定向 URL 转换为字符串并赋值给 <code>reurl</code>。</p>
<p>使用 <code>fmt.Sprintf</code> 格式化一个结果字符串，包含网页 URL、HTTP 状态码、内容长度和网页标题。如果 <code>reurl</code> 不为空（表示存在重定向 URL），将其添加到结果字符串中。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061452315.webp" alt="image-20240806145229128" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061452315.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061452315.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061452315.webp?size=large 2x" data-title="image-20240806145229128" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>最后如果有跳转的话就返回跳转的url，没有就返回空，此外返回checkdata</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061457080.webp" alt="image-20240806145730918" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061457080.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061457080.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061457080.webp?size=large 2x" data-title="image-20240806145730918" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>然后我们就又回到了GOWebTitle这个函数，可见这个函数并不只是拿title</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061458380.webp" alt="image-20240806145824174" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061458380.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061458380.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061458380.webp?size=large 2x" data-title="image-20240806145824174" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>有跳转的话就再次进入我们刚出来的geturl方法，flag为3，这里访问图标（flag为2）被注释了，我们在调回去看一眼</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//有跳转
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">result</span>, <span style="color:#a6be9d">&#34;://&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span> = <span style="color:#58a1dd">result</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">err</span>, <span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">CheckData</span> = <span style="color:#58a1dd">geturl</span>(<span style="color:#58a1dd">info</span>, <span style="color:#a6be9d">3</span>, <span style="color:#58a1dd">CheckData</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">result</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;https&#34;</span> <span style="color:#ff636f">&amp;&amp;</span> !<span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">HasPrefix</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span>, <span style="color:#a6be9d">&#34;https://&#34;</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Replace</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span>, <span style="color:#a6be9d">&#34;http://&#34;</span>, <span style="color:#a6be9d">&#34;https://&#34;</span>, <span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">err</span>, <span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">CheckData</span> = <span style="color:#58a1dd">geturl</span>(<span style="color:#58a1dd">info</span>, <span style="color:#a6be9d">1</span>, <span style="color:#58a1dd">CheckData</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">//有跳转
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">result</span>, <span style="color:#a6be9d">&#34;://&#34;</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span> = <span style="color:#58a1dd">result</span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">err</span>, <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">CheckData</span> = <span style="color:#58a1dd">geturl</span>(<span style="color:#58a1dd">info</span>, <span style="color:#a6be9d">3</span>, <span style="color:#58a1dd">CheckData</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//是否访问图标
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#828b96;font-style:italic">//err, _, CheckData = geturl(info, 2, CheckData)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>代码就一小段，计算ico hash不在这里？</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">flag</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">2</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">URL</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">url</span>.<span style="color:#58a1dd">Parse</span>(<span style="color:#58a1dd">Url</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Url</span> = <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%s://%s/favicon.ico&#34;</span>, <span style="color:#58a1dd">URL</span>.<span style="color:#58a1dd">Scheme</span>, <span style="color:#58a1dd">URL</span>.<span style="color:#58a1dd">Host</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Url</span> <span style="color:#ff636f">+=</span> <span style="color:#a6be9d">&#34;/favicon.ico&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>至此我们又回到刚一开始的函数</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061507415.webp" alt="image-20240806150715253" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061507415.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061507415.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061507415.webp?size=large 2x" data-title="image-20240806150715253" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>进入WebScan.InfoCheck</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061509114.webp" alt="image-20240806150926926" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061509114.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061509114.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061509114.webp?size=large 2x" data-title="image-20240806150926926" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>进行指纹匹配</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">data</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">CheckData</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">rule</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">RuleDatas</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">if</span> <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Type</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;code&#34;</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#58a1dd">matched</span>, <span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">regexp</span>.<span style="color:#58a1dd">MatchString</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Rule</span>, <span style="color:#58a1dd">string</span>(<span style="color:#58a1dd">data</span>.<span style="color:#58a1dd">Body</span>))
</span></span><span style="display:flex;"><span>      } <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#58a1dd">matched</span>, <span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">regexp</span>.<span style="color:#58a1dd">MatchString</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Rule</span>, <span style="color:#58a1dd">data</span>.<span style="color:#58a1dd">Headers</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ff636f">if</span> <span style="color:#58a1dd">matched</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">true</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#58a1dd">infoname</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">infoname</span>, <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Name</span>)
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>   <span style="color:#828b96;font-style:italic">//flag, name := CalcMd5(data.Body)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span>   <span style="color:#828b96;font-style:italic">//if flag == true {
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>   <span style="color:#828b96;font-style:italic">// infoname = append(infoname, name)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>   <span style="color:#828b96;font-style:italic">//}
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>}</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061511828.webp" alt="image-20240806151109597" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061511828.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061511828.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061511828.webp?size=large 2x" data-title="image-20240806151109597" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>不过感觉他这里有点迷，tp都认不出来，不过又回去看了下靶机确实是啥也没有，不过我这里改了下他就认识了</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061521092.webp" alt="image-20240806152137853" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061521092.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061521092.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061521092.webp?size=large 2x" data-title="image-20240806152137853" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>试了下命中的是这一条规则，这里我的body里有ThinkPHP</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>{<span style="color:#a6be9d">&#34;ThinkPHP&#34;</span>, <span style="color:#a6be9d">&#34;headers&#34;</span>, <span style="color:#a6be9d">&#34;(ThinkPHP)&#34;</span>},</span></span></code></pre></div><p>我自己加了条规则改了下代码就能匹配上了，看了下fscan匹配body的指纹才三条，不知道是不是bug，感觉我这么改才是符合逻辑的</p>
<pre tabindex="0"><code>{&#34;ThinkPHPtest&#34;, &#34;body&#34;, &#34;(ThinkPHP)&#34;},</code></pre><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061534948.webp" alt="image-20240806153423726" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061534948.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061534948.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061534948.webp?size=large 2x" data-title="image-20240806153423726" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>接下来进入removeDuplicateElement函数去重一下指纹名称</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">removeDuplicateElement</span>(<span style="color:#58a1dd">languages</span> []<span style="color:#ff636f">string</span>) []<span style="color:#ff636f">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">result</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>([]<span style="color:#ff636f">string</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">languages</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">temp</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">map</span>[<span style="color:#ff636f">string</span>]<span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">item</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">languages</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">temp</span>[<span style="color:#58a1dd">item</span>]; !<span style="color:#58a1dd">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">temp</span>[<span style="color:#58a1dd">item</span>] = <span style="color:#ff636f">struct</span>{}{}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">result</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">result</span>, <span style="color:#58a1dd">item</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">result</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>至此又回到WebTitle函数，我们没有指定NoPoc，所以在进入Poc扫描，也就是WebScan.WebScan函数</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061550735.webp" alt="image-20240806155030547" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061550735.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061550735.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061550735.webp?size=large 2x" data-title="image-20240806155030547" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>传入的Info如下</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061553732.webp" alt="image-20240806155306563" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061553732.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061553732.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061553732.webp?size=large 2x" data-title="image-20240806155306563" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>先初始化poc，然后对数据进行处理，后面for循环读取之前拿到的指纹，给pocinfo.PocName赋值，执行Execute(pocinfo)，我们一个个来看</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">WebScan</span>(<span style="color:#58a1dd">info</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">HostInfo</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">once</span>.<span style="color:#58a1dd">Do</span>(<span style="color:#58a1dd">initpoc</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">pocinfo</span> = <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Pocinfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">buf</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Split</span>(<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Url</span>, <span style="color:#a6be9d">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">pocinfo</span>.<span style="color:#58a1dd">Target</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Join</span>(<span style="color:#58a1dd">buf</span>[:<span style="color:#a6be9d">3</span>], <span style="color:#a6be9d">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">pocinfo</span>.<span style="color:#58a1dd">PocName</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Execute</span>(<span style="color:#58a1dd">pocinfo</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">infostr</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Infostr</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">pocinfo</span>.<span style="color:#58a1dd">PocName</span> = <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">CheckInfoPoc</span>(<span style="color:#58a1dd">infostr</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Execute</span>(<span style="color:#58a1dd">pocinfo</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><blockquote>
<p><code>once.Do(initpoc)</code> 是 Go 语言中用于实现单次初始化操作的一个常见模式。这是通过 <code>sync.Once</code> 类型来实现的。<code>sync.Once</code> 确保某个操作在整个程序运行期间只执行一次，即使有多个 goroutine 试图执行这个操作。</p>
</blockquote>
<p>先来看看是怎么初始化poc的</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">initpoc</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PocPath</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">entries</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">Pocs</span>.<span style="color:#58a1dd">ReadDir</span>(<span style="color:#a6be9d">&#34;pocs&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] init poc error: %v&#34;</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">one</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">entries</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">path</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">one</span>.<span style="color:#58a1dd">Name</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">HasSuffix</span>(<span style="color:#58a1dd">path</span>, <span style="color:#a6be9d">&#34;.yaml&#34;</span>) <span style="color:#ff636f">||</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">HasSuffix</span>(<span style="color:#58a1dd">path</span>, <span style="color:#a6be9d">&#34;.yml&#34;</span>) {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> <span style="color:#58a1dd">poc</span>, <span style="color:#58a1dd">_</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">LoadPoc</span>(<span style="color:#58a1dd">path</span>, <span style="color:#58a1dd">Pocs</span>); <span style="color:#58a1dd">poc</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">AllPocs</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AllPocs</span>, <span style="color:#58a1dd">poc</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;[+] load poc from &#34;</span> <span style="color:#ff636f">+</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PocPath</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">filepath</span>.<span style="color:#58a1dd">Walk</span>(<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PocPath</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">func</span>(<span style="color:#58a1dd">path</span> <span style="color:#ff636f">string</span>, <span style="color:#58a1dd">info</span> <span style="color:#58a1dd">os</span>.<span style="color:#58a1dd">FileInfo</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">error</span>) <span style="color:#ff636f">error</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> <span style="color:#ff636f">||</span> <span style="color:#58a1dd">info</span> <span style="color:#ff636f">==</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#ff636f">return</span> <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> !<span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">IsDir</span>() {
</span></span><span style="display:flex;"><span>					<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">HasSuffix</span>(<span style="color:#58a1dd">path</span>, <span style="color:#a6be9d">&#34;.yaml&#34;</span>) <span style="color:#ff636f">||</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">HasSuffix</span>(<span style="color:#58a1dd">path</span>, <span style="color:#a6be9d">&#34;.yml&#34;</span>) {
</span></span><span style="display:flex;"><span>						<span style="color:#58a1dd">poc</span>, <span style="color:#58a1dd">_</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">LoadPocbyPath</span>(<span style="color:#58a1dd">path</span>)
</span></span><span style="display:flex;"><span>						<span style="color:#ff636f">if</span> <span style="color:#58a1dd">poc</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>							<span style="color:#58a1dd">AllPocs</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">AllPocs</span>, <span style="color:#58a1dd">poc</span>)
</span></span><span style="display:flex;"><span>						}
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>			})
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] init poc error: %v&#34;</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>首先if判断，没指定poc就用默认的那个poc文件夹的</p>
<p>Pocs.ReadDir这应该也是go的一个解析yaml的库，先读进内存</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061604512.webp" alt="image-20240806160447208" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061604512.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061604512.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061604512.webp?size=large 2x" data-title="image-20240806160447208" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>看一下lib.LoadPoc</p>
<p>加载一个 POC 文件，并将其解析成 <code>Poc</code> 结构体，返回p，err</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061608165.webp" alt="image-20240806160824970" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061608165.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061608165.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061608165.webp?size=large 2x" data-title="image-20240806160824970" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>解析出来就是这样的</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061610542.webp" alt="image-20240806161035334" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061610542.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061610542.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061610542.webp?size=large 2x" data-title="image-20240806161035334" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>把他们放进AllPocs</p>
<p>这里如果是指定了自定义的poc就直接执行，否则就进入下面的for循环一个个匹配</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">if</span> <span style="color:#58a1dd">pocinfo</span>.<span style="color:#58a1dd">PocName</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Execute</span>(<span style="color:#58a1dd">pocinfo</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">infostr</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">Infostr</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">pocinfo</span>.<span style="color:#58a1dd">PocName</span> = <span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">CheckInfoPoc</span>(<span style="color:#58a1dd">infostr</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Execute</span>(<span style="color:#58a1dd">pocinfo</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}</span></span></code></pre></div><p>来看一下CheckInfoPoc，它传入的是匹配到的指纹的名字</p>
<p>strings.Contains是检查后面的在不在前面的字符串里，所以我新加的thinkphptest被匹配到了</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">CheckInfoPoc</span>(<span style="color:#58a1dd">infostr</span> <span style="color:#ff636f">string</span>) <span style="color:#ff636f">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">poc</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">info</span>.<span style="color:#58a1dd">PocDatas</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">infostr</span>, <span style="color:#58a1dd">poc</span>.<span style="color:#58a1dd">Name</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#58a1dd">poc</span>.<span style="color:#58a1dd">Alias</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061619251.webp" alt="image-20240806161940055" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061619251.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061619251.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061619251.webp?size=large 2x" data-title="image-20240806161940055" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>接下来Execute(pocinfo)</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">Execute</span>(<span style="color:#58a1dd">PocInfo</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PocInfo</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">NewRequest</span>(<span style="color:#a6be9d">&#34;GET&#34;</span>, <span style="color:#58a1dd">PocInfo</span>.<span style="color:#58a1dd">Target</span>, <span style="color:#ff636f">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">errlog</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;[-] webpocinit %v %v&#34;</span>, <span style="color:#58a1dd">PocInfo</span>.<span style="color:#58a1dd">Target</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogError</span>(<span style="color:#58a1dd">errlog</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;User-agent&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">UserAgent</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Accept&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Accept</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Accept-Language&#34;</span>, <span style="color:#a6be9d">&#34;zh-CN,zh;q=0.9&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Cookie</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#a6be9d">&#34;Cookie&#34;</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">Cookie</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">pocs</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">filterPoc</span>(<span style="color:#58a1dd">PocInfo</span>.<span style="color:#58a1dd">PocName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">CheckMultiPoc</span>(<span style="color:#58a1dd">req</span>, <span style="color:#58a1dd">pocs</span>, <span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">PocNum</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><code>common.PocInfo</code> 是一个结构体，包以目标 URL和POC 名称</p>
<p>常规的创建req，设置请求头，然后 filterPoc和CheckMultiPoc</p>
<p>先来看前者</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">filterPoc</span>(<span style="color:#58a1dd">pocname</span> <span style="color:#ff636f">string</span>) (<span style="color:#58a1dd">pocs</span> []<span style="color:#ff636f">*</span><span style="color:#58a1dd">lib</span>.<span style="color:#58a1dd">Poc</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">pocname</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">AllPocs</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">poc</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">AllPocs</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">poc</span>.<span style="color:#58a1dd">Name</span>, <span style="color:#58a1dd">pocname</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">pocs</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">pocs</span>, <span style="color:#58a1dd">poc</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>其实就是查找包含了这个名称的poc返回一个列表</p>
<p>再来看后者</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">CheckMultiPoc</span>(<span style="color:#58a1dd">req</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">Request</span>, <span style="color:#58a1dd">pocs</span> []<span style="color:#ff636f">*</span><span style="color:#58a1dd">Poc</span>, <span style="color:#58a1dd">workers</span> <span style="color:#ff636f">int</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">tasks</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">chan</span> <span style="color:#58a1dd">Task</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">wg</span> <span style="color:#58a1dd">sync</span>.<span style="color:#58a1dd">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">i</span> <span style="color:#ff636f">:=</span> <span style="color:#a6be9d">0</span>; <span style="color:#58a1dd">i</span> &lt; <span style="color:#58a1dd">workers</span>; <span style="color:#58a1dd">i</span><span style="color:#ff636f">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">go</span> <span style="color:#ff636f">func</span>() {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">for</span> <span style="color:#58a1dd">task</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">tasks</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">isVul</span>, <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">name</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">executePoc</span>(<span style="color:#58a1dd">task</span>.<span style="color:#58a1dd">Req</span>, <span style="color:#58a1dd">task</span>.<span style="color:#58a1dd">Poc</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> <span style="color:#58a1dd">isVul</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">result</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;[+] PocScan %s %s %s&#34;</span>, <span style="color:#58a1dd">task</span>.<span style="color:#58a1dd">Req</span>.<span style="color:#58a1dd">URL</span>, <span style="color:#58a1dd">task</span>.<span style="color:#58a1dd">Poc</span>.<span style="color:#58a1dd">Name</span>, <span style="color:#58a1dd">name</span>)
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">LogSuccess</span>(<span style="color:#58a1dd">result</span>)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Done</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">poc</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">pocs</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">task</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">Task</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Req</span>: <span style="color:#58a1dd">req</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">Poc</span>: <span style="color:#58a1dd">poc</span>,
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Add</span>(<span style="color:#a6be9d">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">tasks</span> <span style="color:#ff636f">&lt;-</span> <span style="color:#58a1dd">task</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">wg</span>.<span style="color:#58a1dd">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">close</span>(<span style="color:#58a1dd">tasks</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>主要还是俩部分，一个是创建一堆worker线程等着执行poc（从通道tasks里读取），一个是循环给通道传入poc，传一个就add(1)，而执行poc的那边结束一个就执行一个done</p>
<p>最后结束</p>
<p>那么这里还剩我们要看的应该是最后一个函数executePoc</p>
<p>真的是老长了，其实无非就是根据poc里面写好的东西去发包而已</p>
<p>不过感觉这块函数对一个扫描器来说是非常核心的，这块函数的功能决定poc可以怎么写，有多灵活的功能等，如果自己开发扫描器这里是一个很重点的地方</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">executePoc</span>(<span style="color:#58a1dd">oReq</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">Request</span>, <span style="color:#58a1dd">p</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">Poc</span>) (<span style="color:#ff636f">bool</span>, <span style="color:#ff636f">error</span>, <span style="color:#ff636f">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">c</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">NewEnvOption</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">c</span>.<span style="color:#58a1dd">UpdateCompileOptions</span>(<span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Set</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Sets</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">var</span> <span style="color:#58a1dd">setMap</span> <span style="color:#58a1dd">StrMap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">item</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Sets</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Value</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">setMap</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">setMap</span>, <span style="color:#58a1dd">StrItem</span>{<span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Key</span>, <span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Value</span>[<span style="color:#a6be9d">0</span>]})
</span></span><span style="display:flex;"><span>			} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">setMap</span> = <span style="color:#58a1dd">append</span>(<span style="color:#58a1dd">setMap</span>, <span style="color:#58a1dd">StrItem</span>{<span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Key</span>, <span style="color:#a6be9d">&#34;&#34;</span>})
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">c</span>.<span style="color:#58a1dd">UpdateCompileOptions</span>(<span style="color:#58a1dd">setMap</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">env</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">NewEnv</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">c</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] %s environment creation error: %s\n&#34;</span>, <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Name</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#58a1dd">err</span>, <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">req</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">ParseRequest</span>(<span style="color:#58a1dd">oReq</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] %s ParseRequest error: %s\n&#34;</span>, <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Name</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#58a1dd">err</span>, <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">variableMap</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">make</span>(<span style="color:#ff636f">map</span>[<span style="color:#ff636f">string</span>]<span style="color:#ff636f">interface</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">defer</span> <span style="color:#ff636f">func</span>() { <span style="color:#58a1dd">variableMap</span> = <span style="color:#ff636f">nil</span> }()
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">variableMap</span>[<span style="color:#a6be9d">&#34;request&#34;</span>] = <span style="color:#58a1dd">req</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">item</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Set</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">k</span>, <span style="color:#58a1dd">expression</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Key</span>, <span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Value</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">expression</span> <span style="color:#ff636f">==</span> <span style="color:#a6be9d">&#34;newReverse()&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> !<span style="color:#58a1dd">common</span>.<span style="color:#58a1dd">DnsLog</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#ff636f">nil</span>, <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">variableMap</span>[<span style="color:#58a1dd">k</span>] = <span style="color:#58a1dd">newReverse</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">err</span>, <span style="color:#58a1dd">_</span> = <span style="color:#58a1dd">evalset</span>(<span style="color:#58a1dd">env</span>, <span style="color:#58a1dd">variableMap</span>, <span style="color:#58a1dd">k</span>, <span style="color:#58a1dd">expression</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Printf</span>(<span style="color:#a6be9d">&#34;[-] %s evalset error: %v\n&#34;</span>, <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Name</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">success</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#828b96;font-style:italic">//爆破模式,比如tomcat弱口令
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Sets</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">success</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">clusterpoc</span>(<span style="color:#58a1dd">oReq</span>, <span style="color:#58a1dd">p</span>, <span style="color:#58a1dd">variableMap</span>, <span style="color:#58a1dd">req</span>, <span style="color:#58a1dd">env</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">success</span>, <span style="color:#ff636f">nil</span>, <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">DealWithRule</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">func</span>(<span style="color:#58a1dd">rule</span> <span style="color:#58a1dd">Rules</span>) (<span style="color:#ff636f">bool</span>, <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Headers</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">cloneMap</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Headers</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">var</span> (
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">flag</span>, <span style="color:#58a1dd">ok</span> <span style="color:#ff636f">bool</span>
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">k1</span>, <span style="color:#58a1dd">v1</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">variableMap</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">isMap</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">v1</span>.(<span style="color:#ff636f">map</span>[<span style="color:#ff636f">string</span>]<span style="color:#ff636f">string</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">isMap</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">value</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%v&#34;</span>, <span style="color:#58a1dd">v1</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">for</span> <span style="color:#58a1dd">k2</span>, <span style="color:#58a1dd">v2</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">Headers</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">if</span> !<span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">Contains</span>(<span style="color:#58a1dd">v2</span>, <span style="color:#a6be9d">&#34;{{&#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">k1</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34;}}&#34;</span>) {
</span></span><span style="display:flex;"><span>					<span style="color:#ff636f">continue</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#58a1dd">Headers</span>[<span style="color:#58a1dd">k2</span>] = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">ReplaceAll</span>(<span style="color:#58a1dd">v2</span>, <span style="color:#a6be9d">&#34;{{&#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">k1</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34;}}&#34;</span>, <span style="color:#58a1dd">value</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Path</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">ReplaceAll</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Path</span>, <span style="color:#a6be9d">&#34;{{&#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">k1</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34;}}&#34;</span>, <span style="color:#58a1dd">value</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Body</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">ReplaceAll</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Body</span>, <span style="color:#a6be9d">&#34;{{&#34;</span><span style="color:#ff636f">+</span><span style="color:#58a1dd">k1</span><span style="color:#ff636f">+</span><span style="color:#a6be9d">&#34;}}&#34;</span>, <span style="color:#58a1dd">value</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">oReq</span>.<span style="color:#58a1dd">URL</span>.<span style="color:#58a1dd">Path</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> <span style="color:#ff636f">&amp;&amp;</span> <span style="color:#58a1dd">oReq</span>.<span style="color:#58a1dd">URL</span>.<span style="color:#58a1dd">Path</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;/&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Path</span> = <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprint</span>(<span style="color:#58a1dd">oReq</span>.<span style="color:#58a1dd">URL</span>.<span style="color:#58a1dd">Path</span>, <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Path</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Path</span> = <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Path</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">// 某些poc没有区分path和query，需要处理
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Path</span> = <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">ReplaceAll</span>(<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Path</span>, <span style="color:#a6be9d">&#34; &#34;</span>, <span style="color:#a6be9d">&#34;%20&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">//req.Url.Path = strings.ReplaceAll(req.Url.Path, &#34;+&#34;, &#34;%20&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">newRequest</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">http</span>.<span style="color:#58a1dd">NewRequest</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Method</span>, <span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Sprintf</span>(<span style="color:#a6be9d">&#34;%s://%s%s&#34;</span>, <span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Scheme</span>, <span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Host</span>, <span style="color:#58a1dd">string</span>([]<span style="color:#58a1dd">rune</span>(<span style="color:#58a1dd">req</span>.<span style="color:#58a1dd">Url</span>.<span style="color:#58a1dd">Path</span>))), <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">NewReader</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Body</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#828b96;font-style:italic">//fmt.Println(&#34;[-] newRequest error: &#34;,err)
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">newRequest</span>.<span style="color:#58a1dd">Header</span> = <span style="color:#58a1dd">oReq</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Clone</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">k</span>, <span style="color:#58a1dd">v</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">Headers</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">newRequest</span>.<span style="color:#58a1dd">Header</span>.<span style="color:#58a1dd">Set</span>(<span style="color:#58a1dd">k</span>, <span style="color:#58a1dd">v</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Headers</span> = <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">resp</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">DoRequest</span>(<span style="color:#58a1dd">newRequest</span>, <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">FollowRedirects</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">newRequest</span> = <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">variableMap</span>[<span style="color:#a6be9d">&#34;response&#34;</span>] = <span style="color:#58a1dd">resp</span>
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">// 先判断响应页面是否匹配search规则
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Search</span> <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">result</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">doSearch</span>(<span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Search</span>, <span style="color:#58a1dd">GetHeader</span>(<span style="color:#58a1dd">resp</span>.<span style="color:#58a1dd">Headers</span>)<span style="color:#ff636f">+</span><span style="color:#58a1dd">string</span>(<span style="color:#58a1dd">resp</span>.<span style="color:#58a1dd">Body</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">result</span>) &gt; <span style="color:#a6be9d">0</span> { <span style="color:#828b96;font-style:italic">// 正则匹配成功
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#ff636f">for</span> <span style="color:#58a1dd">k</span>, <span style="color:#58a1dd">v</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">result</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#58a1dd">variableMap</span>[<span style="color:#58a1dd">k</span>] = <span style="color:#58a1dd">v</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">out</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">Evaluate</span>(<span style="color:#58a1dd">env</span>, <span style="color:#58a1dd">rule</span>.<span style="color:#58a1dd">Expression</span>, <span style="color:#58a1dd">variableMap</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">return</span> <span style="color:#ff636f">false</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#828b96;font-style:italic">//如果false不继续执行后续rule
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#828b96;font-style:italic">// 如果最后一步执行失败，就算前面成功了最终依旧是失败
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">flag</span>, <span style="color:#58a1dd">ok</span> = <span style="color:#58a1dd">out</span>.<span style="color:#58a1dd">Value</span>().(<span style="color:#ff636f">bool</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">if</span> !<span style="color:#58a1dd">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">flag</span> = <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">flag</span>, <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">DealWithRules</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">func</span>(<span style="color:#58a1dd">rules</span> []<span style="color:#58a1dd">Rules</span>) <span style="color:#ff636f">bool</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">successFlag</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">rule</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">rules</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">flag</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">DealWithRule</span>(<span style="color:#58a1dd">rule</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> <span style="color:#ff636f">||</span> !<span style="color:#58a1dd">flag</span> { <span style="color:#828b96;font-style:italic">//如果false不继续执行后续rule
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#58a1dd">successFlag</span> = <span style="color:#ff636f">false</span> <span style="color:#828b96;font-style:italic">// 如果其中一步为flag，则直接break
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>				<span style="color:#ff636f">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">successFlag</span> = <span style="color:#ff636f">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#58a1dd">successFlag</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">len</span>(<span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Rules</span>) &gt; <span style="color:#a6be9d">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">success</span> = <span style="color:#58a1dd">DealWithRules</span>(<span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Rules</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">for</span> <span style="color:#58a1dd">_</span>, <span style="color:#58a1dd">item</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">range</span> <span style="color:#58a1dd">p</span>.<span style="color:#58a1dd">Groups</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">name</span>, <span style="color:#58a1dd">rules</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Key</span>, <span style="color:#58a1dd">item</span>.<span style="color:#58a1dd">Value</span>
</span></span><span style="display:flex;"><span>			<span style="color:#58a1dd">success</span> = <span style="color:#58a1dd">DealWithRules</span>(<span style="color:#58a1dd">rules</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#ff636f">if</span> <span style="color:#58a1dd">success</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#ff636f">return</span> <span style="color:#58a1dd">success</span>, <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">name</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">success</span>, <span style="color:#ff636f">nil</span>, <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>最后又回到了WebTitle，差不多到这里对web的扫描就结束了</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061634042.webp" alt="image-20240806163415850" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061634042.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061634042.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408061634042.webp?size=large 2x" data-title="image-20240806163415850" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="插件实现" class="heading-element"><span>插件实现</span>
  <a href="#%e6%8f%92%e4%bb%b6%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>大致看一下各种插件的实现</p>
<p>wmiexec</p>
<p>**<code>github.com/C-Sto/goWMIExec/pkg/wmiexec</code>**这是第三方包，用于执行 WMI 命令。</p>
<p>核心代码如下</p>
<pre tabindex="0"><code>cfg, err1 := wmiexec.NewExecConfig(username, password, hash, domain, target, clientHostname, true, nil, nil)
execer := wmiexec.NewExecer(cfgIn)
err = execer.RPCConnect()</code></pre><p>然后就是考虑怎么进行判断</p>
<p>暂时不看了</p>
<h3 id="代理实现" class="heading-element"><span>代理实现</span>
  <a href="#%e4%bb%a3%e7%90%86%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>代理怎么实现？</p>
<p>我本地搞了个正向代理，模拟机还是那个tp的洞，debug一下看看代理怎么走的</p>
<p>先跑一下证明没问题</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408070953810.webp" alt="image-20240807095327660" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408070953810.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408070953810.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408070953810.webp?size=large 2x" data-title="image-20240807095327660" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>调试了一下，调用顺序应该是这样的</p>
<p>scanner.go刚开始的时候会进行初始化http，进去看看</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071008130.webp" alt="image-20240807100801991" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071008130.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071008130.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071008130.webp?size=large 2x" data-title="image-20240807100801991" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<blockquote>
<p><code>net.Dialer</code> 是 Go 语言标准库 <code>net</code> 包中的一个结构体，用于创建网络连接。它允许你配置和定制网络连接的各种参数，比如连接超时、保持连接活动等。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">package</span> <span style="color:#58a1dd">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6be9d">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">dialer</span> <span style="color:#ff636f">:=</span> <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Dialer</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">Timeout</span>:   <span style="color:#a6be9d">5</span> <span style="color:#ff636f">*</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>, <span style="color:#828b96;font-style:italic">// 设置连接超时时间为 5 秒
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>		<span style="color:#58a1dd">KeepAlive</span>: <span style="color:#a6be9d">30</span> <span style="color:#ff636f">*</span> <span style="color:#58a1dd">time</span>.<span style="color:#58a1dd">Second</span>, <span style="color:#828b96;font-style:italic">// 设置 Keep-Alive 时间为 30 秒
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">conn</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">dialer</span>.<span style="color:#58a1dd">Dial</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#a6be9d">&#34;example.com:80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;Error:&#34;</span>, <span style="color:#58a1dd">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">defer</span> <span style="color:#58a1dd">conn</span>.<span style="color:#58a1dd">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">fmt</span>.<span style="color:#58a1dd">Println</span>(<span style="color:#a6be9d">&#34;Connected to example.com:80&#34;</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></blockquote>
<p>定位到InitHttpClient函数</p>
<p>可以看到我们传的socks5参数是在这里被解析的</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071010928.webp" alt="image-20240807101016714" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071010928.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071010928.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071010928.webp?size=large 2x" data-title="image-20240807101016714" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>跟进去看一下common.Socks5Dailer函数</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ff636f">func</span> <span style="color:#58a1dd">Socks5Dailer</span>(<span style="color:#58a1dd">forward</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">net</span>.<span style="color:#58a1dd">Dialer</span>) (<span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">Dialer</span>, <span style="color:#ff636f">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">u</span>, <span style="color:#58a1dd">err</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">url</span>.<span style="color:#58a1dd">Parse</span>(<span style="color:#58a1dd">Socks5Proxy</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">strings</span>.<span style="color:#58a1dd">ToLower</span>(<span style="color:#58a1dd">u</span>.<span style="color:#58a1dd">Scheme</span>) <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;socks5&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">errors</span>.<span style="color:#58a1dd">New</span>(<span style="color:#a6be9d">&#34;Only support socks5&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#58a1dd">address</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">u</span>.<span style="color:#58a1dd">Host</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">auth</span> <span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">Auth</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">var</span> <span style="color:#58a1dd">dailer</span> <span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">Dialer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">u</span>.<span style="color:#58a1dd">User</span>.<span style="color:#58a1dd">String</span>() <span style="color:#ff636f">!=</span> <span style="color:#a6be9d">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">auth</span> = <span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">Auth</span>{}
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">auth</span>.<span style="color:#58a1dd">User</span> = <span style="color:#58a1dd">u</span>.<span style="color:#58a1dd">User</span>.<span style="color:#58a1dd">Username</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">password</span>, <span style="color:#58a1dd">_</span> <span style="color:#ff636f">:=</span> <span style="color:#58a1dd">u</span>.<span style="color:#58a1dd">User</span>.<span style="color:#58a1dd">Password</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">auth</span>.<span style="color:#58a1dd">Password</span> = <span style="color:#58a1dd">password</span>
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">dailer</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">SOCKS5</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#58a1dd">address</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">auth</span>, <span style="color:#58a1dd">forward</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#58a1dd">dailer</span>, <span style="color:#58a1dd">err</span> = <span style="color:#58a1dd">proxy</span>.<span style="color:#58a1dd">SOCKS5</span>(<span style="color:#a6be9d">&#34;tcp&#34;</span>, <span style="color:#58a1dd">address</span>, <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">forward</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">if</span> <span style="color:#58a1dd">err</span> <span style="color:#ff636f">!=</span> <span style="color:#ff636f">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff636f">return</span> <span style="color:#ff636f">nil</span>, <span style="color:#58a1dd">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff636f">return</span> <span style="color:#58a1dd">dailer</span>, <span style="color:#ff636f">nil</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>用于创建并返回一个 SOCKS5 代理的拨号器（proxy.Dialer）</p>
<p>代码很简单，最后想执行的无非是这一句<code>dailer, err = proxy.SOCKS5(&quot;tcp&quot;, address, nil, forward)</code></p>
<p>它调用了net包的sokcs5方法，并且fscan只支持socks5，这里也是一个可以优化的点？</p>
<p>这里其实都是提前设置好client（Dialer），然后等发包的时候执行client.do()</p>
<p>其实我不是很了解go网络编程的细节，主要还是对net包的了解，后面都得去了解</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071041210.webp" alt="image-20240807104128058" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071041210.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071041210.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202408071041210.webp?size=large 2x" data-title="image-20240807104128058" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-08-18 12:31:01">Updated on 2024-08-18&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/" class="post-tag" title="Tags - 安全开发">安全开发</a><a href="/tags/%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/" class="post-tag" title="Tags - 开源工具分析">开源工具分析</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/250/" class="post-nav-item" rel="prev" title="Shiro反序列化初探 CC6改TemplatesImpl"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Shiro反序列化初探 CC6改TemplatesImpl</a>
      <a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/" class="post-nav-item" rel="next" title="Shiro反序列化原理调试分析">Shiro反序列化原理调试分析<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
<a href="https://statcounter.com/p13160752/?guest=1" target="_blank">访问量统计</a> 

<script type="text/javascript">
var sc_project=13160752;
var sc_invisible=0;
var sc_security="211d0342";
var scJsHost = "https://";
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost +
"statcounter.com/counter/counter.js'></"+"script>");
</script>

<noscript>
  <div class="statcounter">
    <a title="web stats" href="https://statcounter.com/" target="_blank">
      <img referrerPolicy="no-referrer-when-downgrade">
    </a>
  </div>
</noscript>


    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.1">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">东隅</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":20},"comment":{"enable":false},"typeit":{"cursorChar":"_","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-YMSM8DYT3D', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-YMSM8DYT3D" async></script></body>
</html>
